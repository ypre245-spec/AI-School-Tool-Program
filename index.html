<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital AI Vision for Education | DepEd Aligned</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://ui-avatars.com/api/?name=Digital+AI&background=1e3a8a&color=fff&rounded=true" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        holiday: ['Inter', 'sans-serif'], 
                    },
                    colors: {
                        deped: {
                            blue: '#1e3a8a', 
                            red: '#dc2626',  
                            yellow: '#facc15', 
                            light: '#f8fafc',
                            dark: '#0f172a',
                        },
                        wellness: {
                            dark: '#0f172a',
                            purple: '#312e81',
                            text: '#e2e8f0'
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(30, 58, 138, 0.2)', 
                        'card-hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'breathe': 'breathe 4s ease-in-out infinite',
                        'spin-slow': 'spin 8s linear infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'wiggle': 'wiggle 2s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        breathe: {
                            '0%, 100%': { opacity: '0.6', transform: 'scale(1)' },
                            '50%': { opacity: '1', transform: 'scale(1.05)' },
                        },
                        shake: {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-4px)' },
                            '20%, 40%, 60%, 80%': { transform: 'translateX(4px)' },
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        .glass-nav {
            background: rgba(30, 58, 138, 0.95); /* DepEd Blue */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 3px solid #facc15; 
        }
        
        /* ADDED: Global Protection Styles */
        body {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
            -webkit-touch-callout: none; /* iOS Safari */
        }
        
        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            pointer-events: none; /* Disables right click on images specifically */
        }
        
        /* Allow interaction only with specific interactive elements */
        input, textarea, [contenteditable=true] {
            -webkit-user-select: text !important;
            user-select: text !important;
        }

        .hero-pattern {
            background-color: #f8fafc;
            background-image: radial-gradient(#1e3a8a 0.5px, transparent 0.5px), radial-gradient(#dc2626 0.5px, #f8fafc 0.5px);
            background-size: 24px 24px;
            background-position: 0 0, 12px 12px;
            opacity: 0.1;
        }
        
        .chat-pattern {
            background-color: #f8fafc;
            background-image: radial-gradient(rgba(30, 58, 138, 0.05) 1px, transparent 1px), radial-gradient(rgba(220, 38, 38, 0.05) 1px, #f8fafc 1px);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
        }

        body.wellness-active {
            background-color: #f8fafc; 
            color: #1e293b;
            overflow-x: hidden;
        }
        
        body.wellness-active .productivity-zone {
            display: none !important;
        }
        
        body.wellness-active #maintenance-screen {
            display: flex !important;
            animation: fadeIn 0.5s ease-out;
        }
        
        body.wellness-active .wellness-zone {
            display: flex !important;
            animation: fadeIn 1s ease-in;
        }

        body.wellness-active .glass-nav {
            background: rgba(30, 58, 138, 0.95);
            border-bottom: 3px solid #facc15;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s cubic-bezier(0.5, 0, 0, 1);
        }
        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .hidden-tool {
            display: none !important;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 10px;
            border: 2px solid #f1f5f9;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        .text-glow {
            text-shadow: 0 0 20px rgba(30, 58, 138, 0.2);
        }
        
        .date-badge {
            font-size: 10px;
            color: #64748b; 
            background-color: #e2e8f0; 
            padding: 4px 12px;
            border-radius: 9999px;
            margin: 16px auto 8px auto; 
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            width: fit-content;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        @keyframes zoomIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-zoom-in {
            animation: zoomIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased flex flex-col min-h-screen font-sans selection:bg-deped-blue selection:text-white transition-colors duration-700 select-none oncontextmenu="return false;">

    <!-- Preloader -->
    <div id="initial-loader" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative">
             <i class="fa-solid fa-circle-notch fa-spin text-5xl text-deped-blue/20"></i>
             <div class="absolute inset-0 flex items-center justify-center">
                 <i class="fa-solid fa-robot text-deped-blue text-lg animate-pulse"></i>
             </div>
        </div>
        <p id="loader-text" class="mt-4 text-deped-blue text-sm font-bold tracking-widest uppercase animate-pulse">Loading System Resources...</p>
    </div>

    <!-- Notification Modal -->
    <div id="announcement-modal" class="fixed inset-0 z-[150] bg-slate-900/60 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl max-w-sm w-full shadow-2xl relative transform scale-95 transition-transform duration-300 overflow-hidden ring-1 ring-slate-900/5">
            
            <!-- SaaS Header -->
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-3">
                    <div id="ann-icon-bg" class="w-8 h-8 rounded-lg bg-blue-100 text-deped-blue flex items-center justify-center text-sm shadow-sm ring-1 ring-blue-500/10">
                        <i id="ann-icon" class="fa-solid fa-bell"></i>
                    </div>
                    <div>
                        <h3 id="announcement-title" class="text-sm font-bold text-slate-800 leading-none">Notification</h3>
                        <p id="ann-subtitle" class="text-[10px] text-slate-400 font-medium mt-1 uppercase tracking-wider">System Update</p>
                    </div>
                </div>
                <button id="close-announcement" class="text-slate-400 hover:text-slate-600 transition rounded-md hover:bg-slate-100 p-1">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>

            <!-- SaaS Body -->
            <div class="p-6 bg-white">
                 <div id="announcement-message" class="text-slate-600 text-sm leading-relaxed font-medium"></div>
                 
                 <div class="mt-6 flex items-center justify-between pt-4 border-t border-slate-50">
                    <div class="flex items-center gap-2 text-[10px] text-slate-400 font-mono">
                        <i class="fa-regular fa-clock"></i>
                        <span id="ann-timestamp">Just now</span>
                    </div>
                    <span id="ann-status" class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100">Active</span>
                 </div>
            </div>

            <!-- SaaS Footer -->
            <div class="px-6 py-3 bg-slate-50 border-t border-slate-100 flex justify-end">
                 <button id="ack-announcement" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg transition shadow-sm text-xs border border-slate-700">
                     Dismiss
                 </button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="glass-nav text-white shadow-lg sticky top-0 z-50 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <!-- Logo / Brand -->
                <a href="#" class="flex items-center space-x-3 group">
                    <div class="relative transform group-hover:scale-105 transition duration-300">
                        <img src="https://ui-avatars.com/api/?name=Digital+AI&background=ffffff&color=1e3a8a&size=128&rounded=true&bold=true" 
                             alt="Digital AI Vision for Education Logo" 
                             class="h-10 w-10 rounded-full shadow-lg ring-2 ring-white/50">
                    </div>
                    <div>
                        <h1 class="font-bold text-xl md:text-2xl leading-tight tracking-wide text-white">Digital AI Vision for Education</h1>
                        <p id="nav-subtitle" class="text-[10px] text-deped-blue font-bold tracking-widest uppercase bg-yellow-400 px-2 py-0.5 rounded-full inline-block">Official Beta</p>
                    </div>
                </a>

                <!-- Desktop Menu -->
                <div class="hidden md:flex space-x-1 items-center">
                    <div class="wellness-zone hidden items-center gap-4 text-sm font-medium text-white/90"></div>

                    <div class="productivity-zone flex space-x-1 items-center">
                        <a href="#home" class="px-4 py-2 rounded-full hover:bg-white/10 transition font-medium text-sm">Home</a>
                        <a href="#tools" class="px-4 py-2 rounded-full hover:bg-white/10 transition font-medium text-sm">AI Tools</a>
                        <a href="#about" class="px-4 py-2 rounded-full hover:bg-white/10 transition font-medium text-sm">Mission</a>
                    </div>
                    
                    <a href="#community" id="nav-community-desktop" class="hidden ml-2 bg-white text-deped-blue px-6 py-2.5 rounded-full font-bold transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 text-sm flex items-center border border-slate-200 relative group overflow-visible">
                        <span id="community-badge" class="hidden absolute -top-1 -right-1 flex h-3.5 w-3.5 z-10">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3.5 w-3.5 bg-deped-red border-2 border-white"></span>
                        </span>
                        
                        <i class="fa-solid fa-users mr-2 group-hover:animate-bounce"></i> Community Hub
                    </a>

                    <div class="hidden md:block h-6 w-px bg-blue-400/30 mx-3"></div>

                    <!-- Guest State -->
                    <div id="auth-guest" class="flex items-center">
                        <button id="trigger-login" class="px-4 py-2 rounded-full text-white/90 hover:bg-white/10 transition font-medium text-sm mr-1">
                            Log In
                        </button>
                        <button class="trigger-register px-4 py-2 rounded-full bg-yellow-400 text-blue-900 hover:bg-yellow-300 transition font-bold text-sm shadow-md cursor-pointer flex items-center gap-2 hover:shadow-yellow-400/50 hover:scale-105 duration-300">
                            <i class="fa-solid fa-user-plus"></i> Register
                        </button>
                    </div>

                    <!-- Authenticated State -->
                    <div id="auth-user" class="hidden flex items-center gap-3 relative">
                        <!-- Notification Holder (New) -->
                        <button id="nav-notification-btn" class="hidden w-9 h-9 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white relative transition shadow-sm border border-white/10 group">
                            <i class="fa-solid fa-envelope text-sm group-hover:animate-wiggle"></i>
                            <span id="nav-notif-badge" class="absolute -top-1 -right-1 flex h-3 w-3">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500 border-2 border-deped-blue"></span>
                            </span>
                        </button>

                        <button id="user-menu-btn" class="flex items-center gap-3 bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/20 px-2 py-1.5 pr-4 rounded-full transition-all group shadow-lg ring-1 ring-white/10">
                            <div class="relative">
                                <img id="user-avatar-img" src="" alt="User" class="w-9 h-9 rounded-full shadow-sm ring-2 ring-white/30 group-hover:ring-white/60 transition-all object-cover bg-white">
                                <span id="user-status-dot" class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-blue-900 bg-slate-400"></span>
                            </div>
                            
                            <div class="text-left leading-tight hidden lg:block">
                                <p class="text-xs font-bold text-white group-hover:text-yellow-400 transition-colors" id="user-name-display">User</p>
                                <p class="text-[9px] text-blue-200 uppercase tracking-wider font-medium" id="user-role-display">Teacher</p>
                            </div>
                            <i id="user-menu-icon" class="fa-solid fa-chevron-down text-[10px] text-blue-200 ml-1 transition-transform duration-200 group-hover:text-white"></i>
                        </button>

                        <div id="user-dropdown" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden transform scale-95 opacity-0 pointer-events-none transition-all duration-200 origin-top-right z-50">
                            <div class="p-3 border-b border-slate-100 relative">
                                <button id="manual-sync-btn" class="absolute top-3 right-3 text-slate-300 hover:text-deped-blue transition-colors p-1" title="Sync Profile Status">
                                    <i class="fa-solid fa-rotate"></i>
                                </button>

                                <p class="text-xs text-slate-500 font-medium">Signed in as</p>
                                <p class="text-sm font-bold text-deped-blue truncate" id="user-dropdown-name">...</p>
                                <p class="text-[10px] text-slate-400 mt-0.5 font-medium" id="user-dropdown-validity"></p>
                            </div>
                            
                            <button id="nav-subscribe-btn" class="hidden w-full text-left flex items-center gap-2 px-4 py-3 text-sm text-yellow-600 hover:bg-yellow-50 transition border-b border-slate-50 font-bold">
                                <i class="fa-solid fa-crown"></i> Upgrade Plan
                            </button>

                            <a href="#" id="admin-panel-link" class="hidden flex items-center gap-2 px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 transition">
                                <i class="fa-solid fa-gauge-high text-slate-400"></i> Admin Dashboard
                            </a>
                            <button id="btn-logout" class="w-full text-left flex items-center gap-2 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition border-t border-slate-50">
                                <i class="fa-solid fa-right-from-bracket"></i> Log Out
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-btn" class="text-white p-2 rounded-lg hover:bg-white/10 focus:outline-none transition">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu Panel -->
        <div id="mobile-menu" class="hidden md:hidden bg-deped-blue border-t border-slate-700 absolute w-full shadow-2xl">
            <div class="px-4 pt-4 pb-6 space-y-2">
                <div class="productivity-zone">
                    <div id="mobile-auth-guest">
                         <a href="#home" class="block px-4 py-3 rounded-lg hover:bg-blue-800 transition font-medium">Home</a>
                         <a href="#tools" class="block px-4 py-3 rounded-lg hover:bg-blue-800 transition font-medium">AI Tools</a>
                         <button id="mobile-login-btn" class="w-full text-left block px-4 py-3 rounded-lg hover:bg-blue-800 transition font-medium">Log In</button>
                         <button class="trigger-register w-full text-left block px-4 py-3 rounded-lg bg-yellow-500 text-blue-900 hover:bg-yellow-400 transition font-bold mt-2">Register Account</button>
                    </div>

                    <div id="mobile-auth-user" class="hidden">
                         <div class="flex items-center gap-3 px-4 py-3 border-b border-blue-800/50 mb-2">
                             <div class="w-10 h-10 rounded-full bg-white text-deped-blue flex items-center justify-center font-bold text-lg" id="mobile-user-avatar">U</div>
                             <div>
                                 <p class="font-bold text-white" id="mobile-user-name">User</p>
                                 <p class="text-xs text-blue-300 uppercase tracking-widest" id="mobile-user-role">Role</p>
                             </div>
                         </div>
                         
                         <!-- Mobile Notification Holder (New) -->
                         <button id="mobile-notification-btn" class="hidden w-full text-left block px-4 py-3 rounded-lg text-white hover:bg-blue-800 transition font-medium mb-1 bg-blue-800/30 border border-blue-700/50">
                             <div class="flex items-center gap-3">
                                <div class="w-5 text-center"><i class="fa-solid fa-envelope text-yellow-400"></i></div>
                                <span class="flex-grow font-bold text-yellow-100">Personal Message</span>
                                <span id="mob-notif-badge" class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full animate-pulse">1</span>
                             </div>
                         </button>

                         <a href="#home" class="block px-4 py-3 rounded-lg hover:bg-blue-800 transition font-medium">Home</a>
                         <a href="#tools" class="block px-4 py-3 rounded-lg hover:bg-blue-800 transition font-medium">AI Tools</a>
                         <button id="mobile-subscribe-btn" class="w-full text-left block px-4 py-3 rounded-lg text-yellow-300 hover:bg-blue-800 transition font-bold hidden">
                             <i class="fa-solid fa-crown mr-2"></i> Upgrade Plan
                         </button>
                         <button id="mobile-logout-btn" class="w-full text-left block px-4 py-3 rounded-lg text-red-300 hover:bg-blue-800 transition font-medium">
                             <i class="fa-solid fa-right-from-bracket mr-2"></i> Log Out
                         </button>
                    </div>
                </div>
                <a href="#community" id="nav-community-mobile" class="hidden block px-4 py-3 rounded-lg bg-white text-deped-blue hover:bg-slate-100 mt-4 text-center font-bold shadow-md">Community Hub</a>
            </div>
        </div>
    </nav>

    <!-- WRAPPER: PRODUCTIVITY ZONE -->
    <div class="productivity-zone">
        <!-- Hero Section -->
        <section id="home" class="relative pt-24 pb-28 overflow-hidden bg-white">
            <div class="absolute inset-0 hero-pattern z-0"></div>
            
            <div class="absolute top-0 right-0 -mr-40 -mt-20 w-[600px] h-[600px] rounded-full bg-gradient-to-br from-blue-50 to-transparent opacity-50 blur-3xl z-0"></div>
            <div class="absolute bottom-0 left-0 -ml-20 -mb-20 w-96 h-96 rounded-full bg-gradient-to-tr from-red-50 to-transparent opacity-50 blur-3xl z-0"></div>

            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center reveal">
                <span class="inline-flex items-center px-4 py-1.5 rounded-full bg-blue-50 border border-blue-100 shadow-sm text-deped-blue text-xs font-bold tracking-widest uppercase mb-8 hover:scale-105 transition cursor-default">
                    <i class="fa-solid fa-flag mr-2 text-deped-red"></i> Mabuhay, Teachers!
                </span>
                <h1 class="text-5xl md:text-7xl lg:text-8xl font-bold text-slate-900 tracking-tight mb-8 leading-none drop-shadow-sm">
                    Empowering<br>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-deped-blue via-blue-600 to-deped-red pb-2">Filipino Teachers</span>
                </h1>
                <p class="mt-4 max-w-2xl mx-auto text-xl text-slate-600 leading-relaxed font-light">
                    Streamline your workflow with curriculum-aligned AI tools designed for the modern classroom. Efficient, accessible, and ready for 2026.
                </p>
                <div class="mt-12 flex flex-col sm:flex-row justify-center gap-4">
                    <a href="#tools" class="group px-8 py-4 bg-deped-blue text-white rounded-xl font-bold shadow-lg hover:shadow-blue-900/30 transition-all transform hover:-translate-y-1 flex items-center justify-center gap-3 relative overflow-hidden border border-blue-700">
                        <div class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                        <i class="fa-solid fa-paper-plane text-xl"></i> Launch Tools
                    </a>
                    <a href="#about" class="px-8 py-4 bg-white text-slate-600 border border-slate-200 rounded-xl font-semibold shadow-sm hover:bg-slate-50 hover:border-slate-300 transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-circle-info text-slate-400"></i> Learn More
                    </a>
                </div>
                
                <div class="mt-12 pt-8 border-t border-slate-100 max-w-lg mx-auto flex justify-center items-center gap-6 text-slate-500 text-sm font-medium">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-check-circle text-deped-blue"></i> Easy to use</span>
                    <span class="flex items-center gap-2"><i class="fa-solid fa-check-circle text-deped-blue"></i> DepEd Aligned</span>
                    
                </div>
            </div>
        </section>

        <!-- Voices Section (Spotlight) -->
        <section class="py-16 bg-slate-50 border-y border-slate-200 relative z-20">
            <div class="max-w-6xl mx-auto px-4 relative reveal">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold text-slate-800">Voices of Our Teachers</h2>
                    <div class="flex justify-center mt-3 space-x-2">
                         <span class="w-1.5 h-1.5 rounded-full bg-deped-blue"></span>
                         <span class="w-8 h-1.5 rounded-full bg-deped-red"></span>
                         <span class="w-1.5 h-1.5 rounded-full bg-deped-yellow"></span>
                    </div>
                </div>

                <div class="relative max-w-5xl mx-auto mt-8 mb-8">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-300 via-indigo-300 to-blue-300 rounded-[2rem] opacity-30 blur-md"></div>
                    
                    <div class="bg-white rounded-[1.8rem] shadow-xl border border-slate-100 relative overflow-hidden group hover:shadow-2xl transition-all duration-500 z-10">
                        <div class="p-8 md:p-12 relative z-10 h-[450px] flex items-center">
                             <button id="prev-spotlight" class="hidden md:flex absolute left-6 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-deped-blue hover:border-deped-blue items-center justify-center transition-all shadow-sm z-20 hover:scale-110">
                                <i class="fa-solid fa-chevron-left"></i>
                             </button>

                             <button id="next-spotlight" class="hidden md:flex absolute right-6 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-deped-blue hover:border-deped-blue items-center justify-center transition-all shadow-sm z-20 hover:scale-110">
                                <i class="fa-solid fa-chevron-right"></i>
                             </button>

                             <div id="spotlight-content" class="flex-grow flex flex-col justify-center items-center transition-opacity duration-300 opacity-100 w-full px-8 md:px-16">
                                <div class="animate-pulse flex flex-col items-center">
                                    <div class="h-4 w-24 bg-slate-200 rounded mb-4"></div>
                                    <div class="h-6 w-3/4 bg-slate-200 rounded mb-2"></div>
                                    <div class="h-6 w-1/2 bg-slate-200 rounded"></div>
                                </div>
                             </div>
                        </div>

                        <div class="bg-slate-50/50 border-t border-slate-100 py-3 px-6 flex justify-between items-center">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest hidden sm:block">Real feedback from real teachers</span>
                            <div id="spotlight-indicators" class="flex gap-2 mx-auto sm:mx-0"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tools Section -->
        <section id="tools" class="bg-white py-24 relative">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12 reveal">
                    <span id="tools-subtitle" class="text-deped-red font-bold text-sm tracking-widest uppercase mb-2 block">Powered by Gemini</span>
                    <h2 id="tools-title" class="text-4xl md:text-5xl font-bold text-slate-900 mb-6">Tools for Education</h2>
                    <p class="mt-4 text-slate-600 max-w-2xl mx-auto text-lg">
                        Select a tool below to launch the AI assistant. Designed to support your daily teaching tasks.
                    </p>
                </div>

                <div id="tools-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 min-h-[400px]">
                    <div class="col-span-full flex flex-col items-center justify-center text-slate-400 py-12">
                        <div class="relative w-16 h-16 mx-auto mb-4">
                            <div class="absolute inset-0 bg-blue-50 rounded-full animate-ping opacity-75"></div>
                             <img src="https://ui-avatars.com/api/?name=AI&background=1e3a8a&color=fff&size=128&rounded=true&bold=true" class="relative z-10 w-16 h-16 rounded-full shadow-lg border-2 border-white">
                        </div>
                        <p class="text-sm font-bold text-deped-blue animate-pulse tracking-widest uppercase">Initializing Tools...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section id="about" class="bg-slate-50 py-24 relative overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
                <div class="lg:grid lg:grid-cols-2 lg:gap-20 items-center">
                    <div class="mb-12 lg:mb-0 relative reveal">
                        <div class="relative bg-white rounded-3xl p-10 border-2 border-slate-200 shadow-sm">
                            <i class="fa-solid fa-calendar-check text-blue-100 text-9xl absolute bottom-0 right-0 -mr-4 -mb-4 opacity-50"></i>
                            <h3 class="text-2xl font-bold text-slate-900 mb-6 text-3xl">Why AI in Education?</h3>
                            <ul class="space-y-6">
                                <li class="flex items-start">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mt-1 mr-4">
                                        <i class="fa-solid fa-check text-blue-600 text-sm"></i>
                                    </div>
                                    <span class="text-slate-700 font-medium leading-snug">Efficient lesson planning and grading support.</span>
                                </li>
                                <li class="flex items-start">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mt-1 mr-4">
                                        <i class="fa-solid fa-check text-blue-600 text-sm"></i>
                                    </div>
                                    <span class="text-slate-700 font-medium leading-snug">Reduce administrative workload for teachers.</span>
                                </li>
                                <li class="flex items-start">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mt-1 mr-4">
                                        <i class="fa-solid fa-check text-blue-600 text-sm"></i>
                                    </div>
                                    <span class="text-slate-700 font-medium leading-snug">Create engaging, contextualized learning materials.</span>
                                </li>
                                <li class="flex items-start">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mt-1 mr-4">
                                        <i class="fa-solid fa-check text-blue-600 text-sm"></i>
                                    </div>
                                    <span class="text-slate-700 font-medium leading-snug">Foster innovation in the Filipino classroom.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="reveal">
                        <span class="text-deped-blue font-bold tracking-widest uppercase text-sm mb-2 block">Our Mission</span>
                        <h2 class="text-4xl md:text-5xl font-bold text-slate-900 mb-6">"Para sa Bata,<br>Para sa Bayan."</h2>
                        <p class="text-slate-600 leading-relaxed mb-6 text-lg">
                            The Digital AI Vision for Education Program aims to be the helping hand every teacher deserves. We believe that Artificial Intelligence should not replace teachers, but rather act as a supportive partner that amplifies their capacity to inspire.
                        </p>
                        <p class="text-slate-600 leading-relaxed text-lg">
                            By providing accessible and curriculum-aligned tools, we hope to give you back the precious gift of time for your family and yourself.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Registration Modal -->
        <div id="register-modal" class="fixed inset-0 z-[200] bg-slate-900/80 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl overflow-hidden relative transform scale-95 transition-all duration-300 flex flex-col lg:flex-row max-h-[90vh] lg:h-auto">
                <button id="close-register-modal" class="absolute top-4 right-4 z-30 w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 hover:text-slate-800 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>

                <!-- Left Panel (Hidden on Mobile) -->
                <div class="hidden lg:flex bg-deped-blue p-8 lg:p-12 lg:w-2/5 flex-col justify-between relative overflow-hidden text-white flex-shrink-0">
                     <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                     <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
                     <div class="absolute -bottom-8 -left-8 w-64 h-64 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>

                     <div class="relative z-10">
                         <div class="flex items-center gap-3 mb-8">
                             <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center backdrop-blur-sm">
                                <i class="fa-solid fa-id-card text-yellow-400"></i>
                             </div>
                             <span class="text-xs font-bold tracking-widest uppercase text-blue-200">Official Membership</span>
                         </div>
                         
                         <h2 class="text-3xl lg:text-4xl font-bold leading-tight mb-6">Join the Digital AI Network</h2>
                         <p class="text-blue-100 text-sm leading-relaxed mb-8">
                             Unlock the full potential of our AI tools. Create an account to save lesson plans, customize assessments, and get priority support.
                         </p>

                         <div class="space-y-4">
                            <div class="flex items-center gap-3 p-3 rounded-lg bg-blue-800/50 border border-blue-700/50">
                                <div class="w-6 h-6 rounded-full bg-yellow-400 flex items-center justify-center flex-shrink-0 text-blue-900 text-xs"><i class="fa-solid fa-check"></i></div>
                                <span class="text-sm font-medium">Save generated content</span>
                            </div>
                            <div class="flex items-center gap-3 p-3 rounded-lg bg-blue-800/50 border border-blue-700/50">
                                <div class="w-6 h-6 rounded-full bg-yellow-400 flex items-center justify-center flex-shrink-0 text-blue-900 text-xs"><i class="fa-solid fa-robot"></i></div>
                                <span class="text-sm font-medium">Exclusive new AI models</span>
                            </div>
                            <div class="flex items-center gap-3 p-3 rounded-lg bg-blue-800/50 border border-blue-700/50">
                                <div class="w-6 h-6 rounded-full bg-yellow-400 flex items-center justify-center flex-shrink-0 text-blue-900 text-xs"><i class="fa-solid fa-certificate"></i></div>
                                <span class="text-sm font-medium">Community badge</span>
                            </div>
                         </div>
                     </div>

                     <div class="relative z-10 mt-8 pt-6 border-t border-blue-800/50">
                         <p class="text-xs text-blue-300 text-center">"Para sa Bata, Para sa Bayan"</p>
                     </div>
                </div>

                <div class="bg-white p-8 lg:p-12 lg:w-3/5 overflow-y-auto custom-scroll relative">
                    <div id="reg-content">
                        <div class="mb-6">
                            <h3 class="text-2xl font-bold text-slate-800">Create Account</h3>
                            <p class="text-sm text-slate-500">Free forever for public school teachers.</p>
                        </div>

                        <iframe name="register_iframe" id="register_iframe" style="display:none;"></iframe>
                        
                        <form id="registrationForm" 
                              action="https://docs.google.com/forms/d/e/1FAIpQLScYNVo2LoBOeVwsN55XiFX0IVz4H_jNd99lqWUBXBH5-6TUSw/formResponse" 
                              method="POST" 
                              target="register_iframe"
                              class="space-y-4">
                            
                            <div id="reg-error" class="hidden bg-red-50 text-red-600 px-4 py-3 rounded-lg text-xs font-bold flex items-center gap-2 border border-red-100 animate-pulse">
                                <i class="fa-solid fa-circle-exclamation text-lg"></i>
                                <span id="reg-error-msg">Username already taken.</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Full Name</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-id-card absolute left-3 top-3 text-slate-400 text-xs"></i>
                                        <input type="text" name="entry.274563009" required placeholder="Juan Dela Cruz" 
                                            class="w-full pl-8 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors">
                                    </div>
                                </div>

                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Username</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-user absolute left-3 top-3 text-slate-400 text-xs"></i>
                                        <input type="text" name="entry.1514621509" required placeholder="TeacherJuan" 
                                            class="w-full pl-8 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Create Password</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-lock absolute left-3 top-3 text-slate-400 text-xs"></i>
                                        <input type="password" id="reg-password" name="entry.708553270" required placeholder="••••••••" 
                                            class="w-full pl-8 pr-10 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors">
                                        <button type="button" id="toggle-reg-password" class="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600 focus:outline-none" tabindex="-1">
                                            <i class="fa-solid fa-eye text-xs"></i>
                                        </button>
                                    </div>
                                    <p id="pass-length-indicator" class="text-[10px] text-slate-400 mt-1 flex items-center gap-1 transition-colors">
                                        <i class="fa-solid fa-circle-info"></i> Min. 8 characters
                                    </p>
                                </div>

                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Confirm Password</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-check-double absolute left-3 top-3 text-slate-400 text-xs"></i>
                                        <input type="password" id="reg-confirm-password" required placeholder="••••••••" 
                                            class="w-full pl-8 pr-10 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors">
                                        <button type="button" id="toggle-reg-confirm-password" class="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600 focus:outline-none" tabindex="-1">
                                            <i class="fa-solid fa-eye text-xs"></i>
                                        </button>
                                    </div>
                                    <p id="pass-match-warning" class="hidden text-[10px] text-red-500 font-bold mt-1 ml-1 flex items-center gap-1 animate-pulse">
                                        <i class="fa-solid fa-circle-xmark"></i> Passwords do not match
                                    </p>
                                </div>
                            </div>

                            <div class="flex justify-between items-start">
                                <p id="reg-caps-warning" class="hidden text-[10px] text-red-500 font-bold mt-1 flex items-center gap-1 animate-pulse">
                                    <i class="fa-solid fa-arrow-up-from-bracket"></i> Caps Lock is ON
                                </p>
                                <p class="text-[10px] text-slate-400 text-right italic mt-1 ml-auto">We recommend a unique password for this site.</p>
                            </div>

                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-600 uppercase">Security Question</label>
                                <div class="relative">
                                    <i class="fa-solid fa-circle-question absolute left-3 top-3.5 text-slate-400 text-xs"></i>
                                    <select name="entry.337984504" required class="w-full pl-8 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors appearance-none cursor-pointer">
                                        <option value="" disabled selected>Select a security question</option>
                                        <option value="What is the middle name of your oldest cousin?">What is the middle name of your oldest cousin?</option>
                                        <option value="What is the name of your first pet?">What is the name of your first pet?</option>
                                        <option value="In what city were you born?">In what city were you born?</option>
                                        <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down absolute right-4 top-3.5 text-slate-400 text-xs pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-600 uppercase">Security Answer</label>
                                <div class="relative">
                                    <i class="fa-solid fa-key absolute left-3 top-3 text-slate-400 text-xs"></i>
                                    <input type="text" name="entry.1264702410" required placeholder="Your answer" 
                                        class="w-full pl-8 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">School / Institution</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-school absolute left-3 top-3 text-slate-400 text-xs"></i>
                                        <input type="text" name="entry.249358016" required placeholder="National High School" 
                                            class="w-full pl-8 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors">
                                    </div>
                                </div>

                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Current Address</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-location-dot absolute left-3 top-3 text-slate-400 text-xs"></i>
                                        <input type="text" name="entry.112254655" required placeholder="City, Province" 
                                            class="w-full pl-8 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors">
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-600 uppercase">Where did you hear about us?</label>
                                <div class="relative">
                                    <i class="fa-solid fa-bullhorn absolute left-3 top-3 text-slate-400 text-xs"></i>
                                    <select name="entry.2106899850" class="w-full pl-8 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors appearance-none cursor-pointer">
                                        <option value="" disabled selected>Select an option</option>
                                        <option value="Search Engine (e.g., Google, Bing)">Search Engine</option>
                                        <option value="Social Media (e.g., Facebook, X, Instagram)">Social Media</option>
                                        <option value="Friend or Colleague">Friend or Colleague</option>
                                        <option value="School/Institution Event">School Event</option>
                                        <option value="Advertisement">Advertisement</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down absolute right-4 top-3.5 text-slate-400 text-xs pointer-events-none"></i>
                                </div>
                            </div>

                            <button type="submit" id="reg-submit-btn" class="w-full mt-6 bg-deped-blue hover:bg-blue-800 text-white font-bold py-3.5 rounded-xl transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center gap-2 group">
                                <span>Complete Registration</span>
                                <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                            </button>
                            
                        </form>
                    </div> 

                    <div id="reg-success" class="hidden h-full flex-col items-center justify-center text-center p-8 animate-fadeIn">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-600 text-3xl shadow-sm">
                            <i class="fa-solid fa-check"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">Registration Submitted!</h3>
                        <p class="text-slate-600 text-sm mb-6 leading-relaxed">
                            Your account has been successfully registered in our system.<br>
                            Please wait until your account has been <strong>verified by the admin</strong> before accessing the tools.
                        </p>
                        <button id="reg-reset-btn" class="bg-slate-100 text-slate-700 font-bold py-2 px-6 rounded-lg hover:bg-slate-200 transition text-sm">
                            Close
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Login Modal -->
        <div id="login-modal" class="fixed inset-0 z-[200] bg-slate-900/80 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative transform scale-95 transition-all duration-300 overflow-hidden">
                <button id="close-login-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800 transition z-10"><i class="fa-solid fa-xmark text-xl"></i></button>

                <div class="bg-deped-blue px-8 py-6 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm border border-white/20">
                        <i class="fa-solid fa-right-to-bracket text-yellow-400 text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white">Welcome Back</h3>
                    <p class="text-blue-200 text-sm">Sign in to access your dashboard</p>
                </div>

                <div class="p-8">
                    <form id="loginForm" class="space-y-5">
                        <div id="login-error" class="hidden bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm flex items-center gap-2 border border-red-100">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            <span>Invalid username or password.</span>
                        </div>

                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-600 uppercase tracking-wide">Username</label>
                            <div class="relative">
                                <i class="fa-solid fa-user absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                                <input type="text" id="login-username" required 
                                    class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors placeholder-slate-400" placeholder="Enter your username">
                            </div>
                        </div>
                        
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-600 uppercase tracking-wide">Password</label>
                            <div class="relative">
                                <i class="fa-solid fa-lock absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                                <input type="password" id="login-password" required 
                                    class="w-full pl-10 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-deped-blue focus:ring-1 focus:ring-deped-blue transition-colors placeholder-slate-400" placeholder="••••••••">
                                <button type="button" id="toggle-login-password" class="absolute right-3 top-3.5 text-slate-400 hover:text-slate-600 focus:outline-none" tabindex="-1">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>

                            <div class="flex justify-between items-center mt-3">
                                <label class="flex items-center gap-2 cursor-pointer group select-none">
                                    <input type="checkbox" id="login-remember" class="w-3.5 h-3.5 text-deped-blue border-slate-300 rounded focus:ring-deped-blue transition cursor-pointer">
                                    <span class="text-xs text-slate-500 font-bold group-hover:text-slate-700 transition">Remember Me</span>
                                </label>
                                
                                <div class="flex flex-col items-end">
                                    <p id="login-caps-warning" class="hidden text-[10px] text-red-500 font-bold flex items-center gap-1 animate-pulse mb-1">
                                        <i class="fa-solid fa-arrow-up-from-bracket"></i> Caps Lock is ON
                                    </p>
                                    <button type="button" id="trigger-forgot-password" class="text-xs text-deped-blue hover:text-blue-700 hover:underline font-bold transition">Forgot Password?</button>
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="btn-login-submit" class="w-full bg-deped-blue hover:bg-blue-800 text-white font-bold py-3.5 rounded-xl transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center gap-2 mt-2">
                            <span>Sign In</span>
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </form>

                    <div class="mt-6 text-center">
                        <p class="text-sm text-slate-500">Don't have an account? <button class="trigger-register text-deped-blue font-bold hover:underline">Register here</button></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forgot Password Modal -->
        <div id="forgot-password-modal" class="fixed inset-0 z-[210] bg-slate-900/80 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative transform scale-95 transition-all duration-300 overflow-hidden">
                
                <button id="close-forgot-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800 transition z-10"><i class="fa-solid fa-xmark text-xl"></i></button>

                <div class="bg-slate-50 px-8 py-6 border-b border-slate-100">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-key text-yellow-500"></i> Password Recovery
                    </h3>
                </div>

                <div class="p-8">
                    <div id="fp-step-1" class="space-y-4">
                        <p class="text-sm text-slate-600">Enter your username to search for your account.</p>
                        <div class="relative">
                            <i class="fa-solid fa-user absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                            <input type="text" id="fp-username" class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-deped-blue transition-colors" placeholder="Username">
                        </div>
                        <p id="fp-error-1" class="hidden text-xs text-red-500 font-bold flex items-center gap-1"><i class="fa-solid fa-circle-xmark"></i> User not found.</p>
                        <button id="fp-btn-next-1" class="w-full bg-deped-blue text-white font-bold py-3 rounded-xl hover:bg-blue-800 transition shadow-md">Next</button>
                    </div>

                    <div id="fp-step-2" class="hidden space-y-4">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Security Question</p>
                        <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg text-blue-900 font-medium text-sm">
                            <i class="fa-solid fa-circle-question mr-2 text-blue-500"></i>
                            <span id="fp-question-display">...</span>
                        </div>
                        <div class="relative">
                            <i class="fa-solid fa-unlock-keyhole absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                            <input type="text" id="fp-answer" class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-deped-blue transition-colors" placeholder="Your Answer">
                        </div>
                        <p id="fp-error-2" class="hidden text-xs text-red-500 font-bold flex items-center gap-1"><i class="fa-solid fa-circle-xmark"></i> Incorrect answer.</p>
                        <button id="fp-btn-verify" class="w-full bg-deped-blue text-white font-bold py-3 rounded-xl hover:bg-blue-800 transition shadow-md">Verify</button>
                    </div>

                    <div id="fp-step-3" class="hidden space-y-4">
                        <p class="text-sm text-slate-600">Identity verified. Please set a new password.</p>
                        <iframe name="reset_iframe" id="reset_iframe" style="display:none;"></iframe>
                        <form id="resetPasswordForm" 
                              action="https://docs.google.com/forms/d/e/1FAIpQLSfpMCRQrYB7HntsnRMKiGFALMzxLyCRY0kl2wVkruJF7Mw88g/formResponse" 
                              method="POST" 
                              target="reset_iframe"
                              class="space-y-3">
                            
                            <input type="hidden" name="entry.1931916015" id="fp-form-user">
                            <input type="hidden" name="entry.1001625426" id="fp-form-question">
                            
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">New Password</label>
                                <div class="relative">
                                    <input type="password" id="fp-new-pass" name="entry.1751531902" required class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-deped-blue transition-colors" placeholder="New Password">
                                </div>
                                <p id="fp-len-indicator" class="text-[10px] text-slate-400 mt-1"><i class="fa-solid fa-circle-info"></i> Min 8 chars</p>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Confirm Password</label>
                                <input type="password" id="fp-confirm-pass" required class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-deped-blue transition-colors" placeholder="Confirm Password">
                                <p id="fp-match-error" class="hidden text-[10px] text-red-500 font-bold mt-1">Passwords do not match</p>
                            </div>

                            <button type="submit" id="fp-btn-submit" class="w-full bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 transition shadow-md mt-2">Reset Password</button>
                        </form>
                    </div>

                    <div id="fp-step-4" class="hidden text-center py-4">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-500 text-3xl">
                            <i class="fa-solid fa-check"></i>
                        </div>
                        <h4 class="text-lg font-bold text-slate-800">Request Submitted</h4>
                        <p class="text-sm text-slate-500 mt-2 mb-6">Your password change request has been sent securely. Please wait for admin approval.</p>
                        <button id="fp-btn-close" class="px-6 py-2 bg-slate-100 text-slate-700 font-bold rounded-lg hover:bg-slate-200 transition">Close</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Logout Confirmation Modal (NEW) -->
        <div id="logout-confirm-modal" class="fixed inset-0 z-[300] bg-slate-900/80 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0">
            <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform scale-95 transition-all text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 -mr-4 -mt-4 w-20 h-20 bg-red-100 rounded-full opacity-50 blur-xl"></div>
                
                <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-3xl shadow-sm border border-red-100">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Sign Out?</h3>
                <p class="text-sm text-slate-500 mb-6 leading-relaxed">Are you sure you want to end your session? You will need to log in again to access tools.</p>
                <div class="flex gap-3 justify-center">
                    <button id="cancel-logout" class="flex-1 px-5 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold text-xs hover:bg-slate-50 transition">Cancel</button>
                    <button id="confirm-logout" class="flex-1 px-5 py-3 rounded-xl bg-red-600 text-white font-bold text-xs hover:bg-red-700 transition shadow-md hover:shadow-lg">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: SUBSCRIPTION / VERIFICATION MODAL -->
    <div id="subscription-modal" class="fixed inset-0 z-[200] bg-slate-900/80 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative transform scale-95 transition-all duration-300 overflow-hidden flex flex-col max-h-[90vh]">
            
            <button id="close-subscription-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800 transition z-10"><i class="fa-solid fa-xmark text-xl"></i></button>

            <!-- Header -->
            <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 px-8 py-6 text-center relative overflow-hidden flex-shrink-0">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm border border-white/30 text-white text-3xl shadow-sm">
                    <i class="fa-solid fa-crown"></i>
                </div>
                <h3 class="text-2xl font-bold text-white shadow-sm">Unlock Premium</h3>
                <p class="text-yellow-50 text-sm font-medium">Verify your account for full access</p>
            </div>

            <div class="p-8 overflow-y-auto custom-scroll">
                <!-- Content -->
                <div id="sub-content">
                    <p class="text-sm text-slate-600 mb-4 leading-relaxed text-center">
                        Submit a verification request to upgrade your account.
                    </p>

                    <!-- NEW: Pricing Banner -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-4 mb-6 text-center shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-yellow-400 opacity-10 rounded-full -mr-8 -mt-8"></div>
                        <div class="flex items-center justify-center gap-2 mb-1">
                            <span class="bg-yellow-400 text-blue-900 text-[9px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider shadow-sm">Best Value</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800">₱100.00</p>
                        <p class="text-xs font-bold text-blue-600 uppercase tracking-widest mt-1">For 1 Year Access</p>
                        <p class="text-[10px] text-slate-500 mt-2 leading-tight px-4 max-w-xs mx-auto border-t border-blue-100 pt-2">
                            Enjoy full access to premium AI tools for 12 months. That's less than ₱9 per month!
                        </p>
                    </div>

                    <!-- ADDED: GCash Payment Details -->
                    <div class="bg-white border-2 border-blue-100 border-dashed rounded-xl p-4 mb-6 text-center relative group hover:border-blue-300 transition-colors">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-wallet text-blue-500"></i> Send Payment via GCash
                        </p>
                        <div class="flex flex-col items-center justify-center gap-1">
                            <div class="flex items-center gap-3 bg-slate-50 px-4 py-2 rounded-lg border border-slate-100">
                                <span class="text-lg font-bold text-deped-blue tracking-wider select-all font-mono">0935 465 7854</span>
                                <button type="button" onclick="const el = document.createElement('textarea'); el.value = '09354657854'; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); this.innerHTML='<i class=\'fa-solid fa-check\'></i>'; setTimeout(()=>{this.innerHTML='<i class=\'fa-regular fa-copy\'></i>'}, 2000);" class="text-slate-400 hover:text-blue-600 transition w-6 h-6 flex items-center justify-center" title="Copy Number">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                            </div>
                            <p class="text-[10px] font-bold text-slate-500 mt-1">DAVID JESS F. ASAURO</p>
                        </div>
                    </div>

                    <iframe name="subscription_iframe" id="subscription_iframe" style="display:none;"></iframe>
                    
                    <form id="subscriptionForm" 
                          action="https://docs.google.com/forms/d/e/1FAIpQLScR2HuMs8b2Y9nB0gDigMqbfnuCuosZM-hi5l0cAiGZ-rWrJA/formResponse" 
                          method="POST" 
                          target="subscription_iframe"
                          class="space-y-4">
                        
                        <!-- REQUIRED: Page History -->
                        <input type="hidden" name="pageHistory" value="0">

                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Account Username</label>
                            <div class="relative">
                                <i class="fa-solid fa-user absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                                <input type="text" id="sub-username" name="entry.1777078683" readonly 
                                    class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 cursor-not-allowed focus:outline-none">
                            </div>
                        </div>

                        <!-- Transaction Code Input -->
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">GCash Reference No.</label>
                            <div class="relative">
                                <i class="fa-solid fa-receipt absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                                <input type="text" id="sub-ref" name="entry.237094028" required placeholder="Ex. 1002348592"
                                    class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-yellow-500 transition-colors">
                            </div>
                        </div>

                        <!-- Amount -->
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Amount Paid</label>
                            <div class="relative">
                                <i class="fa-solid fa-peso-sign absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                                <input type="number" id="sub-amount" name="entry.629546664" required placeholder="100" value="100"
                                    class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-yellow-500 transition-colors">
                            </div>
                        </div>

                        <!-- Date of Payment (Visual Only) -->
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Date of Payment</label>
                            <div class="relative">
                                <i class="fa-solid fa-calendar-days absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                                <input type="date" id="sub-date"
                                    class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-yellow-500 transition-colors text-slate-600">
                            </div>
                            <p class="text-[10px] text-slate-400 mt-1 italic">Optional.</p>
                        </div>

                        <!-- UPDATED BUTTON LAYOUT -->
                        <div class="mt-6 space-y-4 pt-2">
                            <!-- Direct Submit (Primary) -->
                            <button type="submit" id="btn-sub-submit" class="w-full bg-deped-blue hover:bg-blue-800 text-white font-bold py-3.5 rounded-xl transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center gap-2 group ring-1 ring-blue-700/20">
                                <span>Submit Payment Verification</span>
                                <i class="fa-solid fa-paper-plane group-hover:translate-x-1 transition-transform"></i>
                            </button>

                            <div class="relative flex py-1 items-center">
                                <div class="flex-grow border-t border-slate-200"></div>
                                <span class="flex-shrink-0 mx-2 text-[10px] text-slate-400 font-bold uppercase tracking-widest">Or</span>
                                <div class="flex-grow border-t border-slate-200"></div>
                            </div>

                            <!-- Fallback Link (Secondary) -->
                            <a id="backup-form-link" href="https://www.facebook.com/y2k2009/" target="_blank" class="w-full bg-white border-2 border-slate-100 text-slate-500 hover:text-blue-600 hover:border-blue-200 hover:bg-blue-50 font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 text-xs group">
                                <i class="fa-brands fa-facebook-messenger text-lg group-hover:scale-110 transition-transform"></i>
                                <span>Contact Admin for Help</span>
                            </a>
                        </div>
                    </form>
                </div>

                <!-- Success State -->
                <div id="sub-success" class="hidden text-center py-4 animate-fadeIn">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-500 text-3xl">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <h4 class="text-lg font-bold text-slate-800">Request Sent!</h4>
                    <p class="text-sm text-slate-500 mt-2 mb-6">Your verification request has been submitted. Please wait for admin approval (usually 24-48 hours).</p>
                    <button id="btn-sub-close" class="px-6 py-2 bg-slate-100 text-slate-700 font-bold rounded-lg hover:bg-slate-200 transition">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD MODAL (NEW) -->
    <div id="admin-modal" class="fixed inset-0 z-[250] bg-slate-900/80 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-6xl h-[85vh] relative transform scale-95 transition-all duration-300 overflow-hidden flex flex-col md:flex-row ring-1 ring-slate-900/5">
            
            <!-- Sidebar Navigation (SaaS Style) -->
            <div class="w-full md:w-64 bg-slate-900 text-slate-300 flex-shrink-0 flex flex-col justify-between border-r border-slate-800 relative overflow-hidden">
                <!-- Decorative background blobs -->
                <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none opacity-20">
                    <div class="absolute -top-24 -left-24 w-64 h-64 bg-blue-600 rounded-full blur-3xl"></div>
                    <div class="absolute bottom-0 right-0 w-64 h-64 bg-indigo-600 rounded-full blur-3xl"></div>
                </div>

                <div class="relative z-10">
                    <div class="p-6 mb-2 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/20 ring-1 ring-white/10">
                            <i class="fa-solid fa-layer-group text-sm"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-sm tracking-wide">Admin OS</h3>
                            <p class="text-[10px] font-medium text-slate-500 uppercase tracking-widest">v2.4.0</p>
                        </div>
                    </div>
                    
                    <nav class="px-3 space-y-1">
                        <p class="px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 mt-4">Analytics</p>
                        <button onclick="switchAdminTab('dashboard')" id="tab-btn-dashboard" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-xs font-bold transition-all text-white bg-blue-600 shadow-md border border-blue-500/50 group">
                            <i class="fa-solid fa-chart-pie w-5 text-center text-blue-200 group-hover:text-white transition-colors"></i> Dashboard
                        </button>
                        
                        <p class="px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 mt-6">Management</p>
                        <button onclick="switchAdminTab('payments')" id="tab-btn-payments" class="w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-xs font-medium text-slate-400 hover:text-white hover:bg-white/5 transition-all group">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-receipt w-5 text-center group-hover:text-blue-400 transition-colors"></i> Payments
                            </div>
                            <span id="payment-badge" class="hidden bg-red-500 text-white text-[9px] font-extrabold px-1.5 py-0.5 rounded-full shadow-sm">0</span>
                        </button>
                        <button onclick="switchAdminTab('communications')" id="tab-btn-communications" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-xs font-medium text-slate-400 hover:text-white hover:bg-white/5 transition-all group">
                            <i class="fa-solid fa-bullhorn w-5 text-center group-hover:text-blue-400 transition-colors"></i> Communications
                        </button>
                        <button onclick="switchAdminTab('content')" id="tab-btn-content" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-xs font-medium text-slate-400 hover:text-white hover:bg-white/5 transition-all group">
                            <i class="fa-solid fa-cube w-5 text-center group-hover:text-blue-400 transition-colors"></i> Content
                        </button>
                    </nav>
                </div>

                <div class="p-4 border-t border-slate-800 relative z-10 bg-slate-900/50 backdrop-blur-sm">
                    <button id="close-admin-modal" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-xs font-bold text-slate-400 hover:text-white hover:bg-white/5 transition-all group border border-transparent hover:border-slate-700">
                        <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i> Return to App
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-hidden bg-slate-50 relative flex flex-col">
                <!-- Loading State Overlay -->
                <div id="admin-loader" class="absolute inset-0 bg-white/80 z-50 flex flex-col items-center justify-center backdrop-blur-sm hidden">
                    <i class="fa-solid fa-circle-notch fa-spin text-blue-600 text-4xl mb-4"></i>
                    <p class="text-sm font-bold text-slate-600 animate-pulse">Processing Request...</p>
                </div>

                <!-- TAB 1: DASHBOARD (Analytics & Users) -->
                <div id="admin-tab-dashboard" class="admin-tab-content h-full overflow-y-auto custom-scroll p-8">
                    
                    <!-- SaaS Header -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-8 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 tracking-tight">System Overview</h2>
                            <p class="text-sm text-slate-500 font-medium">Welcome back, Admin. Here's what's happening today.</p>
                        </div>
                        <div class="flex items-center gap-1 bg-white border border-slate-200 rounded-lg p-1 shadow-sm">
                            <button class="px-3 py-1.5 text-[10px] font-bold text-slate-500 hover:bg-slate-50 rounded-md transition">7D</button>
                            <button class="px-3 py-1.5 text-[10px] font-bold bg-slate-100 text-slate-800 rounded-md shadow-sm border border-slate-200">30D</button>
                            <button class="px-3 py-1.5 text-[10px] font-bold text-slate-500 hover:bg-slate-50 rounded-md transition">All</button>
                        </div>
                    </div>
                    
                    <!-- Analytics Cards (Widgets) -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                        <!-- Total Users Card -->
                        <div onclick="filterAdminUsers('all')" class="bg-white p-5 rounded-xl border border-slate-200 shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)] cursor-pointer hover:border-blue-400 hover:shadow-md transition-all group active:scale-95">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center border border-blue-100">
                                    <i class="fa-solid fa-users text-lg"></i>
                                </div>
                                <span class="bg-green-50 text-green-600 text-[10px] font-bold px-1.5 py-0.5 rounded-full flex items-center gap-1">
                                    <i class="fa-solid fa-arrow-trend-up"></i> 12%
                                </span>
                            </div>
                            <div>
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Total Users</p>
                                <h3 class="text-2xl font-bold text-slate-800 mt-1" id="stat-total">0</h3>
                            </div>
                        </div>

                        <!-- Pending Card -->
                        <div onclick="filterAdminUsers('pending')" class="bg-white p-5 rounded-xl border border-slate-200 shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)] cursor-pointer hover:border-yellow-400 hover:shadow-md transition-all group active:scale-95">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-10 h-10 rounded-lg bg-yellow-50 text-yellow-600 flex items-center justify-center border border-yellow-100">
                                    <i class="fa-solid fa-clock text-lg"></i>
                                </div>
                                <span class="bg-slate-50 text-slate-400 text-[10px] font-bold px-1.5 py-0.5 rounded-full">--</span>
                            </div>
                            <div>
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Pending</p>
                                <h3 class="text-2xl font-bold text-slate-800 mt-1" id="stat-pending">0</h3>
                            </div>
                        </div>

                        <!-- Premium Card -->
                        <div onclick="filterAdminUsers('premium')" class="bg-gradient-to-br from-slate-900 to-slate-800 p-5 rounded-xl border border-slate-700 shadow-lg cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all group active:scale-95 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                            <div class="flex justify-between items-start mb-4 relative z-10">
                                <div class="w-10 h-10 rounded-lg bg-white/10 text-yellow-400 flex items-center justify-center border border-white/5">
                                    <i class="fa-solid fa-crown text-lg"></i>
                                </div>
                                <span class="bg-white/10 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-white/5">Pro</span>
                            </div>
                            <div class="relative z-10">
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Premium</p>
                                <h3 class="text-2xl font-bold text-white mt-1" id="stat-premium">0</h3>
                            </div>
                        </div>

                        <!-- Basic Card -->
                        <div onclick="filterAdminUsers('basic')" class="bg-white p-5 rounded-xl border border-slate-200 shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)] cursor-pointer hover:border-green-400 hover:shadow-md transition-all group active:scale-95">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-10 h-10 rounded-lg bg-green-50 text-green-600 flex items-center justify-center border border-green-100">
                                    <i class="fa-solid fa-user-shield text-lg"></i>
                                </div>
                                <span class="bg-green-50 text-green-600 text-[10px] font-bold px-1.5 py-0.5 rounded-full flex items-center gap-1">
                                    <i class="fa-solid fa-arrow-trend-up"></i> 5%
                                </span>
                            </div>
                            <div>
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Basic</p>
                                <h3 class="text-2xl font-bold text-slate-800 mt-1" id="stat-basic">0</h3>
                            </div>
                        </div>

                        <!-- Expired Card -->
                        <div onclick="filterAdminUsers('expired')" class="bg-white p-5 rounded-xl border border-slate-200 shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)] cursor-pointer hover:border-red-400 hover:shadow-md transition-all group active:scale-95">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-10 h-10 rounded-lg bg-red-50 text-red-600 flex items-center justify-center border border-red-100">
                                    <i class="fa-solid fa-calendar-xmark text-lg"></i>
                                </div>
                                <span class="bg-red-50 text-red-600 text-[10px] font-bold px-1.5 py-0.5 rounded-full">Action</span>
                            </div>
                            <div>
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Expired</p>
                                <h3 class="text-2xl font-bold text-slate-800 mt-1" id="stat-expired">0</h3>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Distribution Bar (SaaS Style) -->
                    <div class="bg-white rounded-xl border border-slate-200 p-5 mb-8 shadow-sm">
                        <div class="flex justify-between items-end mb-3">
                            <div>
                                <h4 class="text-sm font-bold text-slate-800">User Distribution</h4>
                                <p class="text-[10px] text-slate-400 font-medium mt-0.5">Ratio of subscription tiers</p>
                            </div>
                            <div class="flex gap-4 text-[10px] font-bold text-slate-600">
                                <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-yellow-400 shadow-sm"></span> Premium</span>
                                <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-green-500 shadow-sm"></span> Basic</span>
                                <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-slate-300 shadow-sm"></span> Pending</span>
                            </div>
                        </div>
                        <div class="h-4 w-full bg-slate-50 rounded-full overflow-hidden flex border border-slate-200 shadow-inner">
                            <div id="bar-premium" class="h-full bg-gradient-to-r from-yellow-400 to-amber-400 transition-all duration-1000 relative group" style="width: 0%"></div>
                            <div id="bar-basic" class="h-full bg-gradient-to-r from-green-400 to-emerald-500 transition-all duration-1000 relative group" style="width: 0%"></div>
                            <div id="bar-pending" class="h-full bg-slate-300 transition-all duration-1000 relative group" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- User Directory -->
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm flex flex-col h-[500px]">
                        <div class="p-5 border-b border-slate-200 flex flex-col md:flex-row gap-4 justify-between items-center bg-white sticky top-0 z-20">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center border border-blue-100">
                                    <i class="fa-solid fa-address-book"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm">User Directory</h4>
                                    <p class="text-[10px] text-slate-500 font-medium">Manage access and roles</p>
                                </div>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <div class="relative flex-grow md:w-64">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                    <input type="text" id="admin-search" placeholder="Search users..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:outline-none focus:border-blue-500 focus:bg-white transition shadow-sm font-medium">
                                </div>
                                <button onclick="exportToCSV('users')" class="px-3 py-2 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-sm" title="Export CSV">
                                    <i class="fa-solid fa-download text-slate-400"></i>
                                </button>
                                <button onclick="refreshAdminData()" id="btn-admin-refresh" class="px-3 py-2 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-sm" title="Refresh">
                                    <i class="fa-solid fa-rotate"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex-grow overflow-y-auto custom-scroll relative">
                            <table class="w-full text-left text-xs table-fixed">
                                <thead class="bg-slate-50 sticky top-0 z-10 text-slate-500 font-bold uppercase tracking-wider shadow-sm">
                                    <tr>
                                        <th class="px-6 py-4 border-b border-slate-200 bg-slate-50 w-[30%]">User Profile</th>
                                        <th class="px-6 py-4 border-b border-slate-200 bg-slate-50 w-[20%] text-center">Role</th>
                                        <th class="px-6 py-4 border-b border-slate-200 bg-slate-50 w-[35%]">Status</th>
                                        <th class="px-6 py-4 border-b border-slate-200 bg-slate-50 text-right w-[15%]">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-list" class="divide-y divide-slate-100 bg-white">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB: PAYMENTS (NEW) -->
                <div id="admin-tab-payments" class="admin-tab-content h-full overflow-y-auto custom-scroll p-8 hidden">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 tracking-tight">Payment Verification</h2>
                            <p class="text-sm text-slate-500 font-medium">Review and process premium upgrades</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                             <div class="relative flex-grow md:w-64">
                                <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                <input type="text" id="payment-search" placeholder="Filter transactions..." class="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-xs focus:outline-none focus:border-blue-500 transition shadow-sm font-medium">
                            </div>
                            <button onclick="exportToCSV('payments')" class="px-3 py-2 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-sm">
                                <i class="fa-solid fa-download text-slate-400"></i> Export
                            </button>
                            <button onclick="loadAdminPayments()" class="px-3 py-2 bg-white hover:bg-slate-50 text-blue-600 border border-slate-200 rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-sm">
                                <i class="fa-solid fa-rotate"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm flex flex-col h-[500px]">
                        <div class="flex-grow overflow-x-auto custom-scroll">
                            <table class="w-full text-left text-xs table-fixed">
                                <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase tracking-wider sticky top-0 z-10">
                                    <tr>
                                        <th class="px-6 py-4 bg-slate-50 w-[15%]">Date</th>
                                        <th class="px-6 py-4 bg-slate-50 w-[25%]">User</th>
                                        <th class="px-6 py-4 bg-slate-50 w-[25%]">Reference</th>
                                        <th class="px-6 py-4 bg-slate-50 w-[15%]">Amount</th>
                                        <th class="px-6 py-4 bg-slate-50 text-right w-[20%]">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-payment-list" class="divide-y divide-slate-100 bg-white">
                                    <tr><td colspan="5" class="px-6 py-8 text-center text-slate-400">Loading requests...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: COMMUNICATIONS -->
                <div id="admin-tab-communications" class="admin-tab-content h-full overflow-y-auto custom-scroll p-8 hidden">
                    <div class="max-w-6xl mx-auto h-full flex flex-col">
                        <div class="mb-6 flex justify-between items-end flex-shrink-0">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900 tracking-tight">Broadcast Console</h2>
                                <p class="text-sm text-slate-500 font-medium">Manage system-wide announcements and real-time alerts.</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden flex flex-col lg:flex-row flex-grow mb-4 min-h-0">
                            
                            <!-- Editor Section -->
                            <div class="p-6 lg:p-8 lg:w-5/12 border-b lg:border-b-0 lg:border-r border-slate-100 flex flex-col bg-white relative z-10 overflow-y-auto custom-scroll">
                                <div class="flex items-center justify-between mb-6 flex-shrink-0">
                                    <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                        <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center">
                                            <i class="fa-solid fa-pen-nib text-sm"></i>
                                        </div>
                                        Compose
                                    </h3>
                                    <span class="text-[10px] font-bold text-slate-400 uppercase bg-slate-50 px-2 py-1 rounded-md border border-slate-100 tracking-wider">Draft Mode</span>
                                </div>

                                <form id="announcement-form" class="space-y-5 flex-grow flex flex-col">
                                    
                                    <!-- Style Selector -->
                                    <div class="space-y-2">
                                        <label class="text-xs font-bold text-slate-700 uppercase tracking-wide">Alert Style</label>
                                        <div class="grid grid-cols-2 gap-2">
                                            <label class="cursor-pointer">
                                                <input type="radio" name="ann-style" value="standard" class="peer sr-only" checked onchange="updateAnnouncementPreview()">
                                                <div class="p-2.5 rounded-lg border border-slate-200 bg-slate-50 peer-checked:bg-blue-50 peer-checked:border-blue-300 peer-checked:text-blue-700 text-slate-500 hover:bg-slate-100 transition flex items-center gap-2">
                                                    <i class="fa-solid fa-bullhorn text-xs"></i>
                                                    <span class="text-xs font-bold">Standard</span>
                                                </div>
                                            </label>
                                            <label class="cursor-pointer">
                                                <input type="radio" name="ann-style" value="urgent" class="peer sr-only" onchange="updateAnnouncementPreview()">
                                                <div class="p-2.5 rounded-lg border border-slate-200 bg-slate-50 peer-checked:bg-red-50 peer-checked:border-red-300 peer-checked:text-red-700 text-slate-500 hover:bg-slate-100 transition flex items-center gap-2">
                                                    <i class="fa-solid fa-triangle-exclamation text-xs"></i>
                                                    <span class="text-xs font-bold">Urgent</span>
                                                </div>
                                            </label>
                                            <label class="cursor-pointer">
                                                <input type="radio" name="ann-style" value="maintenance" class="peer sr-only" onchange="updateAnnouncementPreview()">
                                                <div class="p-2.5 rounded-lg border border-slate-200 bg-slate-50 peer-checked:bg-orange-50 peer-checked:border-orange-300 peer-checked:text-orange-700 text-slate-500 hover:bg-slate-100 transition flex items-center gap-2">
                                                    <i class="fa-solid fa-screwdriver-wrench text-xs"></i>
                                                    <span class="text-xs font-bold">Maintenance</span>
                                                </div>
                                            </label>
                                            <label class="cursor-pointer">
                                                <input type="radio" name="ann-style" value="update" class="peer sr-only" onchange="updateAnnouncementPreview()">
                                                <div class="p-2.5 rounded-lg border border-slate-200 bg-slate-50 peer-checked:bg-indigo-50 peer-checked:border-indigo-300 peer-checked:text-indigo-700 text-slate-500 hover:bg-slate-100 transition flex items-center gap-2">
                                                    <i class="fa-solid fa-wand-magic-sparkles text-xs"></i>
                                                    <span class="text-xs font-bold">New Update</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="text-xs font-bold text-slate-700 mb-1.5 block uppercase tracking-wide">Headline</label>
                                        <input type="text" id="ann-input-title" oninput="updateAnnouncementPreview()" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition placeholder-slate-300" placeholder="e.g. System Notice">
                                    </div>
                                    
                                    <div class="flex-grow">
                                        <label class="text-xs font-bold text-slate-700 mb-1.5 block uppercase tracking-wide">Message Content</label>
                                        <textarea id="ann-input-message" oninput="updateAnnouncementPreview()" class="w-full min-h-[150px] p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition placeholder-slate-300 resize-none leading-relaxed" placeholder="Write your announcement here... HTML tags are supported for links and formatting."></textarea>
                                    </div>

                                    <div class="flex gap-3 pt-4 border-t border-slate-50 mt-auto">
                                        <button type="button" onclick="saveAnnouncement(false)" id="btn-ann-clear" class="px-5 py-3 bg-white hover:bg-red-50 text-slate-500 hover:text-red-600 font-bold rounded-xl text-xs transition border border-slate-200 hover:border-red-200 shadow-sm">
                                            Clear
                                        </button>
                                        <button type="button" onclick="saveAnnouncement(true)" id="btn-ann-pub" class="flex-grow bg-slate-900 hover:bg-blue-600 text-white font-bold py-3 rounded-xl text-xs transition shadow-lg shadow-slate-900/10 hover:shadow-blue-600/20 flex items-center justify-center gap-2 transform active:scale-95">
                                            <i class="fa-solid fa-paper-plane"></i> Push Live Update
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Preview Section -->
                            <div class="p-8 lg:w-7/12 bg-slate-50/80 flex flex-col relative overflow-hidden justify-center items-center">
                                <!-- Background Decoration -->
                                <div class="absolute inset-0 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px] opacity-50"></div>
                                <div class="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-blue-100 rounded-full blur-3xl opacity-50"></div>
                                <div class="absolute bottom-0 left-0 -ml-20 -mb-20 w-64 h-64 bg-indigo-100 rounded-full blur-3xl opacity-50"></div>
                                
                                <div class="relative z-10 w-full max-w-sm">
                                    <div class="flex justify-between items-center mb-4 px-1">
                                        <h3 class="font-bold text-slate-400 text-xs uppercase tracking-widest flex items-center gap-2">
                                            <i class="fa-solid fa-mobile-screen"></i> User Preview
                                        </h3>
                                        <div class="flex gap-1.5">
                                            <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
                                            <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
                                        </div>
                                    </div>

                                    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/50 p-1 ring-1 ring-slate-900/5 transition-all duration-300">
                                        <div class="bg-white rounded-xl overflow-hidden shadow-inner border border-slate-100 flex flex-col">
                                            <!-- Fake App Header -->
                                            <div class="h-12 bg-slate-900 flex items-center justify-between px-4 flex-shrink-0">
                                                <div class="w-16 h-2 bg-slate-700 rounded-full opacity-50"></div>
                                                <div class="flex gap-2">
                                                    <div class="w-2 h-2 rounded-full bg-slate-700 opacity-50"></div>
                                                    <div class="w-2 h-2 rounded-full bg-slate-700 opacity-50"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- The Actual Preview Container -->
                                            <div class="p-6 min-h-[300px] flex items-center justify-center bg-slate-50 relative overflow-y-auto" id="admin-global-preview">
                                                <!-- Content injected by JS -->
                                                <div class="text-center opacity-40 scale-90">
                                                    <i class="fa-solid fa-bullhorn text-3xl text-slate-300 mb-2"></i>
                                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">No Active Announcement</p>
                                                </div>
                                            </div>
                                            
                                            <!-- Fake App Footer -->
                                            <div class="h-10 border-t border-slate-100 bg-white flex items-center justify-around px-6 flex-shrink-0">
                                                <div class="w-4 h-4 rounded-sm bg-slate-200"></div>
                                                <div class="w-4 h-4 rounded-sm bg-slate-200"></div>
                                                <div class="w-4 h-4 rounded-sm bg-slate-200"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <p class="text-center text-[10px] text-slate-400 font-medium mt-6 bg-white/50 py-1 px-3 rounded-full w-fit mx-auto border border-slate-200/50">
                                        Reflects immediately for all active users
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: CONTENT MANAGER -->
                <div id="admin-tab-content" class="admin-tab-content h-full overflow-y-auto custom-scroll p-8 hidden">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 tracking-tight">Content Management</h2>
                            <p class="text-sm text-slate-500 font-medium">Manage AI tools and resources</p>
                        </div>
                        <button id="refresh-tools-btn" class="text-xs font-bold text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-rotate"></i> Refresh Data
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Basic Tools List -->
                        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm flex flex-col h-[500px]">
                            <div class="p-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center sticky top-0 z-10">
                                <h4 class="font-bold text-slate-700 text-xs uppercase tracking-wide">
                                    <i class="fa-solid fa-cube text-blue-500 mr-2"></i> Basic Tools
                                </h4>
                                <span id="count-basic" class="bg-white border border-slate-200 text-slate-600 px-2 py-0.5 rounded text-[10px] font-bold shadow-sm">0</span>
                            </div>
                            <div id="list-basic-tools" class="flex-grow overflow-y-auto custom-scroll p-2 space-y-2 bg-slate-50/50">
                                <div class="p-4 text-center text-slate-400 text-xs">Loading...</div>
                            </div>
                            <div class="p-3 border-t border-slate-200 bg-white">
                                <a href="https://docs.google.com/spreadsheets/d/1p69v6YNSjn8n7IrW9h0Qk9get61eh-ONYNxaMz76RFA/edit#gid=0" target="_blank" class="block w-full py-2.5 text-center text-[10px] font-bold text-blue-600 hover:bg-blue-50 rounded-lg transition border border-blue-200 border-dashed hover:border-blue-300">
                                    <i class="fa-solid fa-plus mr-1"></i> Add Basic Tool (Sheet1)
                                </a>
                            </div>
                        </div>

                        <!-- Premium Tools List -->
                        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm flex flex-col h-[500px]">
                            <div class="p-4 border-b border-slate-200 bg-yellow-50/50 flex justify-between items-center sticky top-0 z-10">
                                <h4 class="font-bold text-yellow-800 text-xs uppercase tracking-wide">
                                    <i class="fa-solid fa-crown text-yellow-600 mr-2"></i> Premium Tools
                                </h4>
                                <span id="count-premium" class="bg-white border border-yellow-200 text-yellow-800 px-2 py-0.5 rounded text-[10px] font-bold shadow-sm">0</span>
                            </div>
                            <div id="list-premium-tools" class="flex-grow overflow-y-auto custom-scroll p-2 space-y-2 bg-slate-50/50">
                                <div class="p-4 text-center text-slate-400 text-xs">Loading...</div>
                            </div>
                            <div class="p-3 border-t border-slate-200 bg-white">
                                <a href="https://docs.google.com/spreadsheets/d/1p69v6YNSjn8n7IrW9h0Qk9get61eh-ONYNxaMz76RFA/edit#gid=1355823203" target="_blank" class="block w-full py-2.5 text-center text-[10px] font-bold text-purple-600 hover:bg-purple-50 rounded-lg transition border border-purple-200 border-dashed hover:border-purple-300">
                                    <i class="fa-solid fa-plus mr-1"></i> Add Premium Tool (PAID USERS)
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- EDIT USER MODAL (ADMIN ONLY) -->
    <div id="admin-edit-modal" class="fixed inset-0 z-[260] bg-black/50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform scale-95 transition-all">
            <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-user-pen text-blue-600"></i> Edit User
            </h3>
            
            <form id="admin-edit-form" class="space-y-4">
                <input type="hidden" id="edit-username-hidden">
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Username</label>
                    <input type="text" id="edit-username-display" disabled class="w-full mt-1 p-2 bg-slate-100 border border-slate-200 rounded-lg text-sm text-slate-500 font-bold">
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Role</label>
                    <select id="edit-role" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-lg text-sm focus:border-blue-500 focus:outline-none">
                        <option value="New User">New User (Pending)</option>
                        <option value="Basic User">Basic User</option>
                        <option value="Paid User">Paid User (Premium)</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>

                <!-- NEW: Premium Duration Options -->
                <div id="premium-options" class="hidden space-y-2 bg-yellow-50 p-3 rounded-lg border border-yellow-200 mt-2 transition-all">
                    <p class="text-[10px] font-bold text-yellow-800 uppercase flex items-center gap-1">
                        <i class="fa-solid fa-clock"></i> Select Subscription Duration
                    </p>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" onclick="setPremiumDuration(3, this)" class="duration-btn px-2 py-2 bg-white border border-yellow-300 text-yellow-700 rounded text-xs font-bold hover:bg-yellow-100 transition shadow-sm">3 Months</button>
                        <button type="button" onclick="setPremiumDuration(6, this)" class="duration-btn px-2 py-2 bg-white border border-yellow-300 text-yellow-700 rounded text-xs font-bold hover:bg-yellow-100 transition shadow-sm">6 Months</button>
                        <button type="button" onclick="setPremiumDuration(9, this)" class="duration-btn px-2 py-2 bg-white border border-yellow-300 text-yellow-700 rounded text-xs font-bold hover:bg-yellow-100 transition shadow-sm">9 Months</button>
                        <button type="button" onclick="setPremiumDuration(12, this)" class="duration-btn px-2 py-2 bg-white border border-yellow-300 text-yellow-700 rounded text-xs font-bold hover:bg-yellow-100 transition shadow-sm">1 Year</button>
                    </div>
                    <input type="hidden" id="edit-start-date">
                    <input type="hidden" id="edit-expiration-date">
                    <div id="date-preview" class="hidden mt-2 pt-2 border-t border-yellow-200 text-[10px] text-yellow-800 font-mono">
                        <p>Start: <span id="preview-start" class="font-bold"></span></p>
                        <p>Expires: <span id="preview-end" class="font-bold"></span></p>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Personal Message</label>
                    <textarea id="edit-message" rows="3" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-lg text-sm focus:border-blue-500 focus:outline-none" placeholder="Enter message for this user..."></textarea>
                    
                    <div class="mt-2 space-y-2">
                        <div class="flex justify-between items-center">
                            <p class="text-[10px] text-slate-400">Quick Insert:</p>
                            <p id="insert-status" class="text-[10px] font-bold h-4 transition-colors duration-300"></p>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" onclick="insertThankYouMessage()" class="flex-1 text-[10px] font-bold text-green-600 hover:text-green-700 bg-green-50 hover:bg-green-100 border border-green-200 px-2 py-2 rounded-lg transition flex items-center justify-center gap-1 shadow-sm hover:shadow-md">
                                <i class="fa-solid fa-hand-holding-heart"></i> Thank You
                            </button>
                            <button type="button" onclick="insertExpirationMessage()" class="flex-1 text-[10px] font-bold text-pink-600 hover:text-pink-700 bg-pink-50 hover:bg-pink-100 border border-pink-200 px-2 py-2 rounded-lg transition flex items-center justify-center gap-1 shadow-sm hover:shadow-md">
                                <i class="fa-solid fa-clock-rotate-left"></i> Expiration Notice
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 justify-end pt-4 border-t border-slate-100 mt-2">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 transition shadow-md">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MAINTENANCE / WELLNESS MODE SCREEN -->
    <div id="maintenance-screen" class="hidden min-h-[80vh] flex-col items-center justify-center text-center p-6 relative z-40">
        <div class="max-w-2xl w-full bg-white rounded-3xl shadow-2xl p-10 md:p-16 relative overflow-hidden border border-slate-100 ring-8 ring-slate-50">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-deped-blue via-deped-red to-deped-yellow"></div>
            <div class="absolute -bottom-20 -right-20 w-64 h-64 bg-blue-50 rounded-full blur-3xl opacity-50 pointer-events-none"></div>
            
            <div class="mb-8 relative inline-block">
                <div class="absolute inset-0 bg-yellow-100 rounded-full animate-ping opacity-20"></div>
                <div class="w-24 h-24 bg-yellow-50 rounded-full flex items-center justify-center text-yellow-500 text-5xl border border-yellow-100 shadow-sm relative z-10">
                    <i class="fa-solid fa-screwdriver-wrench animate-pulse"></i>
                </div>
            </div>

            <h1 id="maintenance-title" class="text-3xl md:text-4xl font-bold text-slate-800 mb-4 tracking-tight">System Maintenance</h1>
            
            <p id="maintenance-message" class="text-slate-600 text-lg leading-relaxed mb-8">
                We are currently performing scheduled upgrades to enhance platform performance and reliability.
            </p>

            <div class="bg-slate-50 rounded-2xl p-6 border border-slate-100 mb-8">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Estimated Completion</p>
                <div id="wellness-countdown" class="text-3xl font-mono font-bold text-deped-blue">Calculating...</div>
                <p id="wellness-hours-text" class="text-xs text-slate-400 mt-2 font-medium"></p>
            </div>
        </div>
    </div>

    <!-- Unified Community Hub Section -->
    <section id="community" class="hidden py-24 relative border-y border-slate-200 bg-slate-50 transition-colors duration-700">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-3xl md:text-4xl font-bold transition-colors duration-700 mb-4 font-sans section-title text-slate-800">Teacher Community Hub</h2>
                <div class="h-1.5 w-24 bg-deped-blue mx-auto rounded-full"></div>
                <p class="mt-4 transition-colors duration-700 section-desc text-slate-600">See what others are saying and share your own story!</p>
            </div>

            <div class="reveal max-w-2xl mx-auto">
                <div class="bg-white rounded-[2rem] shadow-xl border border-slate-200 h-[650px] flex flex-col relative overflow-hidden ring-8 ring-slate-100 transition-all duration-700" id="chat-container">
                    
                    <div class="bg-white/95 backdrop-blur-md p-4 border-b border-slate-200 flex items-center justify-between sticky top-0 z-20">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-deped-blue flex items-center justify-center shadow-sm">
                                <i class="fa-solid fa-heart"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">Community Wall</h3>
                                <div class="flex items-center gap-1.5">
                                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                    <p class="text-[10px] text-slate-500 uppercase tracking-wider font-bold">Live Feed</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-400 transition"><i class="fa-solid fa-ellipsis"></i></button>
                        </div>
                    </div>

                    <div id="stories-grid" class="flex-grow overflow-y-auto p-4 md:p-6 chat-pattern space-y-6 custom-scroll bg-slate-50/50">
                        <div class="text-center py-20 opacity-80">
                            <div class="relative w-12 h-12 mx-auto mb-3">
                                <div class="absolute inset-0 bg-blue-100 rounded-full animate-ping opacity-75"></div>
                                <img src="https://ui-avatars.com/api/?name=DA&background=1e3a8a&color=fff&size=128&rounded=true&bold=true" class="relative z-10 w-12 h-12 rounded-full shadow-md border-2 border-white animate-pulse">
                            </div>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Loading Community...</p>
                        </div>
                    </div>
                    
                    <div class="px-4 py-2 bg-gradient-to-b from-transparent to-white/80">
                        <button id="loadMoreBtn" class="hidden w-full text-center text-xs font-bold text-slate-400 py-2 hover:text-deped-blue transition uppercase tracking-widest">
                            <i class="fa-solid fa-clock-rotate-left mr-1"></i> Load older messages
                        </button>
                    </div>

                    <div id="chat-input-area" class="hidden bg-white p-4 z-20 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.05)] relative border-t border-slate-100">
                         <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
                         
                         <form id="contactForm" 
                              action="https://docs.google.com/forms/d/e/1FAIpQLSeX6DQW6JTdMVN_lmBqe-m4izcFGiTyhPf2uYqQ5GgVmpf37Q/formResponse" 
                              method="POST" 
                              target="hidden_iframe"
                              class="relative">
                             
                             <div id="errorMessage" class="hidden absolute -top-10 left-0 right-0 mx-auto w-fit bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm animate-bounce text-center">
                                <i class="fa-solid fa-circle-exclamation mr-1"></i> Please keep messages friendly!
                             </div>

                             <div class="bg-slate-50 p-1.5 rounded-[1.5rem] border border-slate-200 focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300 transition-all shadow-inner">
                                 <div class="flex flex-col px-2 pt-2">
                                     <div class="flex items-center gap-2 border-b border-slate-200 pb-2 mb-2">
                                        <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center"><i class="fa-solid fa-user text-[10px] text-slate-500"></i></div>
                                        <input type="text" id="name" name="entry.385038069" required 
                                            class="text-xs font-bold text-slate-700 bg-transparent outline-none placeholder-slate-400 w-full" 
                                            placeholder="Your Name">
                                     </div>
                                     <div class="flex items-end gap-2">
                                         <div class="relative w-full">
                                             <textarea id="message" name="entry.1499916649" rows="1" required maxlength="300"
                                                 class="text-sm text-slate-700 bg-transparent outline-none resize-none placeholder-slate-400 w-full mb-1 max-h-24 pb-4" 
                                                 placeholder="Share your message..."
                                                 oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 100) + 'px'; document.getElementById('char-count').innerText = this.value.length + '/300';"></textarea>
                                             <div id="char-count" class="absolute bottom-1 right-0 text-[10px] text-slate-400 font-mono pointer-events-none">0/300</div>
                                         </div>
                                         
                                         <button type="submit" id="sendBtn" class="w-10 h-10 rounded-full bg-deped-blue text-white flex-shrink-0 flex items-center justify-center shadow-md hover:bg-blue-700 transition transform active:scale-95 mb-1">
                                             <i class="fa-solid fa-paper-plane text-xs"></i>
                                         </button>
                                     </div>
                                 </div>
                             </div>
                         </form>
                    </div>

                    <div id="chat-guest-prompt" class="bg-white p-8 z-20 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.05)] relative border-t border-slate-100 text-center flex flex-col items-center justify-center">
                        <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mb-3 text-deped-blue shadow-sm border border-blue-100">
                            <i class="fa-solid fa-comments"></i>
                        </div>
                        <h4 class="font-bold text-slate-800 mb-1">Join the Conversation</h4>
                        <p class="text-xs text-slate-500 mb-4 max-w-xs leading-relaxed">Log in to share your thoughts, ideas, and stories with fellow teachers.</p>
                        <button class="trigger-login-chat px-6 py-2.5 bg-deped-blue text-white rounded-xl font-bold text-xs hover:bg-blue-800 transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            Log In to Chat
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-300 py-20 border-t border-slate-800 relative overflow-hidden">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-3xl h-full bg-blue-900/20 blur-[100px] rounded-full pointer-events-none"></div>
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-900 to-transparent opacity-30"></div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-12 lg:gap-16 mb-16 items-start">
                
                <div class="space-y-6">
                    <div class="flex items-center space-x-3">
                        <div class="relative group">
                            <div class="absolute inset-0 bg-blue-500 blur rounded-full opacity-20 group-hover:opacity-40 transition duration-500"></div>
                            <img src="https://ui-avatars.com/api/?name=Digital+AI&background=1e3a8a&color=fff&size=64&rounded=true&bold=true" 
                                 alt="Digital AI Vision for Education Logo" 
                                 class="h-12 w-12 rounded-full border-2 border-slate-700 relative z-10">
                        </div>
                        <div>
                            <h4 class="text-white font-bold text-lg leading-tight">Digital AI Vision for Education</h4>
                            <p class="text-[10px] text-blue-400 uppercase tracking-widest font-bold">Official Release</p>
                        </div>
                    </div>
                    <p class="text-sm text-slate-400 leading-relaxed max-w-xs">
                        An independent, non-profit initiative dedicated to empowering Filipino teachers with accessible, cutting-edge technology. 
                    </p>
                    <div class="flex space-x-3 pt-2">
                        <a href="https://www.facebook.com/y2k2009/" class="w-9 h-9 rounded-lg bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400 hover:bg-blue-600 hover:text-white hover:border-blue-500 transition-all duration-300 group">
                            <i class="fa-brands fa-facebook-f transform group-hover:scale-110 transition"></i>
                        </a>
                        <a href="#" class="w-9 h-9 rounded-lg bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400 hover:bg-sky-500 hover:text-white hover:border-sky-400 transition-all duration-300 group">
                            <i class="fa-brands fa-twitter transform group-hover:scale-110 transition"></i>
                        </a>
                        <a href="#" class="w-9 h-9 rounded-lg bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400 hover:bg-pink-600 hover:text-white hover:border-pink-500 transition-all duration-300 group">
                            <i class="fa-brands fa-instagram transform group-hover:scale-110 transition"></i>
                        </a>
                    </div>
                </div>
                
                <div class="md:pl-8">
                    <h4 class="text-blue-400 text-xs font-bold uppercase tracking-widest mb-6 flex items-center gap-2">
                        <span class="w-8 h-[1px] bg-blue-500/50"></span> Navigate
                    </h4>
                    
                    <ul class="space-y-3">
                        <li>
                            <a href="#home" class="group flex items-center text-sm text-slate-400 hover:text-white transition-colors duration-300">
                                <span class="w-1.5 h-1.5 rounded-full bg-slate-700 mr-3 group-hover:bg-blue-500 transition-colors"></span>
                                Home
                            </a>
                        </li>
                        <li>
                            <a href="#tools" class="group flex items-center text-sm text-slate-400 hover:text-white transition-colors duration-300">
                                <span class="w-1.5 h-1.5 rounded-full bg-slate-700 mr-3 group-hover:bg-blue-500 transition-colors"></span>
                                AI Tools
                            </a>
                        </li>
                        <li>
                            <a href="#about" class="group flex items-center text-sm text-slate-400 hover:text-white transition-colors duration-300">
                                <span class="w-1.5 h-1.5 rounded-full bg-slate-700 mr-3 group-hover:bg-blue-500 transition-colors"></span>
                                Our Mission
                            </a>
                        </li>
                        <li>
                            <a href="#community" class="group flex items-center text-sm text-slate-400 hover:text-white transition-colors duration-300">
                                <span class="w-1.5 h-1.5 rounded-full bg-slate-700 mr-3 group-hover:bg-blue-500 transition-colors"></span>
                                Community Hub
                            </a>
                        </li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-blue-400 text-xs font-bold uppercase tracking-widest mb-6 flex items-center gap-2">
                        <span class="w-8 h-[1px] bg-blue-500/50"></span> Developer Support
                    </h4>
                    
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-1 border border-slate-700/50 shadow-lg group hover:border-blue-500/30 transition-colors duration-500">
                        <div class="bg-slate-900/80 rounded-xl p-5 backdrop-blur-sm relative overflow-hidden">
                            <div class="absolute -top-10 -right-10 w-20 h-20 bg-blue-500/10 rounded-full blur-xl group-hover:bg-blue-500/20 transition duration-500"></div>

                            <h5 class="text-white font-bold mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-mug-hot text-yellow-500"></i> Buy me a coffee?
                            </h5>
                            <p class="text-xs text-slate-400 mb-4 leading-relaxed">
                                Helps keep the servers running and the tools free for everyone.
                            </p>
                            
                            <button id="support-toggle" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold py-2.5 px-4 rounded-lg border border-slate-700 transition-all flex items-center justify-between group-hover:text-white">
                                <span>View GCash QR</span>
                                <i id="support-icon" class="fa-solid fa-chevron-down text-[10px]"></i>
                            </button>

                            <div id="support-content" class="hidden mt-3 pt-3 border-t border-slate-800/50 transition-all duration-300">
                                <div class="relative rounded-lg overflow-hidden border border-slate-700 bg-white">
                                    <img src="gcash.jpg" 
                                         id="support-img"
                                         onerror="this.onerror=null; this.src='https://placehold.co/400x400/1e293b/fbbf24?text=GCash+QR';" 
                                         alt="Support via GCash" 
                                         class="w-full h-auto opacity-90 hover:opacity-100 hover:scale-105 transition duration-500 cursor-zoom-in">
                                </div>
                                <p class="text-[10px] text-center text-slate-500 mt-2">Click QR to enlarge</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-slate-800/50 pt-8 flex flex-col items-center justify-center text-center relative z-10">
                <p class="text-slate-500 text-sm mb-6">&copy; 2026 Digital AI Vision for Education. All rights reserved.</p>
                
                <div class="group relative inline-flex items-center gap-2 px-6 py-3 bg-slate-900/80 rounded-full border border-slate-700/50 hover:border-blue-500/40 transition-all duration-500 shadow-lg hover:shadow-blue-500/10 hover:-translate-y-1 cursor-default">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-blue-500/5 to-transparent opacity-0 group-hover:opacity-100 transition duration-700 rounded-full"></div>
                    
                    <span class="text-xs text-slate-400 font-medium relative z-10">Created by</span>
                    
                    <span class="relative z-10 font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-blue-200 to-blue-400 animate-pulse group-hover:animate-none transition-all duration-300">
                        DAVID JESS F. ASAURO
                    </span>
                    
                    <i class="fa-solid fa-code text-blue-500 text-[10px] opacity-0 group-hover:opacity-100 -translate-x-2 group-hover:translate-x-0 transition-all duration-300"></i>
                </div>
            </div>
        </div>
    </footer>

    <!-- Full Screen Image Modal -->
    <div id="image-modal" class="fixed inset-0 z-[200] bg-black/95 hidden flex items-center justify-center p-4 cursor-zoom-out transition-opacity duration-300 opacity-0 backdrop-blur-sm">
        <img id="modal-img" src="" alt="Full Screen Support" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl transform scale-95 transition-transform duration-300 border-2 border-yellow-500">
        <p class="absolute bottom-10 text-white/50 text-sm animate-pulse">Click anywhere to close</p>
    </div>

    <!-- SECRET CREDITS OVERLAY (Shift + F10) -->
    <div id="credits-overlay" class="fixed inset-0 z-[300] bg-slate-900/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl p-8 max-w-md w-full text-center relative shadow-[0_0_50px_rgba(30,58,138,0.5)] transform scale-95 opacity-0 transition-all duration-500" id="credits-card">
            
            <button id="close-credits" class="absolute top-4 right-4 text-slate-500 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            
            <div class="mb-8 relative inline-block">
                <div class="absolute inset-0 bg-blue-500 blur-xl opacity-20 rounded-full animate-pulse"></div>
                <i class="fa-solid fa-code text-5xl text-blue-400 relative z-10 animate-float"></i>
            </div>

            <div class="space-y-8 font-mono">
                <div class="space-y-1">
                    <p class="text-[10px] uppercase tracking-[0.3em] text-slate-500 font-bold">System Identity</p>
                    <h2 class="text-2xl font-bold text-white tracking-tight">Digital AI Vision for Education</h2>
                </div>

                <div class="space-y-2">
                    <p class="text-[10px] uppercase tracking-[0.3em] text-slate-500 font-bold">Lead Developer & Author</p>
                    <div class="relative inline-block px-6 py-2 border border-blue-500/30 rounded-lg bg-blue-900/20">
                        <p class="text-xl font-bold text-blue-300 tracking-wider">DAVID JESS F. ASAURO</p>
                    </div>
                </div>

                <div class="space-y-1">
                    <p class="text-[10px] uppercase tracking-[0.3em] text-slate-500 font-bold">Build Date</p>
                    <p class="text-lg font-bold text-yellow-400">December 21, 2025</p>
                </div>
            </div>

            <div class="mt-10 pt-6 border-t border-slate-800">
                <p class="text-[10px] text-slate-600 uppercase tracking-widest">© 2025 All Rights Reserved</p>
            </div>
        </div>
    </div>

    <!-- Logic Script -->
    <script>
        // --- SYSTEM CONFIGURATION ---
        // Adjust these numbers to match your Google Sheet Columns (0 = A, 1 = B, 2 = C, etc.)
        const SHEET_COLUMNS = {
            USERNAME: 1,      // Column B (Default: Username)
            PASSWORD: 2,      // Column C (Default: Password)
            ROLE: 3,          // Column D (Default: Role)
            MESSAGE: 4,       // Column E (Default: Personal Message)
            FULLNAME: 0,      // Column F (New: Full Name)
            SEC_QUESTION: 6,  // Column G (Security Question)
            SEC_ANSWER: 7,    // Column H (Security Answer)
            START_DATE: 8,    // Column I (Start/Approval Date)
            EXPIRATION: 9,    // Column J (Expiration Date)
            MSG_TIMESTAMP: 10 // Column K (Message Timestamp)
        };

        // --- GLOBAL STATE TRACKER ---
        let currentAdminFilterType = 'all';

        // --- HELPER: Session Management (Supports Remember Me) ---
        function getSession() {
            // Check Local Storage (Persistent)
            const local = localStorage.getItem('ai_school_session');
            if (local) return JSON.parse(local);
            
            // Check Session Storage (Temporary)
            const session = sessionStorage.getItem('ai_school_session');
            if (session) return JSON.parse(session);
            
            return null;
        }

        // --- HELPER: Filter Logic ---
        function getFilteredUsers(users, type) {
             if (!users) return [];
             if (type === 'all') return users;
             if (type === 'pending') return users.filter(u => u.role.toLowerCase() === 'new user');
             if (type === 'premium') return users.filter(u => u.role.toLowerCase().includes('paid'));
             if (type === 'basic') return users.filter(u => u.role.toLowerCase().includes('basic') || u.role.toLowerCase().includes('local'));
             if (type === 'expired') {
                 const now = new Date();
                 const nextWeek = new Date();
                 nextWeek.setDate(now.getDate() + 7); // Look ahead 7 days
                 
                 return users.filter(u => u.expiration && new Date(u.expiration) < nextWeek);
             }
             return users;
        }

        // Force dismiss loader on error to prevent hanging
        window.addEventListener('error', () => {
             const loader = document.getElementById('initial-loader');
             if(loader) loader.style.display = 'none';
        });

        // Robust Loader Dismissal
        const dismissLoader = () => {
             const loader = document.getElementById('initial-loader');
             if(loader && !loader.classList.contains('opacity-0')) {
                 loader.classList.add('opacity-0');
                 setTimeout(() => loader.remove(), 700);
             }
        };
        // Absolute failsafe
        setTimeout(dismissLoader, 5000);

        // Helper to parse Gviz Date or Strings
        function parseGvizDate(val) {
             if (!val) return null;
             const strVal = String(val).trim();
             
             // 1. Gviz Date Object: "Date(2025, 11, 25, 8, 0, 0)"
             if (strVal.startsWith('Date(')) {
                 const nums = strVal.match(/\d+/g);
                 if (nums && nums.length >= 3) {
                     // Month is 0-indexed in JS Date
                     const y = parseInt(nums[0]);
                     const m = parseInt(nums[1]);
                     const d = parseInt(nums[2]);
                     const h = nums.length > 3 ? parseInt(nums[3]) : 0;
                     const min = nums.length > 4 ? parseInt(nums[4]) : 0;
                     const s = nums.length > 5 ? parseInt(nums[5]) : 0;
                     return new Date(y, m, d, h, min, s);
                 }
             }
             
             // 2. Standard JS Date (Prioritize MDY/ISO which preserves time)
             const tryDate = new Date(strVal);
             if (!isNaN(tryDate.getTime())) {
                 return tryDate;
             }
             
             // 3. Fallback: Explicit DD/MM/YYYY Handler
             const dmyMatch = strVal.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
             if (dmyMatch) {
                 const d = parseInt(dmyMatch[1]);
                 const m = parseInt(dmyMatch[2]) - 1; // Month 0-indexed
                 const y = parseInt(dmyMatch[3]);
                 const h = dmyMatch[4] ? parseInt(dmyMatch[4]) : 0;
                 const min = dmyMatch[5] ? parseInt(dmyMatch[5]) : 0;
                 const s = dmyMatch[6] ? parseInt(dmyMatch[6]) : 0;
                 return new Date(y, m, d, h, min, s);
             }

             return null;
        }

        // NEW: Time Ago Helper for "Real Time" feel
        function timeAgo(dateParam) {
            if (!dateParam) return 'Just now';
            const date = typeof dateParam === 'object' ? dateParam : new Date(dateParam);
            const today = new Date();
            const seconds = Math.round((today - date) / 1000);
            const minutes = Math.round(seconds / 60);
            const hours = Math.round(minutes / 60);
            const days = Math.round(hours / 24);

            if (seconds < 10) return 'Just now';
            if (seconds < 60) return `${seconds} seconds ago`;
            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            if (days < 7) return `${days} day${days !== 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' at ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        // 1. Mobile Menu Toggle
        const btn = document.getElementById('mobile-menu-btn');
        const menu = document.getElementById('mobile-menu');

        if(btn && menu){
            btn.addEventListener('click', () => {
                menu.classList.toggle('hidden');
            });
            const mobileLinks = menu.querySelectorAll('a');
            mobileLinks.forEach(link => {
                link.addEventListener('click', () => {
                    menu.classList.add('hidden');
                });
            });
        }

        // 2. Scroll Animation
        const observerOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.1
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                }
            });
        }, observerOptions);

        const revealElements = document.querySelectorAll('.reveal');
        revealElements.forEach(el => observer.observe(el));

        // 3. Contact Form Handler
        const COOLDOWN_MS = 5 * 60 * 1000; // 5 Minutes
        const STORAGE_KEY = 'ai_school_cooldown_target_v2'; 
        
        // Caching Configuration
        const CACHE_CONFIG = {
            STORIES: { KEY: 'ai_school_stories_data_v1', TS: 'ai_school_stories_ts_v1' },
            TOOLS: { KEY: 'ai_school_tools_data_v1', TS: 'ai_school_tools_ts_v1' }, 
            APPS: { KEY: 'ai_school_apps_data_v1', TS: 'ai_school_apps_ts_v1' },   
            USERS: { KEY: 'ai_school_users_data_v1', TS: 'ai_school_users_ts_v1' },
            TTL: 60000 // 60 Seconds
        };

        const foulWords = [
            "bobo", "tanga", "gago", "ulol", "tarantado", "putangina", "pukingina", "tangina", "kupal", "kantot",
            "pota", "ina mo", "hayop", "gaga", "pakyu", "burat", "etits", "pepe", "kepiyas", "jakol", "hindot", 
            "pucha", "leche", "gagi", "buwisit", "bwisit", "hayuf", "demonyo", "lintik", "ungas", "abnoy", 
            "baliw", "sira ulo", "inutil", "ogag", "pakshet", "tite", "bilat",
            "shit", "fuck", "damn", "bitch", "asshole", "stupid", "idiot", "kiss my ass", "ass", "fucker",
            "bullshit", "crap", "bastard", "dick", "cock", "pussy", "vagina", "penis", "sex", "porn", "xxx", 
            "nigger", "nigga", "slut", "whore", "cunt", "arse", "motherfucker", "son of a bitch", "retard"
        ];

        function hasFoulLanguage(text) {
            return foulWords.some(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                return regex.test(text);
            });
        }

        function startTimer(btn, targetTimestamp) {
            btn.disabled = true;
            btn.classList.add('bg-slate-400', 'cursor-not-allowed');
            btn.classList.remove('bg-deped-blue', 'hover:bg-blue-700', 'active:scale-95');
            
            if (btn.dataset.timerId) clearInterval(parseInt(btn.dataset.timerId));

            const updateDisplay = () => {
                const now = Date.now();
                const remaining = targetTimestamp - now;

                if (remaining <= 0) {
                    clearInterval(parseInt(btn.dataset.timerId));
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-paper-plane text-xs"></i>';
                    btn.classList.remove('bg-slate-400', 'cursor-not-allowed');
                    btn.classList.add('bg-deped-blue', 'hover:bg-blue-700', 'active:scale-95');
                    localStorage.removeItem(STORAGE_KEY);
                } else {
                    const minutes = Math.floor((remaining / 1000) / 60);
                    const seconds = Math.floor((remaining / 1000) % 60);
                    btn.innerHTML = `<span class="text-[10px] font-bold font-mono">${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
                }
            };

            updateDisplay(); 
            const interval = setInterval(updateDisplay, 1000);
            btn.dataset.timerId = interval; 
        }

        function checkCooldown(btn) {
            const storedTarget = localStorage.getItem(STORAGE_KEY);
            if (!storedTarget) return;

            const targetTime = parseInt(storedTarget);
            const now = Date.now();
            
            if (targetTime > now) {
                startTimer(btn, targetTime);
            } else {
                localStorage.removeItem(STORAGE_KEY);
            }
        }

        // 5. FETCH STORIES
        let allStories = [];
        let storiesDisplayed = 0;
        let currentSpotlightIndex = 0;
        let spotlightInterval;
        
        let scheduledWellness = null; 
        let maintenanceText = null;
        let globalNotification = null;
        let currentPersonalMessage = null; 

        let countdownInterval = null; 
        const BATCH_SIZE = 10; 
        
        let lastStoriesHash = "";
        let lastConfigHash = "";
        let lastAppsHash = ""; 
        let lastStoryCount = 0; 

        async function fetchStories(forceRefresh = false) {
            const sheetId = '1p69v6YNSjn8n7IrW9h0Qk9get61eh-ONYNxaMz76RFA';
            const gid = '1355823203';
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&tq&gid=${gid}`;

            try {
                let rows = null;
                const now = Date.now();
                const cachedData = localStorage.getItem(CACHE_CONFIG.STORIES.KEY);
                const cachedTs = localStorage.getItem(CACHE_CONFIG.STORIES.TS);

                if (!forceRefresh && cachedData && cachedTs && (now - parseInt(cachedTs) < CACHE_CONFIG.TTL)) {
                    rows = JSON.parse(cachedData);
                } else {
                    const response = await fetch(url);
                    const text = await response.text();
                    const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                    if (!jsonMatch || !jsonMatch[1]) throw new Error('Invalid GVIZ response');
                    const json = JSON.parse(jsonMatch[1]);
                    rows = json.table.rows;
                    localStorage.setItem(CACHE_CONFIG.STORIES.KEY, JSON.stringify(rows));
                    localStorage.setItem(CACHE_CONFIG.STORIES.TS, now.toString());
                }

                const currentHash = JSON.stringify(rows);
                
                if (rows && rows.length > 0) {
                     const badge = document.getElementById('community-badge');
                     if (badge) {
                         if (lastStoryCount > 0 && rows.length > lastStoryCount) {
                            badge.classList.remove('hidden');
                         }
                         lastStoryCount = rows.length;
                     }
                }

                if (currentHash === lastStoriesHash) return; 
                lastStoriesHash = currentHash;

                const grid = document.getElementById('stories-grid'); 
                if (!grid) return;

                if(rows && rows.length > 0) {
                    allStories = rows.map(row => {
                        if (!row.c) return null;
                        const nameCell = row.c[1];
                        const name = (nameCell && nameCell.v) ? String(nameCell.v) : 'Anonymous';
                        let timestamp = "Recently";
                        let dateGroup = "Unknown Date";
                        const dateCell = row.c[0];
                        if (dateCell) {
                             let dateObj = parseGvizDate(dateCell.v);
                             if(!dateObj && dateCell.f) dateObj = parseGvizDate(dateCell.f); 
                             if (dateObj) {
                                 timestamp = dateObj.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
                                 const today = new Date();
                                 const yesterday = new Date(today);
                                 yesterday.setDate(yesterday.getDate() - 1);
                                 if (dateObj.toDateString() === today.toDateString()) {
                                     dateGroup = "Today";
                                 } else if (dateObj.toDateString() === yesterday.toDateString()) {
                                     dateGroup = "Yesterday";
                                 } else {
                                     dateGroup = dateObj.toLocaleDateString([], {month: 'long', day: 'numeric', year: 'numeric'});
                                 }
                             }
                        }
                        let candidates = [];
                        [2, 3, 4, 5].forEach(i => {
                            const cell = row.c[i];
                            if (cell && cell.v) {
                                const txt = String(cell.v);
                                const isDateLike = txt.startsWith('Date(') || !isNaN(Date.parse(txt)) && txt.length < 20; 
                                if (!txt.includes('@') && !txt.includes('google.com') && !isDateLike && txt.length > 1) {
                                    candidates.push(txt);
                                }
                            }
                        });
                        if (candidates.length === 0) return null;
                        candidates.sort((a, b) => b.length - a.length);
                        const message = candidates[0];
                        return { name, message, timestamp, dateGroup };
                    }).filter(story => story !== null);
                    
                    // --- PERFORMANCE OPTIMIZATION ---
                    // Suggestion Implemented: Cap at latest 300 messages to prevent memory lag
                    if (allStories.length > 300) {
                        allStories = allStories.slice(-300);
                    }
                    // --------------------------------

                    initSpotlight([...allStories].reverse().slice(0, 5));
                    
                    const wasAtBottom = grid.scrollHeight - grid.scrollTop === grid.clientHeight;
                    grid.innerHTML = ''; 
                    storiesDisplayed = BATCH_SIZE; 
                    const initialBatch = allStories.slice(Math.max(allStories.length - BATCH_SIZE, 0));
                    let lastGroup = null;
                    initialBatch.forEach(story => {
                        if (story.dateGroup !== lastGroup) {
                            grid.appendChild(createDateBadge(story.dateGroup));
                            lastGroup = story.dateGroup;
                        }
                        grid.appendChild(createChatBubble(story));
                    });
                    setTimeout(() => grid.scrollTop = grid.scrollHeight, 100);
                    const loadMoreBtn = document.getElementById('loadMoreBtn');
                    if (loadMoreBtn && allStories.length > BATCH_SIZE) { 
                        loadMoreBtn.classList.remove('hidden');
                    }
                } else {
                     grid.innerHTML = '<p class="text-center py-10 text-slate-400 text-xs">No stories yet. Be the first to share!</p>'; 
                }
            } catch (err) {
                console.log('Error', err);
                const grid = document.getElementById('stories-grid');
                if(grid && grid.innerHTML.trim() === "") grid.innerHTML = getStaticStoriesHTML(); 
            }
        }

        async function fetchSystemConfig() {
            const sheetId = '1p69v6YNSjn8n7IrW9h0Qk9get61eh-ONYNxaMz76RFA';
            const sheetName = 'Sheet1';
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}&nocache=${Date.now()}`;

            try {
                let rows = null;
                const res = await fetch(url);
                const text = await res.text();
                const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                if (jsonMatch && jsonMatch[1]) {
                     const json = JSON.parse(jsonMatch[1]);
                     rows = json.table.rows;
                }
                
                if (rows) {
                    localStorage.setItem(CACHE_CONFIG.TOOLS.KEY, JSON.stringify(rows));
                    localStorage.setItem(CACHE_CONFIG.TOOLS.TS, Date.now().toString());

                    const currentHash = JSON.stringify(rows);
                    if (currentHash === lastConfigHash) return;
                    lastConfigHash = currentHash;

                    scheduledWellness = null;
                    globalNotification = null;
                    maintenanceText = null;

                    rows.forEach((row, index) => {
                        if (row.c[3]?.v && row.c[4]?.v) {
                            globalNotification = {
                                title: String(row.c[3].v),
                                message: String(row.c[4].v)
                            };
                        }
                        if (row.c[5] && row.c[6]) {
                            const start = parseGvizDate(row.c[5].v);
                            const end = parseGvizDate(row.c[6].v);
                            if(start && end) {
                                scheduledWellness = { start, end };
                                if(row.c[7]?.v || row.c[8]?.v) {
                                    maintenanceText = {
                                        title: row.c[7]?.v || "System Maintenance Underway",
                                        message: row.c[8]?.v || "We are currently performing scheduled upgrades."
                                    };
                                }
                            }
                        }
                    });
                    
                    checkWellnessTime();
                    showNotification();
                }
            } catch (err) {
                console.error('Error fetching config:', err);
            }
        }

        async function fetchApps() {
            const container = document.getElementById('tools-container');
            const toolsTitle = document.getElementById('tools-title');
            const toolsSubtitle = document.getElementById('tools-subtitle');
            
            // Use unified session helper
            const user = getSession();
            
            if (!user) {
                const currentHash = "locked-state";
                if (currentHash === lastAppsHash) return; 
                lastAppsHash = currentHash;

                if(toolsTitle) toolsTitle.innerText = "Tools for Education";
                if(toolsSubtitle) {
                    toolsSubtitle.innerText = "Powered by Gemini";
                    toolsSubtitle.className = "text-deped-red font-bold text-sm tracking-widest uppercase mb-2 block";
                }
                
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-16 px-4 text-center animate-fadeIn">
                        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-6 shadow-inner">
                            <i class="fa-solid fa-lock text-4xl text-slate-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">Member Access Only</h3>
                        <p class="text-slate-500 max-w-md mb-8">
                            These curriculum-aligned AI tools are exclusive to registered members. 
                            Please log in or create an account to verify your role.
                        </p>
                        <div class="flex gap-4">
                            <button onclick="document.getElementById('trigger-login').click()" class="px-6 py-3 bg-deped-blue text-white rounded-xl font-bold hover:bg-blue-800 transition shadow-lg">
                                Log In
                            </button>
                            <button onclick="document.querySelector('.trigger-register').click()" class="px-6 py-3 bg-white border-2 border-slate-200 text-slate-600 rounded-xl font-bold hover:border-deped-blue hover:text-deped-blue transition">
                                Register
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const role = user.role ? user.role.trim().toLowerCase() : 'new user';

            if (role === 'new user') {
                const currentHash = "new-user-state";
                if (currentHash === lastAppsHash) return; 
                lastAppsHash = currentHash;

                if(toolsTitle) toolsTitle.innerText = "Tools for Education";
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 px-4 text-center animate-fadeIn">
                        <div class="w-24 h-24 bg-yellow-50 rounded-full flex items-center justify-center mb-6 border border-yellow-100 shadow-sm relative">
                            <i class="fa-solid fa-user-clock text-4xl text-yellow-500"></i>
                            <div class="absolute bottom-0 right-0 w-8 h-8 bg-white rounded-full flex items-center justify-center border border-slate-100 shadow-sm">
                                <i class="fa-solid fa-hourglass-half text-slate-400 text-xs animate-spin-slow"></i>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-3">Account Being Processed</h3>
                        <p class="text-slate-500 max-w-md mb-8 leading-relaxed">
                            Thank you for registering, <strong>${user.username}</strong>!<br>
                            Your account is currently under review by our administrators. Access to tools will be granted once approved.
                        </p>
                        <div class="p-4 bg-blue-50 border border-blue-100 rounded-xl max-w-sm mx-auto text-left flex gap-4">
                            <i class="fa-solid fa-circle-info text-blue-500 mt-1"></i>
                            <div>
                                <p class="text-xs font-bold text-blue-800 uppercase mb-1">What to do now?</p>
                                <p class="text-xs text-blue-600">You can explore the Community Hub or check back later. This usually takes 24-48 hours.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            let sheetName = '';
            let isPremium = false;
            let isLocal = false; 

            if (role === 'paid user' || role === 'admin') {
                sheetName = 'PAID USERS';
                isPremium = true;
                if(toolsTitle) toolsTitle.innerText = "Premium Workspace";
                if(toolsSubtitle) {
                    toolsSubtitle.innerHTML = '<i class="fa-solid fa-crown mr-1"></i> Exclusive Access';
                    toolsSubtitle.className = "text-yellow-600 font-bold text-sm tracking-widest uppercase mb-2 block";
                }
            } else if (role === 'basic user' || role === 'local user') {
                sheetName = 'Sheet1';
                isPremium = false;
                isLocal = true; 
                if(toolsTitle) toolsTitle.innerText = "Standard Workspace";
                if(toolsSubtitle) {
                    toolsSubtitle.innerText = "Basic Tools Access";
                    toolsSubtitle.className = "text-blue-600 font-bold text-sm tracking-widest uppercase mb-2 block";
                }
            } else {
                container.innerHTML = `<div class="col-span-full text-center text-slate-500 py-10"><p>Access restricted for role: ${user.role}</p></div>`;
                return;
            }

            const sheetId = '1p69v6YNSjn8n7IrW9h0Qk9get61eh-ONYNxaMz76RFA';
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&headers=1&sheet=${encodeURIComponent(sheetName)}`;

            try {
                let rows = null;
                const now = Date.now();
                const cacheKey = CACHE_CONFIG.APPS.KEY + '_' + role;
                const cachedData = localStorage.getItem(cacheKey);
                const cachedTs = localStorage.getItem(CACHE_CONFIG.APPS.TS);

                if (cachedData && cachedTs && (now - parseInt(cachedTs) < CACHE_CONFIG.TTL)) {
                    rows = JSON.parse(cachedData);
                } else {
                    const res = await fetch(url);
                    const text = await res.text();
                    const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                    if (jsonMatch && jsonMatch[1]) {
                        const json = JSON.parse(jsonMatch[1]);
                        rows = json.table.rows;
                        localStorage.setItem(cacheKey, JSON.stringify(rows));
                        localStorage.setItem(CACHE_CONFIG.APPS.TS, now.toString());
                    }
                }

                const dataSignature = JSON.stringify(rows) + role;
                if (dataSignature === lastAppsHash) return;
                lastAppsHash = dataSignature;

                container.innerHTML = '';

                // NEW: Upgrade Banner for Local Users - WIRED TO OPEN MODAL
                if (isLocal) {
                    container.insertAdjacentHTML('beforeend', `
                        <div class="col-span-full bg-gradient-to-r from-yellow-50 to-amber-50 border border-yellow-200 rounded-xl p-6 flex flex-col md:flex-row items-center justify-between gap-4 shadow-sm mb-4 relative overflow-hidden group reveal active">
                            <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-yellow-200 rounded-full opacity-20 blur-xl"></div>
                            
                            <div class="flex items-center gap-4 relative z-10">
                                <div class="w-12 h-12 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm">
                                    <i class="fa-solid fa-crown text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 text-lg">Upgrade to Premium</h3>
                                    <p class="text-sm text-slate-600">Unlock exclusive AI models, unlimited generation, and priority support.</p>
                                </div>
                            </div>
                            
                            <button onclick="openSubscriptionModal()" class="relative z-10 px-6 py-3 bg-yellow-400 hover:bg-yellow-300 text-yellow-900 text-xs font-bold uppercase tracking-widest rounded-full transition shadow-md hover:shadow-lg flex items-center gap-2 transform hover:-translate-y-0.5">
                                Get Premium <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    `);
                }

                if (!rows || rows.length === 0) {
                    container.insertAdjacentHTML('beforeend', '<div class="col-span-full text-center text-slate-500 py-10"><p>No tools available for your tier yet.</p></div>');
                    return;
                }

                const standardStyles = [
                    { border: 'border-l-4 border-l-blue-600', text: 'text-blue-700', bgIcon: 'bg-blue-50', iconColor: 'text-blue-600', stripColor: 'bg-blue-600' },
                    { border: 'border-l-4 border-l-red-600', text: 'text-red-700', bgIcon: 'bg-red-50', iconColor: 'text-red-600', stripColor: 'bg-red-600' },
                    { border: 'border-l-4 border-l-yellow-500', text: 'text-yellow-700', bgIcon: 'bg-yellow-50', iconColor: 'text-yellow-600', stripColor: 'bg-yellow-500' },
                    { border: 'border-l-4 border-l-emerald-600', text: 'text-emerald-700', bgIcon: 'bg-emerald-50', iconColor: 'text-emerald-600', stripColor: 'bg-emerald-600' },
                ];

                rows.forEach((row, index) => {
                    const name = row.c[0] ? row.c[0].v : null;
                    if (!name || name === "Name of app" || name === "Name") return;

                    const link = row.c[1] ? row.c[1].v : "#";
                    const details = row.c[2] ? row.c[2].v : "No details provided.";
                    
                    if(name) {
                        let cardHTML = '';

                        if (isPremium) {
                            cardHTML = `
                            <a href="${link}" target="_blank" class="tool-card group relative block h-full reveal active bg-white rounded-xl shadow-lg hover:shadow-yellow-500/20 transition-all duration-300 border border-yellow-200 overflow-hidden hover:-translate-y-1 ring-1 ring-yellow-100">
                                <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 bg-gradient-to-br from-yellow-100 to-transparent rounded-full opacity-50 transition-transform group-hover:scale-150 duration-700"></div>
                                
                                <div class="p-6 flex flex-col h-full relative z-10">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-xl flex items-center justify-center text-white text-xl shadow-md transition-transform group-hover:scale-110 group-hover:rotate-3">
                                            <i class="fa-solid fa-crown"></i>
                                        </div>
                                        <span class="px-2 py-1 bg-yellow-50 text-yellow-700 border border-yellow-200 text-[10px] font-bold uppercase tracking-wider rounded-md shadow-sm flex items-center gap-1">
                                            <i class="fa-solid fa-star text-yellow-500 text-[8px]"></i> Premium
                                        </span>
                                    </div>
                                    
                                    <h3 class="text-lg font-bold text-slate-900 mb-2 group-hover:text-yellow-600 transition-colors">${name}</h3>
                                    
                                    <p class="text-slate-500 text-sm leading-relaxed mb-6 flex-grow">
                                        ${details}
                                    </p>
                                    
                                    <div class="mt-auto pt-4 border-t border-yellow-100">
                                        <div class="flex items-center text-xs font-bold uppercase tracking-widest text-yellow-700 group-hover:text-yellow-800">
                                            Launch Pro App <i class="fa-solid fa-arrow-right ml-2 transition-transform group-hover:translate-x-1"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="h-1.5 w-full bg-gradient-to-r from-yellow-400 via-yellow-500 to-yellow-600"></div> 
                            </a>
                            `;
                        } else {
                            const style = standardStyles[index % standardStyles.length];
                            cardHTML = `
                            <a href="${link}" target="_blank" class="tool-card group relative block h-full reveal active bg-white rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 border border-slate-200 overflow-hidden hover:-translate-y-1">
                                <div class="p-6 flex flex-col h-full">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="w-12 h-12 ${style.bgIcon} rounded-lg flex items-center justify-center ${style.iconColor} text-xl transition-transform group-hover:scale-110">
                                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                                        </div>
                                        <span class="px-2 py-1 bg-slate-100 text-slate-500 text-[10px] font-bold uppercase tracking-wider rounded">Basic</span>
                                    </div>
                                    
                                    <h3 class="text-lg font-bold text-slate-900 mb-2 group-hover:text-deped-blue transition-colors">${name}</h3>
                                    
                                    <p class="text-slate-500 text-sm leading-relaxed mb-6 flex-grow">
                                        ${details}
                                    </p>
                                    
                                    <div class="mt-auto pt-4 border-t border-slate-50">
                                        <div class="flex items-center text-xs font-bold uppercase tracking-widest ${style.text}">
                                            Open Tool <i class="fa-solid fa-arrow-right ml-2 transition-transform group-hover:translate-x-1"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="h-1 w-full ${style.stripColor}"></div> 
                            </a>
                            `;
                        }

                        container.insertAdjacentHTML('beforeend', cardHTML);
                    }
                });

            } catch (err) {
                console.error('Error fetching apps:', err);
                container.innerHTML = `<div class="col-span-full text-center text-red-400 py-10"><p>Unable to load your tools. Please check your connection.</p></div>`;
            }
        }

        // New Helper to Open Modal
        function openAnnouncementModal(notifData, isPersonal) {
            const modal = document.getElementById('announcement-modal');
            const titleEl = document.getElementById('announcement-title');
            const msgEl = document.getElementById('announcement-message');
            const subtitleEl = document.getElementById('ann-subtitle');
            const iconEl = document.getElementById('ann-icon');
            const iconBg = document.getElementById('ann-icon-bg');
            const timestampEl = document.getElementById('ann-timestamp');
            const statusEl = document.getElementById('ann-status');
            
            const closeBtn = document.getElementById('close-announcement');
            const ackBtn = document.getElementById('ack-announcement');
            
            if(!modal || !titleEl || !msgEl) return;

            titleEl.innerText = notifData.title;
            msgEl.innerHTML = notifData.message; // CHANGED to innerHTML for links/formatting
            
            // 1. Check for Expiration / Gratitude Message
            if (notifData.type === 'expiration') {
                 titleEl.innerText = notifData.title || "Membership Notice";
                 subtitleEl.innerText = "System Notification";
                 
                 // Gratitude Theme (Pink/Heart)
                 iconEl.className = "fa-solid fa-heart-pulse";
                 iconBg.className = "w-8 h-8 rounded-lg bg-pink-100 text-pink-500 flex items-center justify-center text-sm shadow-md ring-2 ring-pink-100";
                 
                 timestampEl.innerText = "Important Update";
                 
                 statusEl.innerText = notifData.statusText || "Notice";
                 statusEl.className = "text-[10px] font-bold text-pink-600 bg-pink-50 px-2 py-0.5 rounded-full border border-pink-100";
                 
                 ackBtn.innerText = "I Understand";
                 ackBtn.className = "bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg transition shadow-md hover:shadow-lg text-xs transform hover:-translate-y-0.5";
            }
            // 2. Personal Admin Message
            else if (isPersonal) {
                 titleEl.innerText = "Admin Message"; 
                 subtitleEl.innerText = "Personal Notification";
                 
                 iconEl.className = "fa-solid fa-paper-plane";
                 iconBg.className = "w-8 h-8 rounded-lg bg-blue-600 text-white flex items-center justify-center text-sm shadow-md ring-2 ring-blue-100";
                 
                 const serverTs = notifData.timestamp;
                 const localTs = localStorage.getItem('personal_msg_ts');
                 
                 const formatFull = (dateStr) => {
                     const date = new Date(dateStr);
                     return date.toLocaleString('en-US', { 
                         month: 'long', 
                         day: 'numeric', 
                         year: 'numeric', 
                         hour: 'numeric', 
                         minute: '2-digit' 
                     });
                 };

                 if (serverTs) {
                     timestampEl.innerText = `Delivered: ${formatFull(serverTs)}`;
                 } else if (localTs) {
                     timestampEl.innerText = `Delivered: ${formatFull(localTs)}`;
                 } else {
                     timestampEl.innerText = 'Just now';
                 }
                 
                 statusEl.innerText = "Personal";
                 statusEl.className = "text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full border border-blue-100";
                 
                 ackBtn.innerText = "Mark as Read";
                 ackBtn.className = "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition shadow-md hover:shadow-lg text-xs transform hover:-translate-y-0.5";

            } 
            // 3. Standard Global Announcement (Dynamic Styling)
            else {
                 titleEl.innerText = notifData.title || "System Update";
                 subtitleEl.innerText = "Global Announcement";
                 timestampEl.innerText = "Broadcast Message";
                 
                 const lowerTitle = (notifData.title || "").toLowerCase();

                 if (lowerTitle.includes('urgent') || lowerTitle.includes('alert') || lowerTitle.includes('critical')) {
                     // Red / Urgent Theme
                     iconEl.className = "fa-solid fa-triangle-exclamation";
                     iconBg.className = "w-8 h-8 rounded-lg bg-red-100 text-red-600 flex items-center justify-center text-sm shadow-sm ring-1 ring-red-500/10";
                     statusEl.innerText = "Priority";
                     statusEl.className = "text-[10px] font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded-full border border-red-100";
                 } 
                 else if (lowerTitle.includes('maintenance') || lowerTitle.includes('warning') || lowerTitle.includes('attention')) {
                     // Orange / Warning Theme
                     iconEl.className = "fa-solid fa-screwdriver-wrench";
                     iconBg.className = "w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center text-sm shadow-sm ring-1 ring-orange-500/10";
                     statusEl.innerText = "System Notice";
                     statusEl.className = "text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-0.5 rounded-full border border-orange-100";
                 }
                 else if (lowerTitle.includes('new') || lowerTitle.includes('feature') || lowerTitle.includes('update')) {
                     // Indigo / Feature Theme
                     iconEl.className = "fa-solid fa-wand-magic-sparkles";
                     iconBg.className = "w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm shadow-sm ring-1 ring-indigo-500/10";
                     statusEl.innerText = "What's New";
                     statusEl.className = "text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full border border-indigo-100";
                 }
                 else {
                     // Default Blue Theme
                     iconEl.className = "fa-solid fa-bullhorn";
                     iconBg.className = "w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center text-sm shadow-sm ring-1 ring-blue-500/10";
                     statusEl.innerText = "Public";
                     statusEl.className = "text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full border border-slate-200";
                 }

                 ackBtn.innerText = "Got it";
                 ackBtn.className = "bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 font-bold py-2 px-4 rounded-lg transition shadow-sm text-xs";
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.firstElementChild.classList.remove('scale-95');
                modal.firstElementChild.classList.add('scale-100');
            }, 100);

            const liveUpdate = setInterval(() => {
                if (isPersonal && !modal.classList.contains('hidden') && !notifData.timestamp) {
                     const localTs = localStorage.getItem('personal_msg_ts');
                     if(localTs) {
                         const date = new Date(localTs);
                         timestampEl.innerText = `Delivered: ${date.toLocaleString('en-US', { month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' })}`;
                     }
                } else {
                    clearInterval(liveUpdate);
                }
            }, 5000);

            const closeModal = () => {
                clearInterval(liveUpdate);
                modal.classList.add('opacity-0');
                modal.firstElementChild.classList.remove('scale-100');
                modal.firstElementChild.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    // Mark as seen based on type
                    if (notifData.type === 'expiration') {
                        localStorage.setItem('last_seen_expiration_warning', new Date().toDateString());
                    } else if(!isPersonal) { 
                         const notificationId = notifData.title + "||" + notifData.message;
                         localStorage.setItem('last_seen_announcement_id', notificationId);
                         localStorage.removeItem('last_seen_announcement');
                    } else {
                         const notificationId = notifData.title + "||" + notifData.message;
                         localStorage.setItem('last_seen_personal_id', notificationId);
                    }
                    // Force refresh notification UI immediately to hide badge
                    if(window.showNotification) window.showNotification();
                }, 300);
            };

            closeBtn.onclick = closeModal;
            ackBtn.onclick = closeModal;
        }

        function showNotification() {
            let activeNotif = null;
            let isPersonal = false;

            const navBtn = document.getElementById('nav-notification-btn');
            const mobBtn = document.getElementById('mobile-notification-btn');
            // Notification Badge Elements
            const navBadge = document.getElementById('nav-notif-badge');
            const mobBadge = document.getElementById('mob-notif-badge');

            // Use unified session helper
            const currentUser = getSession();
            let expirationNotif = null; 

            if (currentUser) {
                try {
                    const allUsers = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
                    const freshUser = allUsers.find(u => u.username.toLowerCase() === currentUser.username.toLowerCase());
                    
                    // 1. Personal Message Check
                    if (freshUser && freshUser.message) {
                        currentPersonalMessage = { 
                            title: `Message from the Admin`, 
                            message: freshUser.message,
                            timestamp: freshUser.messageTimestamp 
                        };
                        isPersonal = true;
                        
                        if(navBtn) navBtn.classList.remove('hidden');
                        if(mobBtn) mobBtn.classList.remove('hidden');

                        // --- NEW: Check Read Status to Toggle Badge ---
                        const notificationId = currentPersonalMessage.title + "||" + currentPersonalMessage.message;
                        const lastSeenId = localStorage.getItem('last_seen_personal_id');
                        const isRead = lastSeenId === notificationId;

                        if (isRead) {
                            if(navBadge) navBadge.classList.add('hidden');
                            if(mobBadge) mobBadge.classList.add('hidden');
                        } else {
                            if(navBadge) navBadge.classList.remove('hidden');
                            if(mobBadge) mobBadge.classList.remove('hidden');
                        }
                        // ----------------------------------------------

                    } else {
                        currentPersonalMessage = null;
                        if(navBtn) navBtn.classList.add('hidden');
                        if(mobBtn) mobBtn.classList.add('hidden');
                    }

                    // 2. Expiration Logic Check
                    if (currentUser.expiration) {
                        const expDate = new Date(currentUser.expiration);
                        const now = new Date();
                        // Normalize to midnight for accurate day calculation
                        expDate.setHours(0,0,0,0);
                        now.setHours(0,0,0,0);
                        
                        const diffTime = expDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        // Check if we showed this today already
                        const lastSeenExp = localStorage.getItem('last_seen_expiration_warning');
                        const todayStr = new Date().toDateString();

                        if (lastSeenExp !== todayStr) {
                            if (diffTime < 0) {
                                // EXPIRED
                                expirationNotif = {
                                    type: 'expiration',
                                    title: "Membership Expired",
                                    message: "Thank you for your support! Your premium account has expired. Please renew your subscription to continue accessing exclusive tools.",
                                    statusText: "Expired"
                                };
                            } else if (diffDays <= 5) {
                                // EXPIRING SOON (5 days or less)
                                expirationNotif = {
                                    type: 'expiration',
                                    title: "Subscription Ending Soon",
                                    message: `Thank you for being a valued member! Your premium access expires in ${diffDays} day${diffDays !== 1 ? 's' : ''}.`,
                                    statusText: `${diffDays} Days Left`
                                };
                            }
                        }
                    }

                } catch(e) { console.error(e); }
            } else {
                if(navBtn) navBtn.classList.add('hidden');
                if(mobBtn) mobBtn.classList.add('hidden');
            }

            // Priority Logic: Personal > Expiration > Global
            if (currentPersonalMessage) {
                activeNotif = currentPersonalMessage;
                const notificationId = activeNotif.title + "||" + activeNotif.message;
                const lastSeenId = localStorage.getItem('last_seen_personal_id');
                
                // If personal msg seen, clear activeNotif to allow next priority
                if (lastSeenId === notificationId) {
                    activeNotif = null;
                    isPersonal = false;
                }
            } 
            
            // Fallback to Expiration if no personal message
            if (!activeNotif && expirationNotif) {
                activeNotif = expirationNotif;
                isPersonal = false; 
            }

            // Fallback to Global if neither of above
            if (!activeNotif && globalNotification) {
                activeNotif = globalNotification;
                const notificationId = activeNotif.title + "||" + activeNotif.message;
                const lastSeenId = localStorage.getItem('last_seen_announcement_id');
                
                if (lastSeenId === notificationId) return;
                if (localStorage.getItem('last_seen_announcement') === activeNotif.message) return;
            }

            // Show Result
            if (activeNotif) {
                openAnnouncementModal(activeNotif, isPersonal);
            }
        }
        
        function loadMoreStories() {
            const grid = document.getElementById('stories-grid');
            if (!grid) return; 

            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const currentCount = document.querySelectorAll('.group.reveal').length;
            const remaining = allStories.length - currentCount;
            if (remaining <= 0) return;
            const nextBatchSize = Math.min(BATCH_SIZE, remaining);
            const startIndex = allStories.length - currentCount - nextBatchSize;
            const endIndex = allStories.length - currentCount;
            const olderBatch = allStories.slice(startIndex, endIndex);
            const fragment = document.createDocumentFragment();
            let lastGroupInBatch = null;
            olderBatch.forEach((story, index) => {
                if (story.dateGroup !== lastGroupInBatch) {
                    fragment.appendChild(createDateBadge(story.dateGroup));
                    lastGroupInBatch = story.dateGroup;
                }
                fragment.appendChild(createChatBubble(story));
            });
            const firstExistingElement = grid.firstElementChild;
            if (firstExistingElement && firstExistingElement.classList.contains('date-badge')) {
                if (firstExistingElement.innerText === lastGroupInBatch) {
                    grid.removeChild(firstExistingElement);
                }
            }
            grid.insertBefore(fragment, grid.firstChild);
            if (startIndex <= 0) {
                if(loadMoreBtn) {
                    loadMoreBtn.innerText = "No older messages";
                    loadMoreBtn.disabled = true;
                    loadMoreBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        }
        function createDateBadge(text) {
            const div = document.createElement('div');
            div.className = 'date-badge';
            div.innerText = text;
            return div;
        }
        function initSpotlight(stories) {
            if (!stories || stories.length === 0) return;
            const indicatorsContainer = document.getElementById('spotlight-indicators');
            if(!indicatorsContainer) return;

            indicatorsContainer.innerHTML = '';
            stories.forEach((_, index) => {
                const dot = document.createElement('button');
                dot.className = `h-2 rounded-full transition-all duration-300 ${index === 0 ? 'bg-deped-blue w-6' : 'bg-slate-200 w-2 hover:bg-slate-300'}`;
                dot.onclick = () => {
                    if(spotlightInterval) clearInterval(spotlightInterval);
                    currentSpotlightIndex = index;
                    transitionSpotlight(stories[currentSpotlightIndex], currentSpotlightIndex);
                };
                indicatorsContainer.appendChild(dot);
            });
            updateSpotlightHTML(stories[0]);
            const prevBtn = document.getElementById('prev-spotlight');
            const nextBtn = document.getElementById('next-spotlight');
            if(prevBtn) prevBtn.onclick = () => {
                if(spotlightInterval) clearInterval(spotlightInterval);
                currentSpotlightIndex = (currentSpotlightIndex - 1 + stories.length) % stories.length;
                transitionSpotlight(stories[currentSpotlightIndex], currentSpotlightIndex);
            };
            if(nextBtn) nextBtn.onclick = () => {
                if(spotlightInterval) clearInterval(spotlightInterval);
                currentSpotlightIndex = (currentSpotlightIndex + 1) % stories.length;
                transitionSpotlight(stories[currentSpotlightIndex], currentSpotlightIndex);
            };
            if (stories.length > 1) {
                if (spotlightInterval) clearInterval(spotlightInterval);
                spotlightInterval = setInterval(() => {
                    currentSpotlightIndex = (currentSpotlightIndex + 1) % stories.length;
                    transitionSpotlight(stories[currentSpotlightIndex], currentSpotlightIndex);
                }, 8000);
            }
        }
        function transitionSpotlight(story, index) {
            const container = document.getElementById('spotlight-content');
            if(!container) return; 
            container.classList.remove('opacity-100');
            container.classList.add('opacity-0');
            setTimeout(() => {
                updateSpotlightHTML(story);
                const dots = document.getElementById('spotlight-indicators').children;
                if(dots) {
                    for(let i=0; i<dots.length; i++) {
                        if (i === index) {
                            dots[i].classList.remove('bg-slate-200', 'w-2', 'hover:bg-slate-300');
                            dots[i].classList.add('bg-deped-blue', 'w-6');
                        } else {
                            dots[i].classList.remove('bg-deped-blue', 'w-6');
                            dots[i].classList.add('bg-slate-200', 'w-2', 'hover:bg-slate-300');
                        }
                    }
                }
                container.classList.remove('opacity-0');
                container.classList.add('opacity-100');
            }, 300);
        }
        function updateSpotlightHTML(story) {
            const container = document.getElementById('spotlight-content');
            if(!container) return; 

            // ENHANCED: Lookup user details for better presentation
            let role = 'Educator'; // Default title
            // Generate avatar based on name (consistent color using name length or hash could be better, but random is fine for variety)
            let avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(story.name)}&background=random&color=fff&bold=true&size=128`;
            let badgeHtml = '';

            try {
                // Access the cached user list to find details about the storyteller
                const users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
                const user = users.find(u => u.username.toLowerCase() === story.name.toLowerCase());
                
                if(user) {
                    // Determine Role Label & Badge
                    const r = user.role.toLowerCase();
                    if(r === 'admin') {
                        role = 'System Administrator';
                        badgeHtml = '<span class="ml-2 inline-flex items-center gap-1 bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider border border-slate-700 shadow-sm"><i class="fa-solid fa-shield-halved text-[8px]"></i> Admin</span>';
                    } else if (r.includes('paid')) {
                        role = 'Premium Member';
                        badgeHtml = '<span class="ml-2 inline-flex items-center gap-1 bg-yellow-100 text-yellow-700 text-[9px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider border border-yellow-200 shadow-sm"><i class="fa-solid fa-crown text-[8px]"></i> Pro</span>';
                    } else if (r.includes('basic') || r.includes('local')) {
                        role = 'Basic Member';
                    }
                }
            } catch(e) {
                console.warn("Could not load user details for spotlight", e);
            }

            // New Layout: Quote with Avatar Footer
            container.innerHTML = `
                <div class="flex flex-col items-center text-center max-w-4xl mx-auto h-full justify-center">
                    <div class="mb-6 relative">
                        <div class="absolute -inset-4 bg-blue-50 rounded-full blur-lg opacity-50 animate-pulse"></div>
                        <i class="fa-solid fa-quote-left text-5xl text-blue-200 relative z-10 transform -rotate-12"></i>
                    </div>
                    
                    <p class="text-xl md:text-3xl text-slate-700 font-medium leading-relaxed tracking-tight mb-10 italic relative z-10 drop-shadow-sm">
                        "${story.message}"
                    </p>
                    
                    <div class="flex items-center gap-4 animate-fadeIn bg-white/50 backdrop-blur-sm px-6 py-3 rounded-full border border-slate-100 shadow-sm hover:shadow-md transition-shadow duration-300">
                        <img src="${avatarUrl}" alt="${story.name}" class="w-12 h-12 rounded-full shadow-md border-2 border-white ring-2 ring-blue-50 object-cover">
                        <div class="text-left">
                            <div class="flex items-center">
                                <p class="text-sm font-bold text-slate-900">${story.name}</p>
                                ${badgeHtml}
                            </div>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest text-deped-blue">${role}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function createChatBubble(story) {
            // 1. Lookup User Role from Cache
            const users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
            const matchedUser = users.find(u => u.username.toLowerCase() === story.name.toLowerCase());
            const role = matchedUser ? matchedUser.role.toLowerCase() : 'guest';

            // 2. Define Styles based on Role
            let badgeHTML = '';
            let nameClass = 'text-slate-700';
            let avatarBg = 'bg-slate-200';
            let avatarText = 'text-slate-500';
            let iconHTML = '';

            if (role === 'admin') {
                // Modified: No text badge, just the shield icon
                badgeHTML = ''; 
                nameClass = 'text-slate-900';
                avatarBg = 'bg-slate-800';
                avatarText = 'text-white';
                iconHTML = '<i class="fa-solid fa-shield-halved text-xs text-blue-400 ml-1" title="Administrator"></i>';
            } 
            else if (role.includes('paid')) {
                // Modified: Removed text badge, kept only icon as requested
                badgeHTML = '';
                nameClass = 'text-amber-700';
                avatarBg = 'bg-gradient-to-br from-yellow-400 to-amber-500';
                avatarText = 'text-white';
                iconHTML = '<i class="fa-solid fa-crown text-xs text-yellow-500 ml-1" title="Premium Member"></i>';
            } 
            else if (role.includes('basic') || role.includes('local')) {
                // Modified: No badge, only blue styling for name/avatar
                badgeHTML = ''; 
                nameClass = 'text-blue-700';
                avatarBg = 'bg-blue-100';
                avatarText = 'text-blue-600';
                iconHTML = ''; 
            }

            const bubble = document.createElement('div');
            bubble.className = 'flex flex-col group reveal active';
            bubble.innerHTML = `
                <div class="flex items-start gap-2 mb-1 ml-1">
                    <div class="w-8 h-8 rounded-full ${avatarBg} flex-shrink-0 flex items-center justify-center text-[10px] font-bold ${avatarText} shadow-sm mt-1 border border-white ring-1 ring-slate-50">
                        ${story.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex flex-col">
                        <div class="flex items-center flex-wrap">
                            <span class="text-xs font-bold ${nameClass}">${story.name}</span>
                            ${iconHTML}
                            ${badgeHTML}
                        </div>
                        <span class="text-[10px] text-slate-400">${story.timestamp}</span>
                    </div>
                </div>
                <div class="bg-white chat-bubble-bg border border-slate-100 p-4 rounded-2xl rounded-tl-sm text-sm text-slate-600 shadow-sm max-w-[85%] leading-relaxed relative hover:shadow-md transition-shadow">
                    ${story.message}
                </div>
            `;
            return bubble;
        }

        function getStaticStoriesHTML() {
            return `
                <div class="flex flex-col group reveal active">
                    <div class="flex items-start gap-2 mb-1 ml-1">
                        <div class="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-[10px] font-bold text-slate-500 shadow-sm mt-1">T</div>
                        <div class="flex flex-col">
                            <span class="text-xs text-slate-700 font-bold">Teacher Rose</span>
                            <span class="text-[10px] text-slate-400">10:00 AM</span>
                        </div>
                    </div>
                    <div class="bg-white chat-bubble-bg border border-slate-100 p-4 rounded-2xl rounded-tl-sm text-sm text-slate-600 shadow-sm max-w-[85%] leading-relaxed">
                        The Lesson Planner saved me hours this weekend! Now I have more time to prepare for our Christmas party.
                    </div>
                </div>
            `;
        }
        
        // --- Wellness Mode Logic (Fixed) ---
        function toggleWellnessMode(forceState) {
            const body = document.body;
            const subtitle = document.getElementById('nav-subtitle');
            const maintTitle = document.getElementById('maintenance-title');
            const maintMsg = document.getElementById('maintenance-message');
            const isNowWellness = typeof forceState !== 'undefined' ? forceState : !body.classList.contains('wellness-active');
            if (isNowWellness) {
                body.classList.add('wellness-active');
                if(maintenanceText && maintTitle && maintMsg) {
                    maintTitle.innerText = maintenanceText.title;
                    maintMsg.innerText = maintenanceText.message;
                } else {
                    if(maintTitle) maintTitle.innerText = "System Maintenance Underway";
                    if(maintMsg) maintMsg.innerHTML = "We are currently performing scheduled upgrades to enhance platform performance and reliability.<br>Thank you for your patience as we prepare a better experience for you.";
                }
            } else {
                body.classList.remove('wellness-active');
                if(subtitle) subtitle.innerText = "Official Beta";
            }
        }

        function updateCountdown(endTime) {
            const now = new Date();
            const diff = endTime - now;
            if (diff <= 0) {
                if (countdownInterval) clearInterval(countdownInterval);
                const timerEl = document.getElementById('wellness-countdown');
                if (timerEl) timerEl.innerText = "00d 00h 00m 00s";
                toggleWellnessMode(false);
                return;
            }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            const display = (days < 10 ? "0" + days : days) + "d " + (hours < 10 ? "0" + hours : hours) + "h " + (minutes < 10 ? "0" + minutes : minutes) + "m " + (seconds < 10 ? "0" + seconds : seconds) + "s";
            const timerEl = document.getElementById('wellness-countdown');
            if (timerEl) timerEl.innerText = display;
        }

        function checkWellnessTime() {
            const now = new Date();
            const timeText = document.getElementById('wellness-hours-text');
            if (scheduledWellness) {
                const startStr = scheduledWellness.start.toLocaleString([], {year: 'numeric', month:'short', day:'numeric', hour: 'numeric', minute:'2-digit'});
                const endStr = scheduledWellness.end.toLocaleString([], {year: 'numeric', month:'short', day:'numeric', hour: 'numeric', minute:'2-digit'});
                if (now >= scheduledWellness.start && now <= scheduledWellness.end) {
                    if (!document.body.classList.contains('wellness-active')) {
                        toggleWellnessMode(true);
                    }
                    if(timeText) timeText.innerText = `Scheduled Break: ${startStr} - ${endStr}`;
                    if (!countdownInterval) {
                        updateCountdown(scheduledWellness.end); 
                        countdownInterval = setInterval(() => {
                            updateCountdown(scheduledWellness.end);
                        }, 1000);
                    }
                    return;
                }
            }
            if (document.body.classList.contains('wellness-active')) {
                toggleWellnessMode(false);
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        async function fetchUsers() {
             const sheetId = '1p69v6YNSjn8n7IrW9h0Qk9get61eh-ONYNxaMz76RFA';
             const sheetName = 'USERS';
             const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}&nocache=${Date.now()}`;

             try {
                 const response = await fetch(url);
                 const text = await response.text();
                 const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                 if (jsonMatch && jsonMatch[1]) {
                     const json = JSON.parse(jsonMatch[1]);
                     const rows = json.table?.rows || [];
                     
                     const users = rows.map(row => {
                         // Strict Safety Check: Ensure row and cell exist
                         if(!row || !row.c) return null;
                         
                         const userCell = row.c[SHEET_COLUMNS.USERNAME];
                         if(!userCell || userCell.v === null || userCell.v === undefined) return null;

                         const username = String(userCell.v).trim();
                         
                         // Filter out empty strings or accidental "null" text
                         if (username === "" || username.toLowerCase() === "null" || username.toLowerCase() === "undefined") {
                             return null;
                         }
                         
                         // Get Role
                         let role = row.c[SHEET_COLUMNS.ROLE] ? String(row.c[SHEET_COLUMNS.ROLE].v).trim() : '';
                         
                         // Normalize Role: Empty or "User" -> "New User" (Pending)
                         if (!role || role.toLowerCase() === 'user') {
                             role = 'New User';
                         }
                         if (role.toLowerCase() === 'local user') role = 'Basic User';

                         // Get Personal Message
                         const personalMsg = (row.c[SHEET_COLUMNS.MESSAGE] && row.c[SHEET_COLUMNS.MESSAGE].v) ? String(row.c[SHEET_COLUMNS.MESSAGE].v).trim() : null;
                         
                         // Get Full Name (New)
                         const fullName = (row.c[SHEET_COLUMNS.FULLNAME] && row.c[SHEET_COLUMNS.FULLNAME].v) ? String(row.c[SHEET_COLUMNS.FULLNAME].v).trim() : '';

                         // Get Message Timestamp
                         let msgTs = null;
                         if (row.c[SHEET_COLUMNS.MSG_TIMESTAMP]) { 
                             msgTs = parseGvizDate(row.c[SHEET_COLUMNS.MSG_TIMESTAMP].v) || (row.c[SHEET_COLUMNS.MSG_TIMESTAMP].f ? parseGvizDate(row.c[SHEET_COLUMNS.MSG_TIMESTAMP].f) : null);
                             if (msgTs) msgTs = msgTs.toISOString();
                         }
                         
                         let expirationStr = null;
                         let startDateStr = null;

                         // Get Subscription Dates
                         if (row.c[SHEET_COLUMNS.START_DATE]) {
                             let sDate = parseGvizDate(row.c[SHEET_COLUMNS.START_DATE].v) || (row.c[SHEET_COLUMNS.START_DATE].f ? parseGvizDate(row.c[SHEET_COLUMNS.START_DATE].f) : null);
                             if(sDate) startDateStr = sDate.toISOString();
                         }

                         // Handle Expiration logic for Paid Users
                         if (row.c[SHEET_COLUMNS.EXPIRATION]) {
                             let expDate = parseGvizDate(row.c[SHEET_COLUMNS.EXPIRATION].v);
                             if (!expDate && row.c[SHEET_COLUMNS.EXPIRATION].f) expDate = parseGvizDate(row.c[SHEET_COLUMNS.EXPIRATION].f);
                             
                             if (expDate) {
                                 expirationStr = expDate.toISOString();
                                 const now = new Date();
                                 now.setHours(0,0,0,0);
                                 
                                 // Auto-downgrade logic (Visual only until sheet update)
                                 if (role.toLowerCase() === 'paid user' && expDate < now) {
                                     role = 'Basic User';
                                     console.log(`User ${username} expired on ${expDate.toDateString()}. Downgrading.`);
                                 }
                             }
                         }

                         return {
                             username: username,
                             password: row.c[SHEET_COLUMNS.PASSWORD] ? String(row.c[SHEET_COLUMNS.PASSWORD].v).trim() : "", 
                             role: role,
                             fullname: fullName, // Add to object
                             message: personalMsg, 
                             messageTimestamp: msgTs, 
                             question: row.c[SHEET_COLUMNS.SEC_QUESTION] ? String(row.c[SHEET_COLUMNS.SEC_QUESTION].v).trim() : null,
                             answer: row.c[SHEET_COLUMNS.SEC_ANSWER] ? String(row.c[SHEET_COLUMNS.SEC_ANSWER].v).trim() : null,
                             start: startDateStr,
                             expiration: expirationStr
                         };
                     }).filter(u => u !== null); // Filter out the nulls we returned above

                     localStorage.setItem(CACHE_CONFIG.USERS.KEY, JSON.stringify(users));

                     // --- NEW: Force Chat Re-render on User Update ---
                     // This fixes the issue where roles reset to "normal" because the chat loaded 
                     // before the user list was ready.
                     const currentUserHash = JSON.stringify(users.map(u => ({u: u.username, r: u.role}))); 
                     const lastUserHash = localStorage.getItem('ai_school_users_hash_v1');
                     
                     if (currentUserHash !== lastUserHash) {
                         localStorage.setItem('ai_school_users_hash_v1', currentUserHash);
                         // Invalidate stories hash to ensure render method proceeds
                         if(typeof lastStoriesHash !== 'undefined') lastStoriesHash = ""; 
                         if(typeof fetchStories === 'function') fetchStories(false);
                     }
                     // ------------------------------------------------

                     const session = localStorage.getItem('ai_school_session');
                     if (session) {
                         const currentSession = JSON.parse(session);
                         const updatedUser = users.find(u => u.username.toLowerCase() === currentSession.username.toLowerCase());
                         
                         if (!updatedUser) {
                             console.warn('Session invalid: User not found in database.');
                             localStorage.removeItem('ai_school_session');
                             localStorage.removeItem(CACHE_CONFIG.APPS.KEY);
                             if (typeof updateAuthUI === 'function') updateAuthUI();
                         } else {
                             // Sync Role/Expiration
                             if (updatedUser.role !== currentSession.role || updatedUser.expiration !== currentSession.expiration) {
                                 console.log(`User sync: Status update detected for ${updatedUser.username}`);
                                 currentSession.role = updatedUser.role;
                                 currentSession.expiration = updatedUser.expiration; 
                                 localStorage.setItem('ai_school_session', JSON.stringify(currentSession));
                                 if (typeof updateAuthUI === 'function') updateAuthUI(currentSession);
                             }

                             // NEW: Sync Message Timestamp Logic
                             // If the message content from DB is different from what we have cached, update timestamp
                             if (updatedUser.message) {
                                 const cachedMsg = localStorage.getItem('personal_msg_content');
                                 // Simple check. In a real app we'd use IDs. Here, if text changes, it's new.
                                 if (cachedMsg !== updatedUser.message) {
                                     localStorage.setItem('personal_msg_content', updatedUser.message);
                                     localStorage.setItem('personal_msg_ts', new Date().toISOString());
                                 }
                             }
                         }
                     }
                     
                     // --- NEW: Live Update Admin Dashboard if it is Open ---
                     const adminModal = document.getElementById('admin-modal');
                     if (adminModal && !adminModal.classList.contains('hidden')) {
                         
                         // Use window-attached function to ensure scope access
                         if(window.updateAdminStats) window.updateAdminStats(users);
                         
                         // Only re-render list if search is empty to avoid interrupting typing
                         const searchInput = document.getElementById('admin-search');
                         if (searchInput && searchInput.value === '') {
                             // CRITICAL FIX: Respect the current active filter
                             const filteredUsers = getFilteredUsers(users, currentAdminFilterType);
                             if(window.renderAdminUserList) window.renderAdminUserList(filteredUsers);
                         }
                     }
                     // -----------------------------------------------------

                     showNotification();
                     return users;
                 }
             } catch (err) {
                 console.error('Failed to fetch users:', err);
                 return [];
             }
        }

        // Initialize (Wait for DOM)
        document.addEventListener('DOMContentLoaded', () => {
             
             // --- SECURITY SUITE: ANTI-COPY & ANTI-DEBUG ---
             
             // 1. Disable Right Click Context Menu
             document.addEventListener('contextmenu', event => event.preventDefault());

             // 2. Disable Keyboard Shortcuts (Inspect, View Source, Save, Print)
             document.addEventListener('keydown', function(e) {
                 // F12 (DevTools)
                 if(e.key === 'F12') {
                     e.preventDefault();
                     return false;
                 }
                 
                 // Ctrl + Shift + I/J/C (DevTools)
                 if(e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) {
                     e.preventDefault();
                     return false;
                 }
                 
                 // Ctrl + U (View Source)
                 if(e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
                     e.preventDefault();
                     return false;
                 }
                 
                 // Ctrl + S (Save Page)
                 if(e.ctrlKey && (e.key === 's' || e.key === 'S')) {
                     e.preventDefault();
                     return false;
                 }

                 // Ctrl + P (Print)
                 if(e.ctrlKey && (e.key === 'p' || e.key === 'P')) {
                     e.preventDefault();
                     return false;
                 }
             });

             // 3. Clear Console to hide any logs
             setInterval(() => {
                 console.clear();
                 // Optional: Add a warning for anyone who forces it open
                 /* const styles = [
                    'color: red', 
                    'font-size: 30px', 
                    'font-weight: bold', 
                    'text-shadow: 2px 2px black',
                    'padding: 10px'
                 ].join(';');
                 console.log('%cSTOP!', styles);
                 console.log('%cThis is a protected government-aligned educational tool.', 'font-size: 16px'); 
                 */
             }, 2000);

             // 4. Disable Image Dragging
             document.querySelectorAll('img').forEach(img => {
                 img.addEventListener('dragstart', e => e.preventDefault());
             });

             // --- END SECURITY SUITE ---

             Promise.all([
                 fetchSystemConfig(), 
                 fetchUsers()         
             ]).then(() => {
                 setTimeout(dismissLoader, 800);
             }).catch(() => {
                 dismissLoader();
             });

             fetchStories(); 
             fetchApps();    
             
             setInterval(() => {
                 fetchUsers();       
                 fetchSystemConfig(); 
             }, 6000);

             setInterval(() => {
                 fetchStories();     
                 fetchApps();        
             }, 30000);

             window.addEventListener('focus', () => {
                 setTimeout(fetchUsers, 500); 
             });
             
             // Notification Holder Click Listeners
             const navNotifBtn = document.getElementById('nav-notification-btn');
             const mobNotifBtn = document.getElementById('mobile-notification-btn');
             
             const handleHolderClick = () => {
                 if (currentPersonalMessage) {
                     openAnnouncementModal(currentPersonalMessage, true);
                 }
             };

             if(navNotifBtn) navNotifBtn.addEventListener('click', handleHolderClick);
             if(mobNotifBtn) mobNotifBtn.addEventListener('click', handleHolderClick);

             const manualSyncBtn = document.getElementById('manual-sync-btn');
             if(manualSyncBtn) {
                 manualSyncBtn.addEventListener('click', async (e) => {
                     e.stopPropagation(); 
                     const icon = manualSyncBtn.querySelector('i');
                     
                     icon.classList.add('fa-spin');
                     manualSyncBtn.classList.add('text-deped-blue');
                     manualSyncBtn.classList.remove('text-slate-300');
                     
                     await fetchUsers();
                     
                     setTimeout(() => {
                         icon.classList.remove('fa-spin');
                         manualSyncBtn.classList.remove('text-deped-blue');
                         manualSyncBtn.classList.add('text-slate-300');
                     }, 1000);
                 });
             }

             // Contact Form Logic
             const contactForm = document.getElementById('contactForm');
             if(contactForm) {
                 const btn = contactForm.querySelector('button[type="submit"]');
                 checkCooldown(btn); 

                 contactForm.addEventListener('submit', (e) => {
                     const messageInput = document.getElementById('message');
                     const nameInput = document.getElementById('name');
                     const errorMessage = document.getElementById('errorMessage');
                     
                     if (hasFoulLanguage(messageInput.value) || hasFoulLanguage(nameInput.value)) {
                         e.preventDefault();
                         errorMessage.classList.remove('hidden');
                         const container = messageInput.closest('.bg-slate-50');
                         if(container) {
                             container.classList.add('ring-2', 'ring-red-300', 'bg-red-50');
                             setTimeout(() => {
                                 container.classList.remove('ring-2', 'ring-red-300', 'bg-red-50');
                                 errorMessage.classList.add('hidden');
                             }, 3000);
                         }
                         return;
                     }

                     const name = nameInput.value;
                     const message = messageInput.value;
                     localStorage.removeItem(CACHE_CONFIG.STORIES.TS);
                     const targetTime = Date.now() + COOLDOWN_MS;
                     localStorage.setItem(STORAGE_KEY, targetTime);
                     startTimer(btn, targetTime);
                     
                     setTimeout(() => { 
                         messageInput.value = ''; 
                         document.getElementById('char-count').innerText = '0/300';
                         messageInput.style.height = ''; 
                     }, 100);

                     const dateObj = new Date();
                     const timeString = dateObj.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                     const dateGroup = "Today";
                     const newStory = { name: name, message: message, timestamp: timeString, dateGroup: dateGroup };
                     
                     allStories.push(newStory);
                     initSpotlight([...allStories].reverse().slice(0, 5));
                     const grid = document.getElementById('stories-grid');
                     if(grid) {
                         if (grid.children[0] && grid.children[0].classList.contains('text-center')) grid.innerHTML = '';
                         grid.appendChild(createChatBubble(newStory));
                         grid.scrollTop = grid.scrollHeight;
                     }
                     setTimeout(() => fetchStories(true), 2000);
                 });
             }

             // Load More
             const loadMoreBtn = document.getElementById('loadMoreBtn');
             if(loadMoreBtn) {
                 loadMoreBtn.addEventListener('click', loadMoreStories);
             }

             // Support Section Toggle Logic
             const supportToggle = document.getElementById('support-toggle');
             const supportContent = document.getElementById('support-content');
             const supportIcon = document.getElementById('support-icon');
             if(supportToggle && supportContent && supportIcon) {
                 supportToggle.addEventListener('click', () => {
                     const isHidden = supportContent.classList.contains('hidden');
                     if (isHidden) {
                         supportContent.classList.remove('hidden');
                         supportIcon.classList.remove('fa-chevron-down');
                         supportIcon.classList.add('fa-chevron-up');
                     } else {
                         supportContent.classList.add('hidden');
                         supportIcon.classList.remove('fa-chevron-up');
                         supportIcon.classList.add('fa-chevron-down');
                     }
                 });
             }

             // Full Screen Image Modal Logic
             const supportImg = document.getElementById('support-img');
             const modal = document.getElementById('image-modal');
             const modalImg = document.getElementById('modal-img');
             if(supportImg && modal && modalImg) {
                 supportImg.addEventListener('click', () => {
                     modal.classList.remove('hidden');
                     setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        modalImg.classList.remove('scale-95');
                        modalImg.classList.add('scale-100');
                     }, 10);
                     modalImg.src = supportImg.src;
                 });
                 modal.addEventListener('click', () => {
                     modal.classList.add('opacity-0');
                     modalImg.classList.remove('scale-100');
                     modalImg.classList.add('scale-95');
                     setTimeout(() => {
                        modal.classList.add('hidden');
                     }, 300);
                 });
             }

             // Credits Overlay Close Logic
             const creditsOverlay = document.getElementById('credits-overlay');
             const closeCredits = document.getElementById('close-credits');
             const creditsCard = document.getElementById('credits-card');
             if(closeCredits && creditsOverlay && creditsCard) {
                 const hideCredits = () => {
                     creditsCard.classList.remove('animate-zoom-in');
                     creditsCard.classList.remove('opacity-100', 'scale-100');
                     creditsCard.classList.add('opacity-0', 'scale-95');
                     setTimeout(() => {
                         creditsOverlay.classList.add('hidden');
                     }, 300);
                 };
                 closeCredits.addEventListener('click', hideCredits);
                 creditsOverlay.addEventListener('click', (e) => {
                     if(e.target === creditsOverlay) hideCredits();
                 });
             }

             // --- AUTHENTICATION LOGIC ---
             const loginModal = document.getElementById('login-modal');
             const loginForm = document.getElementById('loginForm');
             const loginBtnTrigger = document.getElementById('trigger-login');
             const mobileLoginBtn = document.getElementById('mobile-login-btn');
             const closeLoginBtn = document.getElementById('close-login-modal');
             // NEW: Forgot Password Elements
             const forgotPassBtn = document.getElementById('trigger-forgot-password');
             const forgotModal = document.getElementById('forgot-password-modal');
             const closeForgotBtn = document.getElementById('close-forgot-modal');
             
             // Steps
             const fpStep1 = document.getElementById('fp-step-1');
             const fpStep2 = document.getElementById('fp-step-2');
             const fpStep3 = document.getElementById('fp-step-3');
             const fpStep4 = document.getElementById('fp-step-4');
             
             // Inputs & Buttons
             const fpUsername = document.getElementById('fp-username');
             const fpBtnNext1 = document.getElementById('fp-btn-next-1');
             const fpError1 = document.getElementById('fp-error-1');
             
             const fpQuestionDisplay = document.getElementById('fp-question-display');
             const fpAnswer = document.getElementById('fp-answer');
             const fpBtnVerify = document.getElementById('fp-btn-verify');
             const fpError2 = document.getElementById('fp-error-2');
             
             const resetForm = document.getElementById('resetPasswordForm');
             const fpNewPass = document.getElementById('fp-new-pass');
             const fpConfirmPass = document.getElementById('fp-confirm-pass');
             const fpMatchError = document.getElementById('fp-match-error');
             const fpLenInd = document.getElementById('fp-len-indicator');
             const fpBtnClose = document.getElementById('fp-btn-close');

             let resetTargetUser = null;

             if (forgotPassBtn) {
                 forgotPassBtn.addEventListener('click', () => {
                     toggleLoginModal(false);
                     openForgotModal();
                 });
             }

             function openForgotModal() {
                 if(!forgotModal) return;
                 resetTargetUser = null;
                 fpUsername.value = '';
                 fpAnswer.value = '';
                 fpNewPass.value = '';
                 fpConfirmPass.value = '';
                 
                 fpStep1.classList.remove('hidden');
                 fpStep2.classList.add('hidden');
                 fpStep3.classList.add('hidden');
                 fpStep4.classList.add('hidden');
                 
                 fpError1.classList.add('hidden');
                 fpError2.classList.add('hidden');

                 forgotModal.classList.remove('hidden');
                 setTimeout(() => {
                     forgotModal.classList.remove('opacity-0');
                     forgotModal.firstElementChild.classList.remove('scale-95');
                     forgotModal.firstElementChild.classList.add('scale-100');
                 }, 10);
             }

             function closeForgotModal() {
                 if(!forgotModal) return;
                 forgotModal.classList.add('opacity-0');
                 forgotModal.firstElementChild.classList.remove('scale-100');
                 forgotModal.firstElementChild.classList.add('scale-95');
                 setTimeout(() => {
                     forgotModal.classList.add('hidden');
                 }, 300);
             }

             if(closeForgotBtn) closeForgotBtn.addEventListener('click', closeForgotModal);
             if(fpBtnClose) fpBtnClose.addEventListener('click', closeForgotModal);

             // Step 1: Check Username
             if(fpBtnNext1) {
                 fpBtnNext1.addEventListener('click', async () => {
                     const username = fpUsername.value.trim();
                     if(!username) return;

                     fpBtnNext1.disabled = true;
                     fpBtnNext1.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Searching...';
                     fpError1.classList.add('hidden');

                     let users = await fetchUsers(); 

                     const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());

                     if(user) {
                         if (user.question && user.answer) {
                             resetTargetUser = user;
                             fpError1.classList.add('hidden');
                             
                             fpQuestionDisplay.innerText = user.question;
                             fpStep1.classList.add('hidden');
                             fpStep2.classList.remove('hidden');
                             fpStep2.classList.add('animate-fadeIn');
                         } else {
                             fpError1.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> Security questions not set up for this account.';
                             fpError1.classList.remove('hidden');
                             fpStep1.classList.add('animate-shake');
                             setTimeout(() => fpStep1.classList.remove('animate-shake'), 500);
                         }
                     } else {
                         fpError1.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> User not found.';
                         fpError1.classList.remove('hidden');
                         fpStep1.classList.add('animate-shake');
                         setTimeout(() => fpStep1.classList.remove('animate-shake'), 500);
                     }

                     fpBtnNext1.disabled = false;
                     fpBtnNext1.innerText = 'Next';
                 });
             }

             // Step 2: Verify Answer
             if(fpBtnVerify) {
                 fpBtnVerify.addEventListener('click', () => {
                     const ans = fpAnswer.value.trim();
                     if(!ans) return;

                     if(resetTargetUser && resetTargetUser.answer.toLowerCase() === ans.toLowerCase()) {
                         fpError2.classList.add('hidden');
                         
                         document.getElementById('fp-form-user').value = resetTargetUser.username;
                         document.getElementById('fp-form-question').value = resetTargetUser.question;

                         fpStep2.classList.add('hidden');
                         fpStep3.classList.remove('hidden');
                         fpStep3.classList.add('animate-fadeIn');
                     } else {
                         fpError2.classList.remove('hidden');
                         fpStep2.classList.add('animate-shake');
                         setTimeout(() => fpStep2.classList.remove('animate-shake'), 500);
                     }
                 });
             }

             // Step 3: Validate & Submit
             if(fpNewPass && fpConfirmPass) {
                 const validateReset = () => {
                     const p1 = fpNewPass.value;
                     const p2 = fpConfirmPass.value;
                     
                     // Length
                     if(p1.length >= 8) {
                         fpLenInd.classList.remove('text-slate-400', 'text-red-500');
                         fpLenInd.classList.add('text-green-500');
                     } else {
                         fpLenInd.classList.remove('text-green-500');
                         fpLenInd.classList.add(p1.length > 0 ? 'text-red-500' : 'text-slate-400');
                     }

                     // Match
                     if(p2 && p1 !== p2) {
                         fpMatchError.classList.remove('hidden');
                     } else {
                         fpMatchError.classList.add('hidden');
                     }
                 };
                 fpNewPass.addEventListener('input', validateReset);
                 fpConfirmPass.addEventListener('input', validateReset);
             }

             if(resetForm) {
                 resetForm.addEventListener('submit', (e) => {
                     const p1 = fpNewPass.value;
                     const p2 = fpConfirmPass.value;

                     if(p1.length < 8 || p1 !== p2) {
                         e.preventDefault();
                         fpStep3.classList.add('animate-shake');
                         setTimeout(() => fpStep3.classList.remove('animate-shake'), 500);
                         return;
                     }

                     const submitBtn = document.getElementById('fp-btn-submit');
                     submitBtn.disabled = true;
                     submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Resetting...';

                     setTimeout(() => {
                         fpStep3.classList.add('hidden');
                         fpStep4.classList.remove('hidden');
                         fpStep4.classList.add('animate-fadeIn');
                         
                         submitBtn.disabled = false;
                         submitBtn.innerText = "Reset Password";
                         resetForm.reset();
                     }, 2000);
                 });
             }

             const logoutBtn = document.getElementById('btn-logout');
             const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
             const errorMsg = document.getElementById('login-error');

             const authGuest = document.getElementById('auth-guest');
             const authUser = document.getElementById('auth-user');
             const mobileAuthGuest = document.getElementById('mobile-auth-guest');
             const mobileAuthUser = document.getElementById('mobile-auth-user');

             function toggleLoginModal(show) {
                 if(!loginModal) return;
                 if(show) {
                     fetchUsers(); 
                     loginModal.classList.remove('hidden');
                     setTimeout(() => {
                         loginModal.classList.remove('opacity-0');
                         if(loginModal.firstElementChild) {
                             loginModal.firstElementChild.classList.remove('scale-95');
                             loginModal.firstElementChild.classList.add('scale-100');
                         }
                         document.getElementById('login-username').focus();
                     }, 10);
                     const mm = document.getElementById('mobile-menu');
                     if(mm) mm.classList.add('hidden');
                 } else {
                     loginModal.classList.add('opacity-0');
                     if(loginModal.firstElementChild) {
                         loginModal.firstElementChild.classList.remove('scale-100');
                         loginModal.firstElementChild.classList.add('scale-95');
                     }
                     setTimeout(() => {
                         loginModal.classList.add('hidden');
                         if(loginForm) loginForm.reset();
                         if(errorMsg) errorMsg.classList.add('hidden');
                     }, 300);
                 }
             }

             if(loginBtnTrigger) loginBtnTrigger.addEventListener('click', () => toggleLoginModal(true));
             if(mobileLoginBtn) mobileLoginBtn.addEventListener('click', () => toggleLoginModal(true));
             if(closeLoginBtn) closeLoginBtn.addEventListener('click', () => toggleLoginModal(false));
             
             const chatLoginBtns = document.querySelectorAll('.trigger-login-chat');
             chatLoginBtns.forEach(btn => {
                 btn.addEventListener('click', () => toggleLoginModal(true));
             });
             
             if(loginModal) loginModal.addEventListener('click', (e) => {
                 if(e.target === loginModal) toggleLoginModal(false);
             });

             function updateAuthUI(forceUser = null) {
                 let user = forceUser;
                 if (!user) {
                     // Use unified session helper
                     user = getSession();
                 }

                 fetchApps();
                 
                 const chatNameInput = document.getElementById('name');
                 
                 const chatInputArea = document.getElementById('chat-input-area');
                 const chatGuestPrompt = document.getElementById('chat-guest-prompt');

                 const communitySection = document.getElementById('community');
                 const navCommunityDesktop = document.getElementById('nav-community-desktop');
                 const navCommunityMobile = document.getElementById('nav-community-mobile');
                 
                 const navSubBtn = document.getElementById('nav-subscribe-btn');
                 const mobSubBtn = document.getElementById('mobile-subscribe-btn');

                 if (user) {
                     if(communitySection) communitySection.classList.remove('hidden');
                     if(navCommunityDesktop) navCommunityDesktop.classList.remove('hidden', 'md:hidden');
                     if(navCommunityDesktop) navCommunityDesktop.classList.add('flex'); 
                     if(navCommunityMobile) navCommunityMobile.classList.remove('hidden');

                     if(chatInputArea) chatInputArea.classList.remove('hidden');
                     if(chatGuestPrompt) chatGuestPrompt.classList.add('hidden');

                     if(chatNameInput) {
                         chatNameInput.value = user.username;
                         chatNameInput.setAttribute('readonly', 'true');
                         chatNameInput.classList.add('text-deped-blue', 'cursor-not-allowed');
                     }

                     if(authGuest) authGuest.classList.add('hidden');
                     if(authUser) authUser.classList.remove('hidden');
                     if(mobileAuthGuest) mobileAuthGuest.classList.add('hidden');
                     if(mobileAuthUser) mobileAuthUser.classList.remove('hidden');

                     const avatarImg = document.getElementById('user-avatar-img');
                     if(avatarImg) {
                        avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=facc15&color=1e3a8a&bold=true&size=128`;
                     }
                     
                     const initial = user.username.charAt(0).toUpperCase();
                     document.getElementById('mobile-user-avatar').innerText = initial;
                     
                     document.getElementById('user-name-display').innerText = user.username;
                     document.getElementById('user-dropdown-name').innerText = user.username;
                     document.getElementById('mobile-user-name').innerText = user.username;
                     
                     let roleLabel = user.role || 'New User'; 
                     let menuValidity = 'Standard Access';
                     
                     const roleLower = user.role ? user.role.trim().toLowerCase() : '';
                     
                     if (roleLower === 'admin') {
                         roleLabel = 'Administrator';
                         menuValidity = 'System Access';
                         if(navSubBtn) navSubBtn.classList.add('hidden'); // Admin don't need sub
                         if(mobSubBtn) mobSubBtn.classList.add('hidden');
                     } else if (roleLower === 'basic user' || roleLower.includes('basic') || roleLower === 'local user') {
                         roleLabel = 'Basic User';
                         menuValidity = 'Standard Access';
                         if(navSubBtn) navSubBtn.classList.remove('hidden'); // Show Upgrade
                         if(mobSubBtn) mobSubBtn.classList.remove('hidden');
                         // Add click listeners to these
                         navSubBtn.onclick = openSubscriptionModal;
                         mobSubBtn.onclick = openSubscriptionModal;
                     } else if (roleLower === 'paid user' || roleLower.includes('paid')) {
                         roleLabel = 'Premium Member';
                         if(navSubBtn) navSubBtn.classList.add('hidden'); // Already paid
                         if(mobSubBtn) mobSubBtn.classList.add('hidden');
                         if (user.expiration) {
                             try {
                                 const expDate = new Date(user.expiration);
                                 menuValidity = `Valid until ${expDate.toLocaleDateString()}`;
                             } catch(e) {
                                 menuValidity = 'Active Membership';
                             }
                         } else {
                             menuValidity = 'Active Membership';
                         }
                     } else {
                         roleLabel = user.role && user.role.length > 1 ? user.role : 'New User';
                         menuValidity = 'Pending Verification';
                         if(navSubBtn) navSubBtn.classList.add('hidden');
                         if(mobSubBtn) mobSubBtn.classList.add('hidden');
                     }

                     const roleDisplayBtn = document.getElementById('user-role-display');
                     if(roleDisplayBtn) roleDisplayBtn.innerText = roleLabel;
                     
                     const mobileRoleDisplay = document.getElementById('mobile-user-role');
                     if(mobileRoleDisplay) mobileRoleDisplay.innerText = roleLabel;
                     
                     const dropValEl = document.getElementById('user-dropdown-validity');
                     if(dropValEl) dropValEl.innerText = menuValidity;

                     const adminLink = document.getElementById('admin-panel-link');
                     if(user.role && user.role.toLowerCase() === 'admin') {
                         if(adminLink) adminLink.classList.remove('hidden');
                     } else {
                         if(adminLink) adminLink.classList.add('hidden');
                     }

                     const statusDot = document.getElementById('user-status-dot');
                     if(statusDot) {
                         statusDot.className = "absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-blue-800 transform translate-y-px translate-x-px";
                         
                         if (roleLower === 'admin' || roleLower.includes('paid') || roleLower.includes('basic') || roleLower.includes('local')) {
                             statusDot.classList.add('bg-green-400');
                             statusDot.title = "Account Verified";
                         } else {
                             statusDot.classList.add('bg-slate-400');
                             statusDot.title = "Pending Verification";
                         }
                     }

                 } else {
                     if(communitySection) communitySection.classList.add('hidden');
                     if(navCommunityDesktop) navCommunityDesktop.classList.add('hidden');
                     if(navCommunityDesktop) navCommunityDesktop.classList.remove('flex');
                     if(navCommunityMobile) navCommunityMobile.classList.add('hidden');

                     if(chatInputArea) chatInputArea.classList.add('hidden');
                     if(chatGuestPrompt) chatGuestPrompt.classList.remove('hidden');

                     if(chatNameInput) {
                         chatNameInput.value = '';
                         chatNameInput.removeAttribute('readonly');
                         chatNameInput.classList.remove('text-deped-blue', 'cursor-not-allowed');
                     }

                     if(authGuest) authGuest.classList.remove('hidden');
                     if(authUser) authUser.classList.add('hidden');
                     if(mobileAuthGuest) mobileAuthGuest.classList.remove('hidden');
                     if(mobileAuthUser) mobileAuthUser.classList.add('hidden');
                 }
             }

             if(loginForm) {
                 loginForm.addEventListener('submit', async (e) => {
                     e.preventDefault();
                     const btn = document.getElementById('btn-login-submit');
                     const usernameInput = document.getElementById('login-username').value.trim();
                     const passwordInput = document.getElementById('login-password').value.trim();
                     const rememberMe = document.getElementById('login-remember').checked;
                     
                     const originalBtnText = btn.innerHTML;
                     btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Verifying...';
                     btn.disabled = true;
                     btn.classList.add('opacity-75');

                     let users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
                     if(users.length === 0) {
                         users = await fetchUsers();
                     }

                     // Case-insensitive username check
                     const validUser = users.find(u => u.username.toLowerCase() === usernameInput.toLowerCase() && u.password === passwordInput);

                     setTimeout(() => {
                         if(validUser) {
                             const sessionData = JSON.stringify({
                                 username: validUser.username, 
                                 role: validUser.role,
                                 expiration: validUser.expiration, 
                                 loginTime: Date.now()
                             });

                             // Storage Logic based on Remember Me
                             if(rememberMe) {
                                 localStorage.setItem('ai_school_session', sessionData);
                                 sessionStorage.removeItem('ai_school_session'); // Clear other type to avoid conflict
                             } else {
                                 sessionStorage.setItem('ai_school_session', sessionData);
                                 localStorage.removeItem('ai_school_session'); // Clear other type
                             }
                             
                             updateAuthUI();
                             toggleLoginModal(false);
                             resetInactivityTimer(); // Start Inactivity Timer
                         } else {
                             errorMsg.classList.remove('hidden');
                             const modalContent = loginModal.firstElementChild;
                             modalContent.classList.add('animate-shake'); 
                             setTimeout(() => modalContent.classList.remove('animate-shake'), 500);
                         }

                         btn.innerHTML = originalBtnText;
                         btn.disabled = false;
                         btn.classList.remove('opacity-75');
                     }, 800); 
                 });
             }

             // --- UPDATED LOGOUT LOGIC with Confirmation & Inactivity ---
             const logoutConfirmModal = document.getElementById('logout-confirm-modal');
             const confirmLogoutBtn = document.getElementById('confirm-logout');
             const cancelLogoutBtn = document.getElementById('cancel-logout');
             
             // Inactivity Timer Variables
             let inactivityTimer;
             const INACTIVITY_LIMIT = 30 * 60 * 1000; // 30 Minutes

             function resetInactivityTimer() {
                 clearTimeout(inactivityTimer);
                 // Only run timer if user is logged in
                 if (getSession()) {
                     inactivityTimer = setTimeout(() => {
                         performLogout(true); // Forced logout
                     }, INACTIVITY_LIMIT);
                 }
             }

             // Reset timer on user activity
             ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => {
                 document.addEventListener(evt, resetInactivityTimer);
             });

             function performLogout(isForced = false) {
                 // Clear BOTH storages to ensure complete logout
                 localStorage.removeItem('ai_school_session');
                 sessionStorage.removeItem('ai_school_session');
                 localStorage.removeItem(CACHE_CONFIG.APPS.KEY); 
                 
                 updateAuthUI();
                 const mm = document.getElementById('mobile-menu');
                 if(mm) mm.classList.add('hidden');
                 
                 // Close modal if open
                 if(logoutConfirmModal) {
                     logoutConfirmModal.classList.add('opacity-0');
                     setTimeout(() => logoutConfirmModal.classList.add('hidden'), 300);
                 }

                 if (isForced) {
                     // Optional: Show a "Session Expired" alert
                     alert("Session expired due to inactivity. Please log in again.");
                 }
             }

             function handleLogout() {
                 if(!logoutConfirmModal) {
                     performLogout(); // Fallback if modal missing
                     return;
                 }
                 
                 // Show Confirmation Modal
                 logoutConfirmModal.classList.remove('hidden');
                 setTimeout(() => {
                     logoutConfirmModal.classList.remove('opacity-0');
                     if(logoutConfirmModal.firstElementChild) {
                         logoutConfirmModal.firstElementChild.classList.remove('scale-95');
                         logoutConfirmModal.firstElementChild.classList.add('scale-100');
                     }
                 }, 10);
             }

             if(confirmLogoutBtn) {
                 confirmLogoutBtn.addEventListener('click', () => performLogout(false));
             }

             if(cancelLogoutBtn) {
                 cancelLogoutBtn.addEventListener('click', () => {
                     logoutConfirmModal.classList.add('opacity-0');
                     if(logoutConfirmModal.firstElementChild) {
                         logoutConfirmModal.firstElementChild.classList.remove('scale-100');
                         logoutConfirmModal.firstElementChild.classList.add('scale-95');
                     }
                     setTimeout(() => logoutConfirmModal.classList.add('hidden'), 300);
                 });
             }
             
             // Close on background click
             if(logoutConfirmModal) {
                 logoutConfirmModal.addEventListener('click', (e) => {
                     if(e.target === logoutConfirmModal) cancelLogoutBtn.click();
                 });
             }

             if(logoutBtn) logoutBtn.addEventListener('click', handleLogout);
             if(mobileLogoutBtn) mobileLogoutBtn.addEventListener('click', handleLogout);

             const userMenuBtn = document.getElementById('user-menu-btn');
             const userDropdown = document.getElementById('user-dropdown');
             const userMenuIcon = document.getElementById('user-menu-icon');

             if (userMenuBtn && userDropdown) {
                 userMenuBtn.addEventListener('click', (e) => {
                     e.stopPropagation(); 
                     const isOpen = !userDropdown.classList.contains('opacity-0');
                     
                     if (isOpen) {
                         userDropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                         userDropdown.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
                         if(userMenuIcon) userMenuIcon.classList.remove('rotate-180');
                     } else {
                         userDropdown.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                         userDropdown.classList.add('opacity-100', 'scale-100', 'pointer-events-auto');
                         if(userMenuIcon) userMenuIcon.classList.add('rotate-180');
                     }
                 });

                 document.addEventListener('click', (e) => {
                     if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                         userDropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                         userDropdown.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
                         if(userMenuIcon) userMenuIcon.classList.remove('rotate-180');
                     }
                 });
             }

             updateAuthUI();
             fetchUsers();

             const regModal = document.getElementById('register-modal');
             const regTriggers = document.querySelectorAll('.trigger-register');
             const regClose = document.getElementById('close-register-modal');
             const mobileMenu = document.getElementById('mobile-menu');
             const regContent = document.getElementById('reg-content');

             function openRegModal() {
                 if(!regModal) return;
                 toggleLoginModal(false); 
                 
                 if(regSuccess) {
                     regSuccess.classList.add('hidden');
                     regSuccess.classList.remove('flex');
                 }
                 if(regContent) regContent.classList.remove('hidden');

                 regModal.classList.remove('hidden');
                 if(mobileMenu && !mobileMenu.classList.contains('hidden')) {
                     mobileMenu.classList.add('hidden');
                 }
                 setTimeout(() => {
                     regModal.classList.remove('opacity-0');
                     if(regModal.firstElementChild) {
                         regModal.firstElementChild.classList.remove('scale-95');
                         regModal.firstElementChild.classList.add('scale-100');
                     }
                 }, 10);
             }

             function closeRegModal() {
                 if(!regModal) return;
                 regModal.classList.add('opacity-0');
                 if(regModal.firstElementChild) {
                     regModal.firstElementChild.classList.remove('scale-100');
                     regModal.firstElementChild.classList.add('scale-95');
                 }
                 setTimeout(() => {
                     regModal.classList.add('hidden');
                     if(regForm) regForm.reset();
                     if(regSuccess) {
                         regSuccess.classList.add('hidden');
                         regSuccess.classList.remove('flex');
                     }
                     if(regContent) regContent.classList.remove('hidden');
                 }, 300);
             }

             regTriggers.forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     openRegModal();
                 });
             });

             if(regClose) regClose.addEventListener('click', closeRegModal);
             
             if(regModal) {
                regModal.addEventListener('click', (e) => {
                    if(e.target === regModal) closeRegModal();
                });
             }

             // --- NEW: SUBSCRIPTION MODAL LOGIC ---
             const subModal = document.getElementById('subscription-modal');
             const closeSubBtn = document.getElementById('close-subscription-modal');
             const subSuccessClose = document.getElementById('btn-sub-close');
             const subForm = document.getElementById('subscriptionForm');
             const subContent = document.getElementById('sub-content');
             const subSuccess = document.getElementById('sub-success');
             const subUsernameInput = document.getElementById('sub-username');

             // Function to open subscription modal (Used by Upgrade button)
             window.openSubscriptionModal = function() {
                 if(!subModal) return;
                 
                 // Use unified session helper
                 const user = getSession();
                 if (!user) {
                     toggleLoginModal(true);
                     return;
                 }
                 if(subUsernameInput) subUsernameInput.value = user.username;

                 // Reset View
                 if(subContent) subContent.classList.remove('hidden');
                 if(subSuccess) subSuccess.classList.add('hidden');

                 subModal.classList.remove('hidden');
                 setTimeout(() => {
                     subModal.classList.remove('opacity-0');
                     if(subModal.firstElementChild) {
                         subModal.firstElementChild.classList.remove('scale-95');
                         subModal.firstElementChild.classList.add('scale-100');
                     }
                 }, 10);
             };

             // NEW: Dynamic Backup Link Generator
             // const backupLink = document.getElementById('backup-form-link'); // Not needed for dynamic updates anymore
             const subRefInput = document.getElementById('sub-ref');
             // const subAmountInput = document.getElementById('sub-amount');
             
             // Input Formatting Logic
             if (subRefInput) {
                 subRefInput.addEventListener('input', (e) => {
                     // 4 digit gap for Reference Number (e.g., 1234 5678 9012)
                     let val = e.target.value.replace(/\D/g, '');
                     val = val.replace(/(.{4})/g, '$1 ').trim();
                     e.target.value = val;
                 });
             }

             function closeSubModal() {
                 if(!subModal) return;
                 subModal.classList.add('opacity-0');
                 if(subModal.firstElementChild) {
                     subModal.firstElementChild.classList.remove('scale-100');
                     subModal.firstElementChild.classList.add('scale-95');
                 }
                 setTimeout(() => {
                     subModal.classList.add('hidden');
                 }, 300);
             }

             if(closeSubBtn) closeSubBtn.addEventListener('click', closeSubModal);
             if(subSuccessClose) subSuccessClose.addEventListener('click', closeSubModal);
             if(subModal) subModal.addEventListener('click', (e) => { if(e.target === subModal) closeSubModal(); });

             if(subForm) {
                 subForm.addEventListener('submit', (e) => {
                     // Ensure the form submits
                     const btn = document.getElementById('btn-sub-submit');
                     btn.disabled = true;
                     btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Submitting...';
                     
                     // Form submits naturally to iframe (no preventDefault here, or handle manually)
                     // But we want to show success UI.
                     setTimeout(() => {
                         if(subContent) subContent.classList.add('hidden');
                         if(subSuccess) subSuccess.classList.remove('hidden');
                         btn.disabled = false;
                         btn.innerHTML = '<span>Submit Verification Request</span><i class="fa-solid fa-arrow-right"></i>';
                     }, 1500);
                 });
             }
             
             // --- ADMIN DASHBOARD LOGIC (ENHANCED) ---
             const adminModal = document.getElementById('admin-modal');
             const adminLink = document.getElementById('admin-panel-link');
             const closeAdminBtn = document.getElementById('close-admin-modal');
             const adminSearch = document.getElementById('admin-search');
             const adminLoader = document.getElementById('admin-loader');
             
             // Global State for Tab Tracking
             let currentAdminTab = 'dashboard';

             // *** PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE ***
             const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxh-eEX1ESB1WJMRBaEqCZ7MIJMf5c-wGdX0cquON0qZgcrmhWSXOmZe7eXsgsKYUISNw/exec"; 
             
             // Tab Logic
             window.switchAdminTab = function(tabName) {
                 currentAdminTab = tabName; // Update active tab state

                 // Update Buttons
                 document.querySelectorAll('[id^="tab-btn-"]').forEach(btn => {
                     // Check if button ID matches current tab
                     if (btn.id === `tab-btn-${tabName}`) {
                         btn.classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                         btn.classList.add('bg-blue-600', 'text-white', 'shadow-md', 'border', 'border-blue-500/50');
                     } else {
                         btn.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                         btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'border', 'border-blue-500/50');
                     }
                 });

                 // Update Content
                 document.querySelectorAll('.admin-tab-content').forEach(content => {
                     if (content.id === `admin-tab-${tabName}`) {
                         content.classList.remove('hidden');
                     } else {
                         content.classList.add('hidden');
                     }
                 });

                 // Load Specific Data if needed
                 if (tabName === 'content') loadAdminTools();
                 if (tabName === 'communications') loadAdminComm();
                 if (tabName === 'payments') {
                     loadAdminPayments();
                     // Also refresh the badge when entering the tab
                     checkPaymentNotifications(); 
                 }
             };

             // NEW: Filter Logic for Stat Cards
             window.filterAdminUsers = function(type) {
                 currentAdminFilterType = type; // Update Global State
                 
                 const users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
                 const filtered = getFilteredUsers(users, type);
                 
                 // Clear search input to avoid confusion (we are showing a category subset)
                 if(adminSearch) adminSearch.value = '';
                 
                 // Render the filtered list directly
                 if(window.renderAdminUserList) window.renderAdminUserList(filtered);
             };

             // NEW: Manual Refresh Function
             window.refreshAdminData = async function() {
                 const btn = document.getElementById('btn-admin-refresh');
                 const icon = btn.querySelector('i');
                 
                 if(btn) btn.disabled = true;
                 if(icon) icon.classList.add('fa-spin');
                 
                 // Clear cache to force Gviz fetch
                 localStorage.removeItem(CACHE_CONFIG.USERS.KEY);
                 localStorage.removeItem(CACHE_CONFIG.USERS.TS);
                 
                 try {
                     const users = await fetchUsers(); 
                     // Explicitly update just in case
                     if(window.updateAdminStats) window.updateAdminStats(users);
                     
                     // Apply current filter on manual refresh too
                     const filtered = getFilteredUsers(users, currentAdminFilterType);
                     if(window.renderAdminUserList) window.renderAdminUserList(filtered);
                     
                 } catch(e) {
                     console.error(e);
                 } finally {
                     if(btn) btn.disabled = false;
                     if(icon) icon.classList.remove('fa-spin');
                 }
             };

             function openAdminDashboard() {
                 if(!adminModal) return;
                 
                 // Reset to Dashboard Tab
                 switchAdminTab('dashboard');

                 // Update Dashboard Data immediately from cache
                 let users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
                 if(window.updateAdminStats) window.updateAdminStats(users);
                 
                 // Reset filter to 'all' on open, or keep previous? Usually reset is better UX on open
                 currentAdminFilterType = 'all';
                 if(window.renderAdminUserList) window.renderAdminUserList(users);

                 // Trigger a fresh fetch in background to ensure numbers are real-time
                 // This handles the "13 vs 1" issue if cache was stale
                 refreshAdminData();
                 
                 // NEW: Check for pending payments to show badge
                 checkPaymentNotifications();

                 // Show Modal
                 adminModal.classList.remove('hidden');
                 setTimeout(() => {
                     adminModal.classList.remove('opacity-0');
                     if(adminModal.firstElementChild) {
                         adminModal.firstElementChild.classList.remove('scale-95');
                         adminModal.firstElementChild.classList.add('scale-100');
                     }
                 }, 10);
             }

             // Attached to window for Global Access
             window.updateAdminStats = function(users) {
                 // Ensure users is valid array
                 if (!Array.isArray(users)) users = [];

                 const total = users.length;
                 const pending = users.filter(u => u.role.toLowerCase() === 'new user').length;
                 const premium = users.filter(u => u.role.toLowerCase().includes('paid')).length;
                 const basic = users.filter(u => u.role.toLowerCase().includes('basic') || u.role.toLowerCase().includes('local')).length;
                 
                 // Calculate Expired OR Expiring Soon (Next 7 Days)
                 const now = new Date();
                 const nextWeek = new Date();
                 nextWeek.setDate(now.getDate() + 7);
                 
                 const expired = users.filter(u => u.expiration && new Date(u.expiration) < nextWeek).length;

                 const setStat = (id, val) => {
                     const el = document.getElementById(id);
                     if(el) el.innerText = val;
                 };

                 setStat('stat-total', total);
                 setStat('stat-pending', pending);
                 setStat('stat-basic', basic);
                 setStat('stat-premium', premium);
                 setStat('stat-expired', expired);

                 // Update Visual Distribution Bar
                 // Exclude Admin from distribution total so bars fill 100% of standard users
                 const distributionTotal = premium + basic + pending;

                 if (distributionTotal > 0) {
                     const pPct = (premium / distributionTotal) * 100;
                     const bPct = (basic / distributionTotal) * 100;
                     const penPct = (pending / distributionTotal) * 100;
                     
                     const barP = document.getElementById('bar-premium');
                     const barB = document.getElementById('bar-basic');
                     const barPen = document.getElementById('bar-pending');
                     
                     if(barP) barP.style.width = `${pPct}%`;
                     if(barB) barB.style.width = `${bPct}%`;
                     if(barPen) barPen.style.width = `${penPct}%`;
                 } else {
                     const barP = document.getElementById('bar-premium');
                     const barB = document.getElementById('bar-basic');
                     const barPen = document.getElementById('bar-pending');
                     if(barP) barP.style.width = `0%`;
                     if(barB) barB.style.width = `0%`;
                     if(barPen) barPen.style.width = `0%`;
                 }
             }

             // NEW: Export to CSV Function
             window.exportToCSV = function(type) {
                 let data = [];
                 let filename = '';
                 let headers = [];

                 if (type === 'users') {
                     const users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
                     if (users.length === 0) { alert('No user data to export.'); return; }
                     filename = 'Users_Export_' + new Date().toLocaleDateString().replace(/\//g, '-') + '.csv';
                     headers = ['Username', 'Full Name', 'Role', 'Start Date', 'Expiration Date', 'Message'];
                     
                     data = users.map(u => [
                         u.username,
                         u.fullname || '',
                         u.role,
                         u.start ? new Date(u.start).toLocaleDateString() : '',
                         u.expiration ? new Date(u.expiration).toLocaleDateString() : '',
                         (u.message || '').replace(/,/g, ';') // Simple escape for CSV
                     ]);
                 } else if (type === 'payments') {
                     // Use the cached payment data from the render function context
                     if (!paymentDataCache || paymentDataCache.length === 0) { alert('No payment data loaded. Please refresh the table first.'); return; }
                     filename = 'Payments_Export_' + new Date().toLocaleDateString().replace(/\//g, '-') + '.csv';
                     headers = ['Date/Time', 'Username', 'Full Name', 'Reference No', 'Amount'];
                     
                     data = paymentDataCache.map(p => [
                         p.timestamp.replace(/,/g, ''),
                         p.username,
                         p.fullName,
                         p.refNo,
                         p.amount
                     ]);
                 }

                 if (data.length === 0) return;

                 const csvContent = [
                     headers.join(','),
                     ...data.map(row => row.join(','))
                 ].join('\n');

                 const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                 const url = URL.createObjectURL(blob);
                 const link = document.createElement('a');
                 link.setAttribute('href', url);
                 link.setAttribute('download', filename);
                 link.style.visibility = 'hidden';
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
             };

             // Attached to window for Global Access
             window.renderAdminUserList = function(users, filter = '') {
                 const listBody = document.getElementById('admin-user-list');
                 // Update Header (ensure consistency if JS re-renders)
                 const tableHead = document.querySelector('#admin-user-list').previousElementSibling;
                 if(tableHead) {
                     tableHead.innerHTML = `
                        <tr>
                            <th class="px-6 py-4 border-b border-slate-200 bg-slate-50 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-[30%]">User Profile</th>
                            <th class="px-6 py-4 border-b border-slate-200 bg-slate-50 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-[20%] text-center">Current Role</th>
                            <th class="px-6 py-4 border-b border-slate-200 bg-slate-50 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-[35%]">Subscription Status</th>
                            <th class="px-6 py-4 border-b border-slate-200 bg-slate-50 text-right text-xs font-extrabold text-slate-500 uppercase tracking-wider w-[15%]">Manage</th>
                        </tr>
                     `;
                 }

                 if(!listBody) return;
                 listBody.innerHTML = '';
                 
                 const filtered = users.filter(u => u.username.toLowerCase().includes(filter.toLowerCase()) || u.fullname.toLowerCase().includes(filter.toLowerCase()));
                 
                 if(filtered.length === 0) {
                      listBody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">No users found matching "${filter}"</td></tr>`;
                      return;
                 }

                 filtered.forEach(u => {
                     const tr = document.createElement('tr');
                     tr.className = 'hover:bg-slate-50 transition group cursor-default border-b border-slate-50 last:border-b-0';
                     
                     let roleBadge = '';
                     let statusDot = 'bg-slate-400';
                     let subDetails = '<span class="text-slate-400 text-[10px] italic">No active subscription</span>';
                     const r = u.role.toLowerCase();

                     // Role Logic
                     if(r === 'admin') { 
                         roleBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider bg-slate-800 text-white border border-slate-700 shadow-sm"><i class="fa-solid fa-shield-halved"></i> Admin</span>';
                         statusDot = 'bg-green-500'; 
                         subDetails = '<span class="text-slate-500 text-[10px] font-medium bg-slate-100 px-2 py-1 rounded">System Access</span>';
                     }
                     else if(r.includes('paid')) { 
                         roleBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider bg-purple-100 text-purple-700 border border-purple-200 shadow-sm"><i class="fa-solid fa-crown"></i> Premium</span>'; 
                         statusDot = 'bg-green-500';
                         
                         // Date Formatting
                         const start = u.start ? new Date(u.start).toLocaleDateString(undefined, {month:'short', day:'numeric', year:'numeric'}) : 'N/A';
                         const end = u.expiration ? new Date(u.expiration).toLocaleDateString(undefined, {month:'short', day:'numeric', year:'numeric'}) : 'N/A';
                         
                         // Calculate days left
                         let daysLeftHTML = '';
                         if(u.expiration) {
                             const days = Math.ceil((new Date(u.expiration) - new Date()) / (1000 * 60 * 60 * 24));
                             if(days < 0) daysLeftHTML = `<span class="text-red-500 font-bold ml-1">(Expired)</span>`;
                             else daysLeftHTML = `<span class="text-green-600 font-bold ml-1">(${days} days left)</span>`;
                         }

                         subDetails = `
                            <div class="flex flex-col gap-1.5 text-[10px]">
                                <div class="flex items-center gap-2">
                                    <div class="w-5 h-5 rounded bg-green-50 text-green-600 flex items-center justify-center"><i class="fa-solid fa-calendar-check"></i></div>
                                    <span class="text-slate-500">Start: <span class="font-bold text-slate-700">${start}</span></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-5 h-5 rounded bg-red-50 text-red-500 flex items-center justify-center"><i class="fa-solid fa-flag-checkered"></i></div>
                                    <span class="text-slate-500">End: <span class="font-bold text-slate-700">${end}</span> ${daysLeftHTML}</span>
                                </div>
                            </div>
                         `;
                     }
                     else if(r.includes('basic') || r.includes('local')) { 
                         roleBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider bg-green-100 text-green-700 border border-green-200 shadow-sm"><i class="fa-solid fa-user"></i> Basic</span>'; 
                         statusDot = 'bg-green-500';
                     }
                     else { 
                         roleBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider bg-yellow-100 text-yellow-700 border border-yellow-200 shadow-sm animate-pulse"><i class="fa-solid fa-clock"></i> Pending</span>'; 
                         statusDot = 'bg-yellow-500 animate-pulse'; 
                     }

                     // Safe escape for username in onclick
                     const safeUsername = u.username.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                     const displayName = u.fullname || '<span class="italic text-slate-400">No Name</span>';

                     tr.innerHTML = `
                         <td class="px-6 py-4 align-top">
                             <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded-full bg-slate-100 flex-shrink-0 flex items-center justify-center text-sm text-slate-500 font-bold border border-slate-200 shadow-sm ring-2 ring-white">
                                    ${u.username.charAt(0).toUpperCase()}
                                 </div>
                                 <div>
                                     <div class="flex items-center gap-2">
                                         <span class="block text-sm font-bold text-slate-800" title="${u.username}">${u.username}</span>
                                         <span class="w-2 h-2 rounded-full ${statusDot}" title="Status"></span>
                                     </div>
                                     <span class="block text-[11px] text-slate-500 font-medium">${displayName}</span>
                                 </div>
                             </div>
                         </td>
                         <td class="px-6 py-4 align-top text-center">
                             ${roleBadge}
                         </td>
                         <td class="px-6 py-4 align-top">
                             ${subDetails}
                         </td>
                         <td class="px-6 py-4 text-right whitespace-nowrap align-middle">
                             <button onclick="openEditModal('${safeUsername}', 'dashboard')" class="group text-xs bg-white hover:bg-blue-50 text-slate-600 hover:text-blue-600 px-4 py-2 rounded-lg font-bold shadow-sm border border-slate-200 hover:border-blue-200 transition-all duration-200 flex items-center gap-2 ml-auto">
                                <i class="fa-solid fa-pen-to-square"></i> <span>Edit</span>
                             </button>
                         </td>
                     `;
                     listBody.appendChild(tr);
                 });
             }

             // NEW: Fetch Payment Data (Moved inside DOMContentLoaded)
             let paymentDataCache = []; // Store raw data for filtering

             window.renderAdminPayments = function(filter = '') {
                 const listBody = document.getElementById('admin-payment-list');
                 if(!listBody) return;
                 
                 listBody.innerHTML = '';
                 const searchLower = filter.toLowerCase();
                 // Normalize for flexible Ref No search (remove spaces)
                 const searchRefNormalized = searchLower.replace(/\s+/g, '');
                 
                 const filtered = paymentDataCache.filter(p => {
                     // 1. Standard Name Search (Username/Fullname) - Respects spaces
                     const nameMatch = p.username.toLowerCase().includes(searchLower) || 
                                       p.fullName.toLowerCase().includes(searchLower);
                                       
                     // 2. Flexible Ref No Search - Ignores spaces
                     // Remove all spaces from the stored Reference Number for comparison
                     const refRaw = p.refNo.toLowerCase().replace(/\s+/g, '');
                     
                     // Prevent match on empty normalized string unless input was truly empty
                     const refMatch = (searchRefNormalized.length > 0 || searchLower.length === 0) && refRaw.includes(searchRefNormalized);
                     
                     return nameMatch || refMatch;
                 });

                 if (filtered.length === 0) {
                     if (paymentDataCache.length === 0) {
                         listBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-slate-400">No payment requests found.</td></tr>';
                     } else {
                         listBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-slate-400">No matches found.</td></tr>';
                     }
                     return;
                 }

                 filtered.forEach(p => {
                     // Date Formatting Logic for 2-Row Layout
                     let dateDisplay = p.timestamp;
                     let timeDisplay = '';
                     
                     // Attempt to split common formats like "12/25/2025, 2:30 PM"
                     if (p.timestamp.includes(',')) {
                         const parts = p.timestamp.split(',');
                         dateDisplay = parts[0].trim();
                         timeDisplay = parts.slice(1).join(',').trim();
                     } else if (p.timestamp.includes(' at ')) { 
                         const parts = p.timestamp.split(' at ');
                         dateDisplay = parts[0].trim();
                         timeDisplay = parts[1].trim();
                     } else {
                         // Fallback: try splitting by first space if format is "YYYY-MM-DD HH:MM"
                         const parts = p.timestamp.split(' ');
                         if(parts.length > 1) {
                             dateDisplay = parts[0];
                             timeDisplay = parts.slice(1).join(' ');
                         }
                     }

                     const tr = document.createElement('tr');
                     tr.className = 'hover:bg-slate-50 transition border-b border-slate-50 last:border-b-0';
                     tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-col">
                                <span class="font-bold text-slate-700 text-xs">${dateDisplay}</span>
                                <span class="text-[10px] text-slate-400 font-mono mt-0.5">${timeDisplay}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 font-bold text-sm border border-blue-100 shadow-sm flex-shrink-0">
                                    ${p.username.charAt(0).toUpperCase()}
                                </div>
                                <div class="min-w-0">
                                    <p class="font-bold text-slate-800 text-sm truncate">${p.fullName}</p>
                                    <p class="text-xs text-slate-500 font-medium truncate">@${p.username}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-col">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Reference No.</span>
                                <span class="font-mono text-xs font-bold text-slate-700 bg-slate-100 px-2.5 py-1.5 rounded-lg border border-slate-200 select-all whitespace-nowrap w-fit shadow-sm">
                                    ${p.refNo}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 align-middle">
                             <div class="flex flex-col justify-center">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Paid</span>
                                <span class="font-bold text-emerald-600 text-sm">₱${p.amount}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right align-middle">
                            <button onclick="openEditModal('${p.safeUser}', 'payment')" class="group text-xs bg-slate-800 hover:bg-blue-600 text-white px-4 py-2.5 rounded-xl font-bold shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 ml-auto">
                                <span>Verify</span> <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                            </button>
                        </td>
                     `;
                     listBody.appendChild(tr);
                 });
                 
                 // Update badge based on TOTAL pending
                 const badge = document.getElementById('payment-badge');
                 if (badge) {
                     const count = paymentDataCache.length;
                     badge.innerText = count;
                     if (count > 0) badge.classList.remove('hidden');
                     else badge.classList.add('hidden');
                 }
             };

             window.loadAdminPayments = async function() {
                const listBody = document.getElementById('admin-payment-list');
                if(!listBody) return;
                
                // Only show loading if cache is empty
                if(paymentDataCache.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-slate-400"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Fetching payment records...</td></tr>';
                }

                const sheetId = '1p69v6YNSjn8n7IrW9h0Qk9get61eh-ONYNxaMz76RFA';
                const sheetName = 'Form Responses 4'; // Target Sheet
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&nocache=${Date.now()}`;

                try {
                    const response = await fetch(url);
                    const text = await response.text();
                    const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                    
                    if (jsonMatch && jsonMatch[1]) {
                        const json = JSON.parse(jsonMatch[1]);
                        const rows = json.table?.rows || [];
                        const users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');

                        paymentDataCache = []; // Clear cache
                        
                        // Iterate in reverse to show newest first
                        [...rows].reverse().forEach(row => {
                            if (!row.c) return;

                            const tsCell = row.c[0];
                            const userCell = row.c[1];
                            const refCell = row.c[3]; // Column D
                            const amtCell = row.c[6]; // Column G

                            if (!userCell || !userCell.v) return;

                            const username = String(userCell.v).trim();
                            const timestamp = tsCell ? (tsCell.f || parseGvizDate(tsCell.v)?.toLocaleString() || 'Unknown') : 'Unknown';
                            const refNo = refCell ? String(refCell.v) : '---';
                            const amount = amtCell ? String(amtCell.v) : '---';

                            const userMatch = users.find(u => u.username.toLowerCase() === username.toLowerCase());
                            
                            // FILTER: Hide Active Paid Users & Admins
                            if (userMatch) {
                                const role = userMatch.role.toLowerCase();
                                const now = new Date();
                                if (role === 'admin') return;
                                if (role.includes('paid')) {
                                    if (userMatch.expiration) {
                                        const expDate = new Date(userMatch.expiration);
                                        if (expDate > now) return; 
                                    } else {
                                        return;
                                    }
                                }
                            }

                            const fullName = userMatch && userMatch.fullname ? userMatch.fullname : '<span class="text-slate-400 italic">Unknown Name</span>';
                            const safeUser = username.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                            paymentDataCache.push({ timestamp, username, fullName, refNo, amount, safeUser });
                        });
                        
                        // Render with current search term
                        const searchInput = document.getElementById('payment-search');
                        const currentFilter = searchInput ? searchInput.value : '';
                        renderAdminPayments(currentFilter);

                    } else {
                        listBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-400">Failed to parse data.</td></tr>';
                    }
                } catch (err) {
                    console.error(err);
                    listBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-400">Connection failed. Unable to fetch sheet.</td></tr>';
                }
             };
             
             // Bind Search Input
             const paymentSearchInput = document.getElementById('payment-search');
             if (paymentSearchInput) {
                 paymentSearchInput.addEventListener('input', (e) => {
                     renderAdminPayments(e.target.value);
                 });
             }

             // NEW: Check for Payment Notifications (Badge Logic)
             window.checkPaymentNotifications = async function() {
                 const badge = document.getElementById('payment-badge');
                 if (!badge) return;

                 const sheetId = '1p69v6YNSjn8n7IrW9h0Qk9get61eh-ONYNxaMz76RFA';
                 const sheetName = 'Form Responses 4';
                 const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&nocache=${Date.now()}`;

                 try {
                     const response = await fetch(url);
                     const text = await response.text();
                     const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                     
                     if (jsonMatch && jsonMatch[1]) {
                         const json = JSON.parse(jsonMatch[1]);
                         const rows = json.table?.rows || [];
                         const users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
                         let count = 0;

                         rows.forEach(row => {
                             if (!row.c || !row.c[1]) return;
                             const username = String(row.c[1].v).trim();
                             const userMatch = users.find(u => u.username.toLowerCase() === username.toLowerCase());

                             // Apply same filter logic as table
                             if (userMatch) {
                                 const role = userMatch.role.toLowerCase();
                                 const now = new Date();
                                 if (role === 'admin') return;
                                 if (role.includes('paid')) {
                                     if (userMatch.expiration) {
                                         const expDate = new Date(userMatch.expiration);
                                         if (expDate > now) return; 
                                     } else {
                                         return;
                                     }
                                 }
                             }
                             count++;
                         });

                         badge.innerText = count;
                         if (count > 0) badge.classList.remove('hidden');
                         else badge.classList.add('hidden');
                     }
                 } catch (err) {
                     console.error("Failed to check payments for badge", err);
                 }
             };

             // --- EDIT MODAL LOGIC ---
             const editModal = document.getElementById('admin-edit-modal');
             const editForm = document.getElementById('admin-edit-form');
             const roleSelect = document.getElementById('edit-role');
             const premiumOptions = document.getElementById('premium-options');
             
             // Role Change Listener
             if(roleSelect) {
                 roleSelect.addEventListener('change', (e) => {
                     if(e.target.value === 'Paid User') {
                         premiumOptions.classList.remove('hidden');
                     } else {
                         premiumOptions.classList.add('hidden');
                         // Clear dates if switching away from Paid User
                         document.getElementById('edit-start-date').value = '';
                         document.getElementById('edit-expiration-date').value = '';
                         document.getElementById('date-preview').classList.add('hidden');
                         document.querySelectorAll('.duration-btn').forEach(btn => {
                             btn.classList.remove('bg-yellow-500', 'text-white', 'border-yellow-600');
                             btn.classList.add('bg-white', 'text-yellow-700', 'border-yellow-300');
                         });
                     }
                 });
             }

             // Duration Button Logic
             window.setPremiumDuration = function(months, btnElement) {
                 // 1. Reset Styles
                 document.querySelectorAll('.duration-btn').forEach(btn => {
                     btn.classList.remove('bg-yellow-500', 'text-white', 'border-yellow-600');
                     btn.classList.add('bg-white', 'text-yellow-700', 'border-yellow-300');
                 });
                 
                 // 2. Active Style
                 btnElement.classList.remove('bg-white', 'text-yellow-700', 'border-yellow-300');
                 btnElement.classList.add('bg-yellow-500', 'text-white', 'border-yellow-600');

                 // 3. Calculate Dates
                 const now = new Date();
                 const expiry = new Date(now);
                 expiry.setMonth(now.getMonth() + months);

                 // Format for display and storage
                 const startStr = now.toISOString();
                 const endStr = expiry.toISOString();
                 
                 const displayOpt = { year: 'numeric', month: 'short', day: 'numeric' };

                 document.getElementById('edit-start-date').value = startStr;
                 document.getElementById('edit-expiration-date').value = endStr;
                 
                 document.getElementById('preview-start').innerText = now.toLocaleDateString('en-US', displayOpt);
                 document.getElementById('preview-end').innerText = expiry.toLocaleDateString('en-US', displayOpt);
                 document.getElementById('date-preview').classList.remove('hidden');
             };
             
             window.openEditModal = function(username, source = 'dashboard') {
                 if(!editModal) return;
                 const users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
                 const user = users.find(u => u.username === username);
                 if(!user) return;

                 document.getElementById('edit-username-hidden').value = user.username;
                 document.getElementById('edit-username-display').value = user.username;
                 document.getElementById('edit-message').value = user.message || '';
                 
                 // Reset Date Inputs
                 document.getElementById('edit-start-date').value = '';
                 document.getElementById('edit-expiration-date').value = '';
                 document.getElementById('date-preview').classList.add('hidden');
                 document.querySelectorAll('.duration-btn').forEach(btn => {
                     btn.classList.remove('bg-yellow-500', 'text-white', 'border-yellow-600');
                     btn.classList.add('bg-white', 'text-yellow-700', 'border-yellow-300');
                 });
                 
                 const roleSelect = document.getElementById('edit-role');
                 const options = roleSelect.options;

                 // Reset all options visibility/state first
                 for(let i=0; i<options.length; i++) {
                     options[i].hidden = false;
                     options[i].disabled = false;
                 }

                 if (source === 'payment') {
                     // Payment Mode: Lock to Paid User
                     for(let i=0; i<options.length; i++) {
                         if(options[i].value !== 'Paid User') {
                             options[i].hidden = true;
                             options[i].disabled = true;
                         }
                     }
                     roleSelect.value = "Paid User";
                     premiumOptions.classList.remove('hidden');
                 } else {
                     // Dashboard Mode: Allow all, map current role
                     const r = user.role.toLowerCase();
                     
                     if(r.includes('paid')) {
                         roleSelect.value = "Paid User";
                         premiumOptions.classList.remove('hidden');
                     }
                     else if(r.includes('admin')) {
                         roleSelect.value = "Admin";
                         premiumOptions.classList.add('hidden');
                     }
                     else if(r.includes('basic') || r.includes('local')) {
                         roleSelect.value = "Basic User";
                         premiumOptions.classList.add('hidden');
                     }
                     else {
                         roleSelect.value = "New User";
                         premiumOptions.classList.add('hidden');
                     }
                 }

                 editModal.classList.remove('hidden');
             };

             // NEW: Helper to auto-fill messages
             window.insertThankYouMessage = function() {
                 const msgField = document.getElementById('edit-message');
                 const status = document.getElementById('insert-status');
                 if(msgField) {
                     msgField.value = "🌟 THANK YOU: We truly appreciate your support for the Digital AI Vision for Education program. Your Premium access is now active.";
                     // Visual Feedback
                     msgField.classList.add('ring-2', 'ring-green-300', 'border-green-300');
                     setTimeout(() => msgField.classList.remove('ring-2', 'ring-green-300', 'border-green-300'), 500);
                     
                     if(status) {
                         status.innerText = "Set: Thank You Message";
                         status.className = "text-[10px] font-bold h-4 transition-colors duration-300 text-green-600";
                     }
                 }
             };

             window.insertExpirationMessage = function() {
                 const msgField = document.getElementById('edit-message');
                 const status = document.getElementById('insert-status');
                 if(msgField) {
                     msgField.value = "⚠️ ACCOUNT NOTICE: Your premium account is nearing expiration or has expired. Please renew to maintain access to exclusive tools.";
                     // Visual Feedback
                     msgField.classList.add('ring-2', 'ring-pink-300', 'border-pink-300');
                     setTimeout(() => msgField.classList.remove('ring-2', 'ring-pink-300', 'border-pink-300'), 500);
                     
                     if(status) {
                         status.innerText = "Set: Expiration Notice";
                         status.className = "text-[10px] font-bold h-4 transition-colors duration-300 text-pink-600";
                     }
                 }
             };

             window.closeEditModal = function() {
                 if(editModal) editModal.classList.add('hidden');
                 // Reset status
                 const status = document.getElementById('insert-status');
                 if(status) status.innerText = "";
             };

             if(editForm) {
                 editForm.addEventListener('submit', async (e) => {
                     e.preventDefault();
                     
                     // 1. Check if URL is missing
                     if(!GOOGLE_SCRIPT_URL) {
                         alert("Configuration Error: The GOOGLE_SCRIPT_URL is missing.\n\nPlease open the code (index.html), scroll to the bottom, and paste your Web App URL into the GOOGLE_SCRIPT_URL variable.");
                         return;
                     }

                     // 2. Check if URL is the Editor link (Common Mistake)
                     if (GOOGLE_SCRIPT_URL.includes("/edit")) {
                         alert("Configuration Error: You pasted the Script Editor URL (.../edit).\n\nThe website needs the Deployment URL.\n\n1. Go to your Script\n2. Click 'Deploy' > 'New Deployment'\n3. Set 'Who has access' to 'Anyone'\n4. Copy the 'Web app' URL (ends in /exec)");
                         return;
                     }

                     const username = document.getElementById('edit-username-hidden').value;
                     const role = document.getElementById('edit-role').value;
                     const message = document.getElementById('edit-message').value;
                     const startDate = document.getElementById('edit-start-date').value;
                     const expirationDate = document.getElementById('edit-expiration-date').value;

                     // Show Loader
                     if(adminLoader) adminLoader.classList.remove('hidden');
                     window.closeEditModal();

                     try {
                         const response = await fetch(GOOGLE_SCRIPT_URL, {
                             method: 'POST',
                             mode: 'no-cors', // Important for Google Apps Script Web App without CORS header complexity
                             headers: {
                                 'Content-Type': 'application/json',
                             },
                             body: JSON.stringify({
                                 action: 'updateUser',
                                 username: username,
                                 role: role,
                                 message: message,
                                 startDate: startDate,         // Send Start Date
                                 expirationDate: expirationDate // Send Expiration Date
                             })
                         });

                         // Since 'no-cors' returns opaque response, we simulate success after a delay
                     setTimeout(async () => {
                         const users = await fetchUsers(); // Refresh data from sheet
                         
                         // Update Global Counters/Badges regardless of tab
                         if(window.updateAdminStats) window.updateAdminStats(users);
                         if(window.checkPaymentNotifications) window.checkPaymentNotifications();

                         // Smart Refresh based on Active Tab
                         if (currentAdminTab === 'payments') {
                             if(window.loadAdminPayments) window.loadAdminPayments();
                         } else if (currentAdminTab === 'dashboard') {
                             // Maintain current filter or search state
                             const searchVal = document.getElementById('admin-search')?.value || '';
                             if (searchVal) {
                                 if(window.renderAdminUserList) window.renderAdminUserList(users, searchVal);
                             } else {
                                 // Re-apply the active filter (e.g., 'pending')
                                 if(window.filterAdminUsers) window.filterAdminUsers(currentAdminFilterType);
                             }
                         } else if (currentAdminTab === 'content') {
                             // No user data specific refresh needed for content usually, but good practice
                             // loadAdminTools(); 
                         }

                         if(adminLoader) adminLoader.classList.add('hidden');
                         alert(`Successfully updated user: ${username}`);
                     }, 2000);

                     } catch(err) {
                         console.error(err);
                         if(adminLoader) adminLoader.classList.add('hidden');
                         alert("Failed to connect to the server. Check your internet connection.");
                     }
                 });
             }

             // COMMUNICATION TAB LOGIC
             function loadAdminComm() {
                 const container = document.getElementById('admin-global-preview');
                 const titleInput = document.getElementById('ann-input-title');
                 const msgInput = document.getElementById('ann-input-message');
                 const radios = document.getElementsByName('ann-style');

                 if(!container) return;

                 if (globalNotification) {
                     // Populate inputs only if they are empty (initial load)
                     if(titleInput && titleInput.value === '') {
                         titleInput.value = globalNotification.title;
                     }
                     if(msgInput && msgInput.value === '') {
                         // Convert <br> tags back to newlines for easy editing in textarea
                         const rawMsg = globalNotification.message.replace(/<br\s*\/?>/gi, '\n');
                         msgInput.value = rawMsg;
                     }
                     
                     // Set Radio based on Title Content
                     const lowerTitle = globalNotification.title.toLowerCase();
                     if (lowerTitle.includes('urgent') || lowerTitle.includes('alert')) {
                         setRadio('urgent');
                     } else if (lowerTitle.includes('maintenance') || lowerTitle.includes('warning')) {
                         setRadio('maintenance');
                     } else if (lowerTitle.includes('new') || lowerTitle.includes('update')) {
                         setRadio('update');
                     } else {
                         setRadio('standard');
                     }
                 }
                 
                 // Trigger preview render
                 updateAnnouncementPreview();
             }

             function setRadio(value) {
                 const radios = document.getElementsByName('ann-style');
                 for(const r of radios) {
                     if(r.value === value) r.checked = true;
                 }
             }

             // NEW: Live Preview Updater (Triggered by input/radio)
             window.updateAnnouncementPreview = function() {
                 const container = document.getElementById('admin-global-preview');
                 const titleVal = document.getElementById('ann-input-title').value || "System Update";
                 let msgVal = document.getElementById('ann-input-message').value || "Announcement details will appear here.";
                 
                 // Convert newlines to <br> for preview display
                 msgVal = msgVal.replace(/\n/g, '<br>');

                 // Get Selected Style
                 let selectedStyle = 'standard';
                 const radios = document.getElementsByName('ann-style');
                 for(const r of radios) { if(r.checked) selectedStyle = r.value; }

                 let iconClass = "fa-bullhorn text-blue-500";
                 let borderClass = "border-l-4 border-l-blue-500";
                 
                 if (selectedStyle === 'urgent') {
                     iconClass = "fa-triangle-exclamation text-red-500";
                     borderClass = "border-l-4 border-l-red-500";
                 } else if (selectedStyle === 'maintenance') {
                     iconClass = "fa-screwdriver-wrench text-orange-500";
                     borderClass = "border-l-4 border-l-orange-500";
                 } else if (selectedStyle === 'update') {
                     iconClass = "fa-wand-magic-sparkles text-indigo-500";
                     borderClass = "border-l-4 border-l-indigo-500";
                 }

                 container.innerHTML = `
                    <div class="w-full text-left bg-white p-5 rounded-xl ${borderClass} shadow-lg ring-1 ring-slate-900/5 relative overflow-hidden transition-all duration-300">
                        <div class="absolute top-0 right-0 p-3 opacity-5">
                            <i class="fa-solid ${iconClass} text-6xl"></i>
                        </div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid ${iconClass} text-lg"></i>
                                <h4 class="font-bold text-slate-800 text-base leading-tight">${titleVal}</h4>
                            </div>
                            <div class="text-sm text-slate-600 leading-relaxed font-medium pt-3 border-t border-slate-100 break-words">
                                ${msgVal}
                            </div>
                        </div>
                    </div>
                 `;
             }

             // NEW: Save Announcement Function
             window.saveAnnouncement = async function(isPublish) {
                 const titleInput = document.getElementById('ann-input-title');
                 const msgInput = document.getElementById('ann-input-message');
                 const btnPub = document.getElementById('btn-ann-pub');
                 const btnClear = document.getElementById('btn-ann-clear');
                 const adminLoader = document.getElementById('admin-loader');

                 if (isPublish && (!titleInput.value.trim() || !msgInput.value.trim())) {
                     alert("Please enter both a Title and a Message.");
                     return;
                 }

                 // Determine Style Keyword to prepend (ensures persistence)
                 let finalTitle = titleInput.value.trim();
                 let finalMsg = '';

                 if (isPublish) {
                     // 1. Process Title Keywords
                     let selectedStyle = 'standard';
                     const radios = document.getElementsByName('ann-style');
                     for(const r of radios) { if(r.checked) selectedStyle = r.value; }
                     
                     const lowerT = finalTitle.toLowerCase();
                     if (selectedStyle === 'urgent' && !lowerT.includes('urgent') && !lowerT.includes('alert')) {
                         finalTitle = "Urgent: " + finalTitle;
                     } else if (selectedStyle === 'maintenance' && !lowerT.includes('maintenance')) {
                         finalTitle = "Maintenance: " + finalTitle;
                     } else if (selectedStyle === 'update' && !lowerT.includes('new') && !lowerT.includes('update')) {
                         finalTitle = "New Update: " + finalTitle;
                     }

                     // 2. Process Message Breaks (Convert \n to <br>)
                     finalMsg = msgInput.value.trim().replace(/\n/g, '<br>');
                 }

                 // Disable UI
                 if(btnPub) {
                     btnPub.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...';
                     btnPub.disabled = true;
                 }
                 if(btnClear) btnClear.disabled = true;
                 if(adminLoader) adminLoader.classList.remove('hidden');

                 const payload = {
                     action: 'updateAnnouncement', // Ensure your GAS handles this action
                     title: isPublish ? finalTitle : '',
                     message: finalMsg
                 };

                 try {
                     // Optimistic UI Update (Update local state immediately)
                     if (isPublish) {
                         globalNotification = { title: payload.title, message: payload.message };
                     } else {
                         globalNotification = null;
                         titleInput.value = '';
                         msgInput.value = '';
                         setRadio('standard');
                     }
                     
                     // Manually update the title input to reflect the auto-keyword addition (optional but good for UX)
                     if (isPublish && titleInput.value !== finalTitle) {
                         titleInput.value = finalTitle;
                     }
                     
                     loadAdminComm(); // Refresh Logic & Preview

                     const response = await fetch(GOOGLE_SCRIPT_URL, {
                         method: 'POST',
                         mode: 'no-cors',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(payload)
                     });

                     // Simulate success delay since no-cors is opaque
                     setTimeout(() => {
                         if(adminLoader) adminLoader.classList.add('hidden');
                         if(btnPub) {
                             btnPub.innerHTML = '<i class="fa-solid fa-check"></i> Updated!';
                             setTimeout(() => {
                                 btnPub.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Push Live Update';
                                 btnPub.disabled = false;
                                 if(btnClear) btnClear.disabled = false;
                             }, 2000);
                         }
                         // Background fetch to ensure consistency
                         fetchSystemConfig();
                     }, 1500);

                 } catch (err) {
                     console.error(err);
                     if(adminLoader) adminLoader.classList.add('hidden');
                     alert("Failed to connect. Please check your internet.");
                     if(btnPub) {
                         btnPub.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Push Live Update';
                         btnPub.disabled = false;
                     }
                     if(btnClear) btnClear.disabled = false;
                 }
             };

             // CONTENT TAB LOGIC
             async function loadAdminTools() {
                 const basicList = document.getElementById('list-basic-tools');
                 const premList = document.getElementById('list-premium-tools');
                 if(!basicList || !premList) return;

                 // Show Loading
                 basicList.innerHTML = '<div class="p-4 text-center text-slate-400 text-xs"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Fetching...</div>';
                 premList.innerHTML = '<div class="p-4 text-center text-slate-400 text-xs"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Fetching...</div>';

                 const sheetId = '1p69v6YNSjn8n7IrW9h0Qk9get61eh-ONYNxaMz76RFA';
                 
                 // Fetch both sheets
                 const fetchSheet = async (name) => {
                     const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&headers=1&sheet=${encodeURIComponent(name)}`;
                     const res = await fetch(url);
                     const text = await res.text();
                     const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                     return jsonMatch ? JSON.parse(jsonMatch[1]).table.rows : [];
                 };

                 try {
                     const [basicData, premData] = await Promise.all([fetchSheet('Sheet1'), fetchSheet('PAID USERS')]);
                     
                     const renderList = (data, container, countId) => {
                         container.innerHTML = '';
                         let count = 0;
                         data.forEach(row => {
                             const name = row.c[0] ? row.c[0].v : null;
                             const link = row.c[1] ? row.c[1].v : '#';
                             if (name && name !== "Name of app" && name !== "Name") {
                                 count++;
                                 const item = document.createElement('div');
                                 item.className = 'flex items-center justify-between p-3 bg-white border border-slate-100 rounded-lg hover:border-blue-200 transition group';
                                 item.innerHTML = `
                                     <div class="flex items-center gap-3 overflow-hidden">
                                         <div class="w-8 h-8 rounded bg-slate-50 flex items-center justify-center text-slate-400 text-xs font-bold border border-slate-100 group-hover:text-blue-500 group-hover:bg-blue-50 transition">${name.charAt(0)}</div>
                                         <span class="text-xs font-bold text-slate-700 truncate">${name}</span>
                                     </div>
                                     <a href="${link}" target="_blank" class="text-slate-300 hover:text-blue-600 px-2"><i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a>
                                 `;
                                 container.appendChild(item);
                             }
                         });
                         document.getElementById(countId).innerText = count;
                         if(count === 0) container.innerHTML = '<div class="p-4 text-center text-slate-400 text-xs">No tools found.</div>';
                     };

                     renderList(basicData, basicList, 'count-basic');
                     renderList(premData, premList, 'count-premium');

                 } catch(err) {
                     console.error(err);
                     basicList.innerHTML = '<div class="p-4 text-center text-red-400 text-xs">Error loading data.</div>';
                     premList.innerHTML = '<div class="p-4 text-center text-red-400 text-xs">Error loading data.</div>';
                 }
             }
             
             document.getElementById('refresh-tools-btn')?.addEventListener('click', loadAdminTools);

             function closeAdminDashboard() {
                 if(!adminModal) return;
                 adminModal.classList.add('opacity-0');
                 if(adminModal.firstElementChild) {
                     adminModal.firstElementChild.classList.remove('scale-100');
                     adminModal.firstElementChild.classList.add('scale-95');
                 }
                 setTimeout(() => {
                     adminModal.classList.add('hidden');
                 }, 300);
             }

             if(adminLink) {
                 adminLink.addEventListener('click', (e) => {
                     e.preventDefault();
                     openAdminDashboard();
                 });
             }
             
             if(closeAdminBtn) closeAdminBtn.addEventListener('click', closeAdminDashboard);
             if(adminModal) adminModal.addEventListener('click', (e) => { if(e.target === adminModal) closeAdminDashboard(); });
             
             if(adminSearch) {
                 adminSearch.addEventListener('input', (e) => {
                     const users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
                     renderAdminUserList(users, e.target.value);
                 });
             }

             // ----------------------------------------

             function setupPasswordFeatures(inputId, toggleId, warningId) {
                 const input = document.getElementById(inputId);
                 const toggleBtn = document.getElementById(toggleId);
                 const warning = document.getElementById(warningId);

                 if (!input || !toggleBtn) return;

                 const showPassword = () => {
                     input.setAttribute('type', 'text');
                     const icon = toggleBtn.querySelector('i');
                     if(icon) {
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                     }
                 };

                 const hidePassword = () => {
                     input.setAttribute('type', 'password');
                     const icon = toggleBtn.querySelector('i');
                     if(icon) {
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                     }
                 };

                 toggleBtn.addEventListener('mousedown', (e) => {
                     e.preventDefault(); 
                     showPassword();
                 });
                 toggleBtn.addEventListener('mouseup', hidePassword);
                 toggleBtn.addEventListener('mouseleave', hidePassword);

                 toggleBtn.addEventListener('touchstart', (e) => {
                     e.preventDefault(); 
                     showPassword();
                 });
                 toggleBtn.addEventListener('touchend', hidePassword);
                 toggleBtn.addEventListener('touchcancel', hidePassword);

                 if(warning) {
                     const checkCapsLock = (e) => {
                         if (e.getModifierState && e.getModifierState('CapsLock')) {
                             warning.classList.remove('hidden');
                         } else {
                             warning.classList.add('hidden');
                         }
                     };

                     input.addEventListener('keyup', checkCapsLock);
                     input.addEventListener('keydown', checkCapsLock);
                     input.addEventListener('click', checkCapsLock);
                     input.addEventListener('focus', checkCapsLock);
                     input.addEventListener('blur', () => warning.classList.add('hidden'));
                 }
             }

             setupPasswordFeatures('login-password', 'toggle-login-password', 'login-caps-warning');
             setupPasswordFeatures('reg-password', 'toggle-reg-password', 'reg-caps-warning');
             setupPasswordFeatures('reg-confirm-password', 'toggle-reg-confirm-password', 'reg-caps-warning');

             function setupPasswordValidation(passId, confirmId, matchWarningId, lengthIndicatorId) {
                 const passInput = document.getElementById(passId);
                 const confirmInput = document.getElementById(confirmId);
                 const matchWarning = document.getElementById(matchWarningId);
                 const lengthIndicator = document.getElementById(lengthIndicatorId);

                 if(!passInput) return;

                 const checkValidation = () => {
                     const val1 = passInput.value;
                     const val2 = confirmInput ? confirmInput.value : '';

                     if (lengthIndicator) {
                         if (val1.length > 0 && val1.length < 8) {
                             lengthIndicator.classList.remove('text-slate-400', 'text-green-600');
                             lengthIndicator.classList.add('text-red-500');
                             lengthIndicator.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> Too short (min. 8)';
                         } else if (val1.length >= 8) {
                             lengthIndicator.classList.remove('text-slate-400', 'text-red-500');
                             lengthIndicator.classList.add('text-green-600');
                             lengthIndicator.innerHTML = '<i class="fa-solid fa-circle-check"></i> Good length';
                         } else {
                             lengthIndicator.classList.remove('text-red-500', 'text-green-600');
                             lengthIndicator.classList.add('text-slate-400');
                             lengthIndicator.innerHTML = '<i class="fa-solid fa-circle-info"></i> Min. 8 characters';
                         }
                     }

                     if(confirmInput && matchWarning) {
                         if (val2 && val1 !== val2) {
                             matchWarning.classList.remove('hidden');
                             confirmInput.classList.add('border-red-500', 'text-red-600', 'focus:border-red-500', 'focus:ring-red-200');
                             confirmInput.classList.remove('border-slate-200', 'focus:border-deped-blue', 'focus:ring-deped-blue');
                         } else {
                             matchWarning.classList.add('hidden');
                             confirmInput.classList.remove('border-red-500', 'text-red-600', 'focus:border-red-500', 'focus:ring-red-200');
                             confirmInput.classList.add('border-slate-200', 'focus:border-deped-blue', 'focus:ring-deped-blue');
                         }
                     }
                 };

                 passInput.addEventListener('input', checkValidation);
                 if(confirmInput) confirmInput.addEventListener('input', checkValidation);
             }

             setupPasswordValidation('reg-password', 'reg-confirm-password', 'pass-match-warning', 'pass-length-indicator');

             const regForm = document.getElementById('registrationForm');
             const regSuccess = document.getElementById('reg-success');
             const regReset = document.getElementById('reg-reset-btn');
             const regBtn = document.getElementById('reg-submit-btn');
             const regError = document.getElementById('reg-error');
             const regErrorMsg = document.getElementById('reg-error-msg');

             if(regForm && regSuccess && regBtn) {
                 regForm.addEventListener('submit', async (e) => {
                     e.preventDefault(); 
                     
                     if(regError) regError.classList.add('hidden');

                     const usernameInput = regForm.querySelector('input[name="entry.1514621509"]');
                     const username = usernameInput ? usernameInput.value.trim() : '';
                     
                     // NEW: Prevent spaces in username
                     if (/\s/.test(username)) {
                         if(regError && regErrorMsg) {
                             regErrorMsg.innerText = "Username cannot contain spaces.";
                             regError.classList.remove('hidden');
                         }
                         regForm.classList.add('animate-shake');
                         setTimeout(() => regForm.classList.remove('animate-shake'), 500);
                         return;
                     }

                     const passVal = document.getElementById('reg-password').value;
                     const confirmVal = document.getElementById('reg-confirm-password').value;

                     if (passVal.length < 8) {
                         if(regError && regErrorMsg) {
                             regErrorMsg.innerText = "Password must be at least 8 characters.";
                             regError.classList.remove('hidden');
                         }
                         regForm.classList.add('animate-shake');
                         setTimeout(() => regForm.classList.remove('animate-shake'), 500);
                         return;
                     }

                     if (passVal !== confirmVal) {
                         if(regError && regErrorMsg) {
                             regErrorMsg.innerText = "Passwords do not match.";
                             regError.classList.remove('hidden');
                         }
                         regForm.classList.add('animate-shake');
                         setTimeout(() => regForm.classList.remove('animate-shake'), 500);
                         return;
                     }

                     if(!username) return;

                     const restrictedKeywords = ['admin', 'administrator', 'root', 'system', 'support', 'superuser'];
                     const lowerUser = username.toLowerCase();
                     const foundRestricted = restrictedKeywords.find(keyword => lowerUser.includes(keyword));

                     if (foundRestricted) {
                         if(regError && regErrorMsg) {
                             regErrorMsg.innerText = `Username cannot contain reserved word: '${foundRestricted}'`;
                             regError.classList.remove('hidden');
                         }
                         
                         regForm.classList.add('animate-shake');
                         setTimeout(() => regForm.classList.remove('animate-shake'), 500);
                         
                         if(usernameInput) usernameInput.focus();
                         return;
                     }

                     regBtn.disabled = true;
                     const originalText = regBtn.innerHTML;
                     regBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Verifying...';
                     regBtn.classList.add('opacity-75', 'cursor-wait');

                     let users = [];
                     
                     // ADDED: Safety Timeout for Registration Check (Prevents infinite loading)
                     const fetchPromise = fetchUsers();
                     const timeoutPromise = new Promise((resolve) => setTimeout(() => resolve('TIMEOUT'), 5000));
                     
                     try {
                         const result = await Promise.race([fetchPromise, timeoutPromise]);
                         if (result === 'TIMEOUT') {
                             console.warn("User fetch timed out. Proceeding with registration to unblock user.");
                             users = []; // Fail open so user can register
                         } else {
                             users = result;
                         }
                     } catch(err) {
                         users = JSON.parse(localStorage.getItem(CACHE_CONFIG.USERS.KEY) || '[]');
                     }

                     const exists = users.some(u => u.username.toLowerCase() === username.toLowerCase());

                     if (exists) {
                         if(regError && regErrorMsg) {
                             regErrorMsg.innerText = `The username '${username}' is already taken.`;
                             regError.classList.remove('hidden');
                         }
                         
                         regBtn.innerHTML = originalText;
                         regBtn.disabled = false;
                         regBtn.classList.remove('opacity-75', 'cursor-wait');
                         
                         regForm.classList.add('animate-shake');
                         setTimeout(() => regForm.classList.remove('animate-shake'), 500);
                         
                         if(usernameInput) usernameInput.focus();
                         return;
                     }

                     regBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Registering...';
                     
                     regForm.submit();

                     setTimeout(() => {
                         if(regContent) regContent.classList.add('hidden');
                         
                         regSuccess.classList.remove('hidden');
                         regSuccess.classList.add('flex'); 
                         
                         regBtn.innerHTML = originalText;
                         regBtn.disabled = false;
                         regBtn.classList.remove('opacity-75', 'cursor-wait');
                         
                         regForm.reset();
                     }, 1500); 
                 });

                 if(regReset) {
                     regReset.addEventListener('click', () => {
                         closeRegModal();
                     });
                 }
             }

        }); // Close DOMContentLoaded
    </script>
</body>
</html>
